<!DOCTYPE html>
<html lang="it">
<head><script type="text/javascript" src="/___vscode_livepreview_injected_script"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koda AI - Soluzioni Intelligenti per il Futuro</title>
    <meta name="description" id="meta-desc" content="Ogni tua">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, sendPasswordResetEmail, updateEmail, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where, orderBy, serverTimestamp, getDoc, setDoc, getDocs } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDLouTZcRN28riyxBY06XYkWCsGkYbYm-o",
            authDomain: "n8n-riccardo-29-aprile.firebaseapp.com",
            projectId: "n8n-riccardo-29-aprile",
            storageBucket: "n8n-riccardo-29-aprile.firebasestorage.app",
            messagingSenderId: "785683001992",
            appId: "1:785683001992:web:d24e375041fb7c0f18653d",
            measurementId: "G-B78J4HK2NX"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // Make Firebase services globally available
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseServices = {
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile,
            sendPasswordResetEmail,
            updateEmail,
            updatePassword,
            reauthenticateWithCredential,
            EmailAuthProvider,
            collection,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            onSnapshot,
            query,
            where,
            orderBy,
            serverTimestamp,
            getDoc,
            setDoc,
            getDocs
        };

        console.log('🔥 Firebase initialized successfully!');
    </script>
    
    <!-- SCRIPT AGGIUNTI PER REACT E BABEL (Ottimizzati) -->
    <link rel="preload" href="https://esm.sh/react@^19.1.0" as="script">
    <link rel="preload" href="https://esm.sh/react-dom@^19.1.0/client" as="script">
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@^19.1.0",
        "react-dom/client": "https://esm.sh/react-dom@^19.1.0/client",
        "@google/genai": "https://esm.sh/@google/genai@^1.6.0"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
    
    <style>
        /* Nascondi il contenuto finché non è pronto */
        #main-content-wrapper:empty {
            display: none;
        }
        
        /* Stili CSS ottimizzati per performance */
        @keyframes fluidMove { 0% { transform: scale(1) rotate(0deg) translateX(0) translateY(0); } 50% { transform: scale(1.05) rotate(0deg) translateX(5px) translateY(-3px); } 100% { transform: scale(1) rotate(0deg) translateX(0) translateY(0); } }
        @keyframes fluidPulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 0.8; } }
        @keyframes fluidWave { 0% { transform: translateX(0) translateY(0) scale(1); } 50% { transform: translateX(10px) translateY(-5px) scale(1.01); } 100% { transform: translateX(0) translateY(0) scale(1); } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        @keyframes floatingGlow { 0%, 100% { transform: translateY(0px) scale(1); opacity: 0.3; } 50% { transform: translateY(-10px) scale(1.05); opacity: 0.5; } }
        @keyframes scrollRight { 0% { transform: translateX(0%); } 100% { transform: translateX(-100%); } }
        .fluid-animated { animation: fluidMove 30s ease-in-out infinite; }
        .fluid-wave { animation: fluidWave 20s ease-in-out infinite; }
        .shimmer-effect { background: linear-gradient( 90deg, transparent, rgba(34, 197, 94, 0.1), transparent ); background-size: 200% 100%; animation: shimmer 4s ease-in-out infinite; }
        .floating-glow { animation: floatingGlow 8s ease-in-out infinite; }
        .animate-scroll-right { animation: scrollRight 90s linear infinite; }
        .parallax-slow { transform: translateZ(0); will-change: transform; }
        /* Ottimizzazione transizioni - solo per elementi essenziali */
        .chat-menu-btn, .section-nav-btn, .library-card, .search-ai-btn { transition: all 0.2s ease; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #22c55e; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #16a34a; }
        .animated-bg-image { background-image: url('https://i.postimg.cc/VknnJpRs/Immagine-Whats-App-2025-07-05-ore-18-31-01-44a1c1fe.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; width: 100%; height: 100%; }
        .animated-bg-layer { background-image: url('https://i.postimg.cc/VknnJpRs/Immagine-Whats-App-2025-07-05-ore-18-31-01-44a1c1fe.jpg'); background-size: 120% 120%; background-position: center; background-repeat: no-repeat; width: 100%; height: 100%; }

        /* --- INIZIO: Stili per Chat, Menu e Modale (da app.mobile.html) --- */
        :root {
            --spotify-bg: #121212;
            --spotify-bg-light: #181818;
            --spotify-card: #282828;
            --spotify-text: #ffffff;
            --spotify-text-secondary: #b3b3b3;
            --spotify-accent: #1db954;
            --font-family-spotify: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        
        #chat-view-container {
            font-family: var(--font-family-spotify);
            color: var(--spotify-text);
        }

        #chatbot-react-wrapper #chatbot-app-container {
            background-color: transparent;
        }
        #chatbot-react-wrapper #chatbot-app-container .chat-header {
             background: linear-gradient(to bottom, rgba(0,0,0,0.6) 30%, transparent);
        }

        #chatbot-app-container { display: flex; flex-direction: column; height: 100%; flex-grow: 1; }
        .chat-header { padding: 16px; display: flex; align-items: center; width: 100%; z-index: 2; position: sticky; top: 0; }
        .chat-header-btn { background: none; border: none; color: var(--spotify-text-secondary); font-size: 24px; cursor: pointer; padding: 8px; }
        /* NUOVO: Stile per il pulsante Torna Indietro */
        .back-home-btn {
            background-color: var(--spotify-card) !important;
            color: var(--spotify-text) !important;
            font-size: 14px !important;
            font-weight: 500;
            padding: 6px 12px !important;
            border-radius: 20px;
            display: flex !important;
            align-items: center;
            gap: 6px;
            transition: background-color 0.2s;
        }
        .back-home-btn:hover {
            background-color: var(--spotify-bg-light) !important;
        }
        #chatbot-app-container main { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; }
        #welcome-screen {
            position: relative; overflow: hidden; flex-grow: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center; gap: 24px; padding: 20px; padding-bottom: 15%; background: none;
        }
        .welcome-logo { font-size: 2.5rem; font-weight: 700; text-align: center; margin-bottom: 16px; }
        .welcome-logo svg { width: 50px; height: 50px; }
        .prompt-starter-container { display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%; max-width: 400px; }
        .prompt-starter-btn { background-color: var(--spotify-card); color: var(--spotify-text); border: 1px solid rgba(128,128,128,0.2); border-radius: 8px; padding: 12px 16px; font-size: 14px; font-weight: 500; cursor: pointer; width: 100%; text-align: left; transition: background-color 0.2s; }
        .prompt-starter-btn:hover { background-color: var(--spotify-bg-light); }
        #chat-messages { width: 100%; display: flex; flex-direction: column; gap: 12px; }
        .chat-bubble { padding: 12px 16px; border-radius: 20px; max-width: 85%; line-height: 1.5; word-wrap: break-word; }
        .chat-bubble.ai { background-color: var(--spotify-card); align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-bubble.user { background-color: var(--spotify-accent); color: #000; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-bubble.system { background-color: transparent; color: var(--spotify-text-secondary); align-self: center; text-align: center; font-style: normal; font-size: 14px; width: 100%; max-width: 100%; padding: 0 16px 8px; }
        .chat-bubble.error { background-color: #8c1a1a; color: var(--spotify-text); align-self: flex-start; border-bottom-left-radius: 4px; }
        .chat-bubble.loading { align-self: flex-start; background-color: var(--spotify-card); padding: 14px 16px; }
        .chat-bubble.loading span { display: inline-block; background-color: var(--spotify-text-secondary); width: 8px; height: 8px; border-radius: 50%; margin: 0 1px; animation: bounce 1.4s infinite ease-in-out both; }
        .chat-bubble.loading span:nth-of-type(1) { animation-delay: -0.32s; }
        .chat-bubble.loading span:nth-of-type(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .chat-bubble.ai p { margin: 8px 0; }
        .chat-bubble.ai p:first-child { margin-top: 0; }
        .chat-bubble.ai p:last-child { margin-bottom: 0; }
        .chat-tool-card-container { display: flex; flex-direction: column; gap: 10px; align-self: flex-start; width: 100%; max-width: 400px; }
        .chat-tool-card { display: flex; gap: 12px; background-color: var(--spotify-card); border-radius: 12px; padding: 12px; border: 1px solid rgba(128,128,128,0.1); }
        .chat-tool-card .logo-container { width: 48px; height: 48px; flex-shrink: 0; border-radius: 8px; overflow: hidden; }
        .chat-tool-card .tool-logo { width: 100%; height: 100%; object-fit: cover; }
        .chat-tool-card .info { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
        .chat-tool-card .tool-name { font-weight: 600; font-size: 15px; }
        .chat-tool-card .tool-desc { font-size: 13px; color: var(--spotify-text-secondary); margin: 2px 0 8px; line-height: 1.4; }
        .chat-tool-card .details-btn { background: var(--spotify-bg-light); color: var(--spotify-text); border: none; padding: 6px 12px; font-size: 12px; border-radius: 20px; cursor: pointer; align-self: flex-start; }
        #chat-input-container {
            width: 100%;
            background: none;
            border: none;
            border-radius: 0;
            margin: 0;
            padding: 32px 0 24px 0;
            display: flex;
            justify-content: center;
            align-items: flex-end;
        }
        #chat-input {
            width: 100%;
            max-width: 600px;
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(6px);
            border: 1.5px solid rgba(255,255,255,0.18);
            color: #fff;
            border-radius: 9999px;
            padding: 18px 24px 18px 24px;
            font-size: 1.15rem;
            font-family: inherit;
            outline: none;
            transition: border 0.2s;
            margin-right: 0;
            box-sizing: border-box;
        }
        #chat-input:focus {
            border: 1.5px solid #22c55e;
        }
        #chat-input::placeholder {
            color: #cbd5e1;
            opacity: 1;
        }
        #chat-send-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #22c55e;
            color: #000;
            border: none;
            border-radius: 9999px;
            width: 56px;
            height: 56px;
            font-size: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(34,197,94,0.15);
            cursor: pointer;
            z-index: 2;
            transition: background 0.2s, transform 0.2s;
        }
        #chat-send-btn:disabled {
            background: #1a1a1a;
            color: #888;
            cursor: not-allowed;
        }
        #chat-send-btn:not(:disabled):hover {
            background: #16a34a;
            color: #fff;
            transform: scale(1.08);
        }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--spotify-card); padding: 24px; border-radius: 16px; width: 90%; max-width: 500px; text-align: center; position: relative; }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--spotify-text-secondary); font-size: 28px; cursor: pointer; }
        .modal-content .button { background-color: var(--spotify-accent); color: #000; border: none; padding: 15px 30px; border-radius: 50px; font-size: 16px; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        #detail-content h2 { font-size: 24px; margin-bottom: 8px; }
        #detail-content p { color: var(--spotify-text-secondary); margin-bottom: 24px; line-height: 1.5; }
        #detail-content .detail-tags { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 24px; }
        #detail-content .tag { background-color: var(--spotify-bg-light); padding: 6px 12px; border-radius: 20px; font-size: 12px; }
        #detail-content .detail-actions { display: flex; flex-direction: column; gap: 12px; }
        .recommendation-box { margin-top: 24px; background-color: var(--spotify-bg-light); padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 12px; cursor: pointer; border: 1px solid rgba(128,128,128,0.2); transition: background-color 0.2s; }
        .recommendation-box:hover { background-color: var(--spotify-card); }
        .recommendation-logo { width: 40px; height: 40px; border-radius: 4px; object-fit: cover; flex-shrink: 0; }
        .recommendation-text { font-size: 14px; color: var(--spotify-text-secondary); text-align: left; }
        .recommendation-text strong { color: var(--spotify-text); display: block; }
        
        /* NUOVI STILI PER IL MENU LATERALE */
        #side-menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1500; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        #side-menu-overlay.visible { opacity: 1; visibility: visible; }
        #side-menu { position: fixed; top: 0; left: 0; width: 80%; max-width: 320px; height: 100%; background-color: var(--spotify-bg-light); z-index: 1501; transform: translateX(-100%); transition: transform 0.3s ease-out; display: flex; flex-direction: column; padding: 16px; }
        #side-menu.visible { transform: translateX(0); }
        .menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 1px solid var(--spotify-card); }
        .menu-header h3 { font-size: 18px; }
        .new-chat-btn { background-color: var(--spotify-card); color: var(--spotify-text); border: none; border-radius: 8px; padding: 10px 14px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        .conversation-list { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .conversation-list::-webkit-scrollbar { display: none; }
        .conversation-item { background: none; border: none; color: var(--spotify-text-secondary); text-align: left; padding: 12px; border-radius: 8px; font-size: 14px; cursor: pointer; transition: background-color 0.2s, color 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .conversation-item.active, .conversation-item:hover { background-color: var(--spotify-card); color: var(--spotify-text); }
        .menu-footer { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--spotify-card); }
        #delete-all-btn { width: 100%; background: none; border: 1px solid var(--spotify-text-secondary); color: var(--spotify-text-secondary); padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        #delete-all-btn:hover { background-color: var(--spotify-card); color: var(--spotify-text); border-color: var(--spotify-card); }
        /* --- FINE: Stili per Chat, Menu e Modale --- */

        #chatbot-react-wrapper {
            position: relative;
            z-index: 30;
            background: rgba(20,20,20,0.85);
            width: 100vw;
            height: 100vh;
            min-height: 100vh;
            max-width: 100vw;
            border-radius: 0;
            margin: 0;
            box-shadow: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        #chat-view-container {
            position: relative;
            z-index: 10;
            width: 100vw;
            height: 100vh;
            min-height: 100vh;
            overflow: hidden;
        }
        @media (max-width: 600px) {
            #chatbot-react-wrapper {
                max-width: 100vw;
                min-height: 90vh;
                margin: 0;
                border-radius: 0;
                padding: 0;
            }
        }
        .animated-bg-fixed {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
            pointer-events: none;
        }

        /* NUOVI STILI PER LE SEZIONI TOP AI, RICERCA AI, LIBRERIA */
        .section-nav { display: flex; justify-content: center; gap: 20px; margin: 40px 0; }
        .section-nav-btn { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 12px 24px; border-radius: 25px; cursor: pointer; transition: all 0.3s; font-weight: 500; }
        .section-nav-btn:hover, .section-nav-btn.active { background: #22c55e; color: black; border-color: #22c55e; transform: translateY(-2px); }
        
        .search-ai-section { display: none; }
        .search-ai-section.active { display: block; }
        
        /* NUOVO: Stile per il pulsante "Mi Piace" */
        .like-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, color 0.2s;
        }
        .like-btn:hover {
            transform: scale(1.1);
        }
        .like-btn .lucide-heart {
            color: #fff;
            transition: fill 0.2s, color 0.2s;
        }
        .like-btn[data-liked="true"] .lucide-heart {
            fill: #ef4444;
            color: #ef4444;
        }
        
        .search-ai-container { max-width: 800px; margin: 40px auto; }
        .search-result-card { position: relative; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 24px; transition: all 0.3s; cursor: pointer; }
        .search-result-card:hover { transform: translateY(-8px); background: rgba(255,255,255,0.08); border-color: #22c55e; }
        .search-ai-form { display: flex; gap: 16px; margin-bottom: 40px; }
        .search-ai-input { flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 16px; color: white; font-size: 16px; }
        .search-ai-input:focus { outline: none; border-color: #22c55e; }
        .search-ai-btn { background: #22c55e; color: black; border: none; border-radius: 12px; padding: 16px 32px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .search-ai-btn:hover { background: #16a34a; transform: translateY(-2px); }
        
        /* RESPONSIVE STYLES FOR MOBILE */
        @media (max-width: 768px) {
            #sections-container {
                padding: 20px 0;
                overflow-x: hidden;
            }
            
            #sections-container .max-w-7xl {
                padding: 0 16px;
            }
            
            .section-nav {
                flex-direction: column;
                gap: 12px;
                margin: 20px 0;
                padding: 0 16px;
            }
            
            .section-nav-btn {
                padding: 10px 16px;
                font-size: 14px;
                width: 100%;
                text-align: center;
            }
            
            .search-ai-container {
                max-width: 100%;
                margin: 20px auto;
                padding: 0 16px;
            }
            
            .search-ai-form {
                flex-direction: column;
                gap: 12px;
                margin-bottom: 20px;
            }
            
            .search-ai-input {
                padding: 14px 16px;
                font-size: 16px;
            }
            
            .search-ai-btn {
                padding: 14px 24px;
                font-size: 16px;
                width: 100%;
            }
            
            .search-result-card {
                padding: 16px;
                margin-bottom: 16px;
            }
            
            .library-grid {
                grid-template-columns: 1fr;
                gap: 16px;
                padding: 0 16px;
            }
            
            .library-card {
                padding: 16px;
            }
            
            /* Responsive for AI suggestions form */
            .ai-suggestions-section .grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .ai-suggestions-section .space-y-6 > div {
                margin-bottom: 16px;
            }
            
            /* Stili CSS per la ricerca utenti rimossi */
        }
        
        @media (max-width: 480px) {
            .section-nav {
                gap: 8px;
                margin: 16px 0;
                padding: 0 12px;
            }
            
            .section-nav-btn {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .search-ai-container {
                padding: 0 12px;
                margin: 16px auto;
            }
            
            .search-ai-form {
                gap: 8px;
                margin-bottom: 16px;
            }
            
            .search-ai-input {
                padding: 12px 14px;
                font-size: 16px;
            }
            
            .search-ai-btn {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .search-result-card {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .library-grid {
                padding: 0 12px;
                gap: 12px;
            }
            
            .library-card {
                padding: 12px;
            }
            
            /* Responsive for AI suggestions form */
            .ai-suggestions-section .bg-gray-800\/50 {
                padding: 16px;
                margin: 0 12px 16px 12px;
            }
            
            /* Stili CSS responsive per la ricerca utenti rimossi */
        }
        
        /* Stili per i filtri categoria */
        .category-filters {
            margin-bottom: 2rem;
        }
        .category-filter-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }
        .category-filter-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        .category-filter-btn.active {
            background: #22c55e;
            color: black;
            border-color: #22c55e;
            transform: translateY(-1px);
        }
        
        /* Stili per il menu a tendina dei filtri */
        .filters-dropdown-container {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .filters-dropdown {
            position: relative;
            display: inline-block;
        }
        .filters-dropdown-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }
        .filters-dropdown-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        .filters-dropdown-btn.active {
            background: #22c55e;
            color: black;
            border-color: #22c55e;
        }
        .dropdown-arrow {
            transition: transform 0.3s;
        }
        .filters-dropdown-btn.active .dropdown-arrow {
            transform: rotate(180deg);
        }
        .filters-dropdown-content {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(20,20,20,0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            padding: 20px;
            margin-top: 8px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            min-width: 280px;
        }
        .filters-dropdown-content.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .filter-section {
            margin-bottom: 20px;
        }
        .filter-section:last-of-type {
            margin-bottom: 0;
        }
        .filter-section-title {
            color: white;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .filter-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 6px 0;
            color: rgba(255,255,255,0.8);
            transition: color 0.2s;
        }
        .filter-option:hover {
            color: white;
        }
        .filter-option input[type="radio"] {
            accent-color: #22c55e;
            width: 16px;
            height: 16px;
        }
        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .filter-apply-btn, .filter-reset-btn {
            flex: 1;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .filter-apply-btn {
            background: #22c55e;
            color: black;
        }
        .filter-apply-btn:hover {
            background: #16a34a;
        }
        .filter-reset-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .filter-reset-btn:hover {
            background: rgba(255,255,255,0.15);
        }
        
        .library-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 40px; }
        .library-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center; transition: all 0.3s; cursor: pointer; }
        .library-card:hover { transform: translateY(-4px); background: rgba(255,255,255,0.08); border-color: #22c55e; }
        .library-card img { width: 60px; height: 60px; border-radius: 12px; margin-bottom: 16px; object-fit: cover; }
        .library-card h4 { color: white; margin-bottom: 8px; }
        .library-card p { color: #cbd5e1; font-size: 14px; }

        /* STILI PER I MENU NELLA CHAT */
        .chat-menu { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .chat-menu-left, .chat-menu-right { display: flex; align-items: center; gap: 16px; }
        .chat-menu-btn { background: none; border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.3s; font-size: 14px; }
        .chat-menu-btn:hover { background: rgba(255,255,255,0.1); border-color: #22c55e; }
        .chat-menu-btn.active { background: #22c55e; color: black; border-color: #22c55e; }
        
        /* Stili per il pulsante Home nell'header */
        .back-home-btn {
            display: flex !important;
            align-items: center;
            gap: 6px;
            background: rgba(34, 197, 94, 0.1) !important;
            border-color: rgba(34, 197, 94, 0.3) !important;
            color: #22c55e !important;
            transition: all 0.3s !important;
        }
        
        .back-home-btn:hover {
            background: rgba(34, 197, 94, 0.2) !important;
            border-color: rgba(34, 197, 94, 0.5) !important;
            transform: translateY(-1px);
        }
        
        /* Stili per il pulsante Home nel menu */
        .back-home-menu-btn:hover {
            background: rgba(34, 197, 94, 0.3) !important;
            border-color: rgba(34, 197, 94, 0.7) !important;
            transform: translateY(-1px);
        }
        
        /* RESPONSIVE STYLES FOR CHAT MENU */
        @media (max-width: 768px) {
            .chat-menu {
                flex-direction: column;
                gap: 12px;
                padding: 12px 16px;
            }
            
            .chat-menu-left {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
                width: 100%;
            }
            
            .chat-menu-btn {
                padding: 6px 12px;
                font-size: 12px;
                min-width: 80px;
                text-align: center;
            }
            
            .chat-menu-btn svg {
                margin-right: 4px !important;
            }
        }
        
        @media (max-width: 480px) {
            .chat-menu {
                padding: 8px 12px;
                gap: 8px;
            }
            
            .chat-menu-left {
                gap: 6px;
            }
            
            .chat-menu-btn {
                padding: 5px 8px;
                font-size: 11px;
                min-width: 70px;
            }
        }
        
        /* RESPONSIVE STYLES FOR CHAT SECTIONS */
        @media (max-width: 768px) {
            /* Responsive per le sezioni della chat */
            .search-section,
            .library-section,
            .suggestions-section,
            .user-search-section {
                padding: 12px !important;
            }
            
            .search-section h2,
            .library-section h2,
            .suggestions-section h2,
            .user-search-section h2 {
                font-size: 1.5rem !important;
            }
            
            .search-section p,
            .library-section p,
            .suggestions-section p,
            .user-search-section p {
                font-size: 0.875rem !important;
            }
            
            /* Responsive per SearchAISection */
            .search-section .search-dropdown-container {
                width: 100%;
            }
            
            .search-section .search-dropdown-container button {
                width: 100%;
                justify-content: center;
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .search-section .search-dropdown-container .absolute {
                left: 0;
                right: 0;
                min-width: auto;
                margin: 8px 0 0 0;
            }
            
            .search-section .search-dropdown-container .flex {
                flex-direction: column;
                gap: 8px;
            }
            
            .search-section .search-dropdown-container input {
                padding: 12px 14px;
                font-size: 16px;
            }
            
            .search-section .search-dropdown-container button[type="submit"] {
                padding: 12px 20px;
                font-size: 14px;
                width: 100%;
            }
            
            /* Responsive per LibrarySection */
            .library-section .grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .library-section .bg-gray-800\/50 {
                padding: 12px;
            }
            
            .library-section .flex {
                flex-direction: column;
                gap: 12px;
            }
            
            .library-section .w-12 {
                width: 48px;
                height: 48px;
            }
            
            /* Responsive per SuggestionsSection */
            .suggestions-section .space-y-4 > div {
                padding: 12px;
            }
            
            .suggestions-section .flex {
                flex-direction: column;
                gap: 8px;
            }
            
            .suggestions-section .flex-wrap {
                flex-direction: column;
                gap: 4px;
            }
            
            /* Stili CSS responsive per UserSearchSection rimossi */
        }
            
            .search-dropdown-container button {
                width: 100%;
                justify-content: center;
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .search-dropdown-container .absolute {
                left: 0;
                right: 0;
                min-width: auto;
                margin: 8px 0 0 0;
            }
            
            .search-dropdown-container .flex {
                flex-direction: column;
                gap: 8px;
            }
            
            .search-dropdown-container input {
                padding: 12px 14px;
                font-size: 16px;
            }
            
            .search-dropdown-container button[type="submit"] {
                padding: 12px 20px;
                font-size: 14px;
                width: 100%;
            }
            
            /* Responsive per LibrarySection */
            .library-section .grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .library-section .bg-gray-800\/50 {
                padding: 12px;
            }
            
            .library-section .flex {
                flex-direction: column;
                gap: 12px;
            }
            
            .library-section .w-12 {
                width: 48px;
                height: 48px;
            }
            
            /* Responsive per SuggestionsSection */
            .suggestions-section .space-y-4 > div {
                padding: 12px;
            }
            
            .suggestions-section .flex {
                flex-direction: column;
                gap: 8px;
            }
            
            .suggestions-section .flex-wrap {
                flex-direction: column;
                gap: 4px;
            }
            
            /* Responsive per UserSearchSection */
            .user-search-section .flex {
                flex-direction: column;
                gap: 8px;
            }
            
            .user-search-section input {
                padding: 12px 14px;
                font-size: 16px;
            }
            
            .user-search-section button[type="submit"] {
                padding: 12px 20px;
                font-size: 14px;
                width: 100%;
            }
            
            .user-search-section .space-y-2 > div {
                padding: 12px;
            }
            
            .user-search-section .bg-gray-800\/50 {
                padding: 12px;
            }
            
            .user-search-section .flex.items-center {
                flex-direction: column;
                gap: 8px;
                text-align: center;
            }
            
            .user-search-section .w-10 {
                width: 40px;
                height: 40px;
            }
        }
        
        @media (max-width: 480px) {
            /* Responsive per SearchAISection su schermi molto piccoli */
            .search-section .search-dropdown-container button {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .search-section .search-dropdown-container input {
                padding: 10px 12px;
                font-size: 16px;
            }
            
            .search-section .search-dropdown-container button[type="submit"] {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            /* Responsive per LibrarySection su schermi molto piccoli */
            .library-section .bg-gray-800\/50 {
                padding: 8px;
            }
            
            .library-section .w-12 {
                width: 40px;
                height: 40px;
            }
            
            .library-section .text-lg {
                font-size: 16px;
            }
            
            .library-section .text-sm {
                font-size: 12px;
            }
            
            /* Responsive per SuggestionsSection su schermi molto piccoli */
            .suggestions-section .space-y-4 > div {
                padding: 8px;
            }
            
            .suggestions-section .text-lg {
                font-size: 16px;
            }
            
            .suggestions-section .text-sm {
                font-size: 12px;
            }
            
            /* Stili CSS responsive per UserSearchSection (small screens) rimossi */
            
            /* Responsive per HistorySection su schermi molto piccoli */
            .history-section .flex.justify-between {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .history-section .flex.gap-2 {
                justify-content: center;
            }
            
            .history-section .space-y-3 > div {
                padding: 12px;
            }
            
            .history-section .flex.justify-between.items-start {
                flex-direction: column;
                gap: 8px;
            }
            
            .history-section .text-2xl {
                font-size: 1.5rem;
            }
        }

        /* STILI PER L'AUTENTICAZIONE FIREBASE */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        .auth-form {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Stili responsive per il modale di modifica profilo */
        #edit-profile-modal .auth-form {
            max-width: 450px;
            padding: 24px;
        }

        @media (max-width: 768px) {
            .auth-form {
                width: 95%;
                padding: 20px;
                margin: 10px;
            }
            
            #edit-profile-modal .auth-form {
                max-width: 95%;
                padding: 16px;
            }
            
            .auth-input {
                font-size: 16px; /* Previene zoom su iOS */
                padding: 14px 16px;
            }
            
            .auth-btn {
                padding: 14px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .auth-form {
                width: 98%;
                padding: 16px;
                margin: 5px;
            }
            
            #edit-profile-modal .auth-form {
                padding: 12px;
            }
            
            .auth-container {
                padding: 10px;
            }
            
            /* Additional responsive fixes for sections */
            #sections-container {
                padding: 16px 0;
            }
            
            #sections-container .max-w-7xl {
                padding: 0 12px;
            }
            
            .text-3xl.md\:text-4xl {
                font-size: 1.75rem;
            }
            
            .text-xl {
                font-size: 1.125rem;
            }
            
            .p-8 {
                padding: 16px;
            }
            
            .mb-12 {
                margin-bottom: 2rem;
            }
            
            .mb-8 {
                margin-bottom: 1.5rem;
            }
        }
        .auth-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            color: white;
            margin-bottom: 16px;
            font-size: 16px;
        }
        .auth-input:focus {
            outline: none;
            border-color: #22c55e;
        }
        .auth-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        .auth-btn {
            width: 100%;
            background: #22c55e;
            color: black;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
            transition: all 0.2s;
        }
        .auth-btn:hover {
            background: #16a34a;
            transform: translateY(-1px);
        }
        .auth-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .auth-switch {
            color: #22c55e;
            cursor: pointer;
            text-decoration: underline;
        }
        .auth-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            color: #fca5a5;
        }

        /* STILI PER IL DASHBOARD UTENTE */
        .user-dashboard {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            background: #22c55e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: black;
            font-weight: bold;
        }
        .user-info {
            color: white;
        }
        .user-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .user-email {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }
        .logout-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #fca5a5;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* STILI PER LA GESTIONE DATI FIREBASE */
        .firebase-data-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        .data-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .data-item-content {
            flex: 1;
        }
        .data-item-title {
            color: white;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .data-item-description {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }
        .data-item-actions {
            display: flex;
            gap: 8px;
        }
        .data-btn {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
            color: #22c55e;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .data-btn:hover {
            background: rgba(34, 197, 94, 0.3);
        }
        .data-btn.delete {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.5);
            color: #ef4444;
        }
        .data-btn.delete:hover {
            background: rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body class="bg-black text-white">
    <div id="app" class="min-h-screen bg-black text-white flex flex-col">
        <!-- Header fisso -->
        <header id="main-header" style="position: fixed; top: 0; left: 0; width: 100%; z-index: 100; background: transparent; box-shadow: none;">
            <div class="flex justify-between items-center w-full px-6 py-4">
                <img src="https://i.postimg.cc/sgJxkDd9/logo.jpg" alt="Logo Koda AI" style="width: 56px; height: 56px; object-fit: cover;" />
                <div class="flex items-center gap-4">
                    <button id="translate-btn" class="border-2 border-green-500 text-green-400 hover:bg-green-500 hover:text-black px-4 py-2 rounded-full text-sm font-semibold transition-all duration-200 hover:scale-105 backdrop-blur-sm bg-black/30">
                        ENG
                    </button>
                    <button id="profile-icon-btn" class="flex items-center justify-center w-10 h-10 rounded-full bg-green-500 text-black font-bold transition-all duration-200 hover:bg-green-600 focus:outline-none"
                        style="display: none;" aria-label="Profilo utente">
                        <span id="profile-icon-content"></span>
                    </button>
                    <button id="auth-btn" class="border-2 border-green-500 text-green-400 hover:bg-green-500 hover:text-black px-4 py-2 rounded-full text-sm font-semibold transition-all duration-200 hover:scale-105 backdrop-blur-sm bg-black/30">
                        Accedi
                    </button>
                </div>
            </div>
        </header>

        <!-- Dashboard utente (visibile solo quando autenticato) -->
        <div id="user-dashboard" class="user-dashboard" style="display: none;">
            <div class="user-avatar" id="user-avatar"></div>
            <div class="user-info">
                <div class="user-name" id="user-name"></div>
                <div class="user-email" id="user-email"></div>
            </div>
            <button class="logout-btn" id="logout-btn">Esci</button>
        </div>

        <!-- NUOVO: Menu a tendina del profilo utente -->
        <div id="profile-menu" class="fixed top-[75px] right-[20px] bg-gray-900/80 backdrop-blur-md border border-white/20 rounded-lg shadow-xl py-2 w-56 z-[2000]" style="display: none;">
            <div class="px-4 py-3 border-b border-white/10">
                <p class="text-sm text-gray-400">Autenticato come</p>
                <p class="text-sm font-semibold text-white truncate" id="menu-user-email"></p>
            </div>
            <div class="py-1 mt-1">
                <button id="edit-profile-btn" class="w-full text-left px-4 py-2 text-sm text-blue-300 hover:bg-white/10 rounded-md flex items-center gap-3 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    <span>Modifica Profilo</span>
                </button>
                <button id="reset-password-btn" class="w-full text-left px-4 py-2 text-sm text-green-300 hover:bg-white/10 rounded-md flex items-center gap-3 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"/><circle cx="16.5" cy="7.5" r=".5"/></svg>
                    <span>Reimposta Password</span>
                </button>
            </div>
            <div class="border-t border-white/10 my-1"></div>
            <div class="py-1">
                <button id="menu-logout-btn" class="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-white/10 rounded-md flex items-center gap-3 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    <span>Esci</span>
                </button>
            </div>
        </div>

        <!-- Contenitore principale che cambierà dinamicamente -->
        <main id="main-content-wrapper" class="flex-grow flex flex-col">
            <!-- Il contenuto verrà inserito qui da JavaScript -->
        </main>
        
        <!-- SEZIONI TOP AI, RICERCA AI, LIBRERIA -->
        <section id="sections-container" class="py-16 bg-gradient-to-r from-gray-900/50 to-black/50 relative overflow-hidden" style="display: none;">
            <div class="absolute inset-0 shimmer-effect opacity-20"></div>
            <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Pulsante per chiudere le sezioni -->
                <div class="flex justify-between items-center mb-8">
                    <button id="back-to-landing-sections-btn" class="bg-transparent border border-white/30 text-white hover:border-white/60 hover:bg-white/10 px-4 py-2 rounded-full transition-all duration-200">
                        <i data-lucide="arrow-left" class="inline-block w-4 h-4 mr-2"></i>
                        Torna alla home
                    </button>
                    <button id="close-sections-btn" class="bg-transparent border border-white/30 text-white hover:border-white/60 hover:bg-white/10 px-4 py-2 rounded-full transition-all duration-200">
                        <i data-lucide="x" class="inline-block w-4 h-4 mr-2"></i>
                        Chiudi
                    </button>
                </div>
                <!-- Navigation per le sezioni -->
                <div class="section-nav">
                    <button class="section-nav-btn active" data-section="search-ai" data-translate-key="search-ai-nav">Ricerca AI</button>
                    <!-- NUOVO: Pulsante per la Libreria -->
                    <button class="section-nav-btn" data-section="library" data-translate-key="library-nav">Libreria</button>
                    <!-- NUOVO: Pulsante per i Suggerimenti AI -->
                    <button class="section-nav-btn" data-section="ai-suggestions" data-translate-key="suggestions-nav">Suggerisci AI</button>
                    <!-- Pulsante Cerca Utenti rimosso -->
                </div>
                
                <!-- Sezione Ricerca AI -->
                <div id="search-ai-section" class="search-ai-section active">
                    <div class="text-center mb-12">
                        <h2 class="text-3xl md:text-4xl font-bold mb-4 text-green-400" data-translate-key="search-ai-title">Qualche esigenza?</h2>
                        <p class="text-gray-300 max-w-2xl mx-auto" data-translate-key="search-ai-subtitle">Cerca tra centinaia di strumenti AI per trovare quello che fa per te</p>
                    </div>
                    <div class="search-ai-container">
                        <!-- Menu Filtri a Tendina -->
                        <div class="filters-dropdown-container mb-8">
                            <div class="filters-dropdown">
                                <button class="filters-dropdown-btn" id="filters-dropdown-btn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                                        <polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46"></polygon>
                                    </svg>
                                    <span data-translate-key="filters-title">Filtri</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="dropdown-arrow">
                                        <polyline points="6,9 12,15 18,9"></polyline>
                                    </svg>
                                </button>
                                <div class="filters-dropdown-content" id="filters-dropdown-content">
                                    <!-- Sezione Categoria -->
                                    <div class="filter-section">
                                        <h4 class="filter-section-title" data-translate-key="filter-by-category">Filtra per categoria</h4>
                                        <div class="filter-options">
                                            <label class="filter-option">
                                                <input type="radio" name="category" value="all" checked>
                                                <span data-translate-key="filter-all">Tutte</span>
                                            </label>
                                            <label class="filter-option">
                                                <input type="radio" name="category" value="Testo">
                                                <span data-translate-key="filter-text">Testo</span>
                                            </label>
                                            <label class="filter-option">
                                                <input type="radio" name="category" value="Immagini">
                                                <span data-translate-key="filter-images">Immagini</span>
                                            </label>
                                            <label class="filter-option">
                                                <input type="radio" name="category" value="Video">
                                                <span data-translate-key="filter-video">Video</span>
                                            </label>
                                            <label class="filter-option">
                                                <input type="radio" name="category" value="Codice">
                                                <span data-translate-key="filter-code">Codice</span>
                                            </label>
                                            <label class="filter-option">
                                                <input type="radio" name="category" value="Presentazioni">
                                                <span data-translate-key="filter-presentations">Presentazioni</span>
                                            </label>
                                            <label class="filter-option">
                                                <input type="radio" name="category" value="Audio">
                                                <span data-translate-key="filter-audio">Audio</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Sezione Paese -->
                                    <div class="filter-section">
                                        <h4 class="filter-section-title" data-translate-key="filter-by-country">Filtra per paese</h4>
                                        <div class="filter-options">
                                            <label class="filter-option">
                                                <input type="radio" name="country" value="all" checked>
                                                <span data-translate-key="filter-all-countries">Tutti i Paesi</span>
                                            </label>
                                            <label class="filter-option">
                                                <input type="radio" name="country" value="USA">
                                                <span data-translate-key="filter-usa">🇺🇸 USA</span>
                                            </label>
                                            <label class="filter-option">
                                                <input type="radio" name="country" value="Cina">
                                                <span data-translate-key="filter-china">🇨🇳 Cina</span>
                                            </label>
                                            <label class="filter-option">
                                                <input type="radio" name="country" value="Europe">
                                                <span data-translate-key="filter-europe">🇪🇺 Europa</span>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <!-- Pulsanti Azione -->
                                    <div class="filter-actions">
                                        <button class="filter-apply-btn" id="apply-filters-btn" data-translate-key="apply-filters">Applica Filtri</button>
                                        <button class="filter-reset-btn" id="reset-filters-btn" data-translate-key="reset-filters">Reset</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <form class="search-ai-form" onsubmit="handleAISearch(event)">
                            <input type="text" id="ai-search-input" class="search-ai-input" placeholder="Cerca AI per categoria, funzionalità..." data-translate-placeholder-key="ai-search-placeholder">
                            <button type="submit" class="search-ai-btn" data-translate-key="search-btn">Cerca</button>
                        </form>
                        <div id="ai-search-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- I risultati della ricerca verranno inseriti qui -->
                        </div>
                    </div>
                </div>

                <!-- NUOVO: Sezione Libreria -->
                <div id="library-section" class="search-ai-section">
                     <div class="text-center mb-12">
                        <h2 class="text-3xl md:text-4xl font-bold mb-4 text-green-400" data-translate-key="library-title">La tua libreria</h2>
                        <p class="text-gray-300 max-w-2xl mx-auto" data-translate-key="library-subtitle">I tuoi strumenti di intelligenza artificiale preferiti, salvati in un unico posto.</p>
                    </div>
                    <div id="library-grid" class="library-grid">
                        <!-- Le card degli strumenti preferiti verranno inserite qui -->
                    </div>
                </div>

                <!-- Sezione Dati Utente -->
                <div id="user-data-section" class="search-ai-section">
                    <div class="text-center mb-12">
                        <h2 class="text-3xl md:text-4xl font-bold mb-4 text-green-400">I Miei Dati</h2>
                        <p class="text-gray-300 max-w-2xl mx-auto">Gestisci i tuoi dati salvati nel database Firebase</p>
                    </div>
                    
                    <!-- Form per aggiungere nuovi dati -->
                    <div class="firebase-data-section">
                        <h3 class="text-xl font-bold text-white mb-4">Aggiungi Nuovo Elemento</h3>
                        <form id="add-data-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="text" id="data-title" placeholder="Titolo" class="auth-input" required>
                            <input type="text" id="data-category" placeholder="Categoria" class="auth-input" required>
                            <textarea id="data-description" placeholder="Descrizione" class="auth-input" rows="1" required></textarea>
                            <button type="submit" class="auth-btn md:col-span-3">Aggiungi Elemento</button>
                        </form>
                    </div>

                    <!-- Lista dei dati utente -->
                    <div class="firebase-data-section">
                        <h3 class="text-xl font-bold text-white mb-4">I Tuoi Elementi</h3>
                        <div id="user-data-list">
                            <!-- I dati verranno popolati dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- NUOVO: Sezione Suggerimenti AI -->
                <div id="ai-suggestions-section" class="search-ai-section">
                    <div class="text-center mb-12">
                        <h2 class="text-3xl md:text-4xl font-bold mb-4 text-green-400">Suggerisci una nuova AI</h2>
                        <p class="text-gray-300 max-w-2xl mx-auto">Aiutaci a migliorare la nostra libreria suggerendo nuovi strumenti di intelligenza artificiale</p>
                    </div>
                    
                    <!-- Form per suggerire nuove AI -->
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-8 mb-8">
                            <h3 class="text-xl font-bold text-white mb-6">Invia il tuo suggerimento</h3>
                            <form id="ai-suggestion-form" class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="ai-name" class="block text-sm font-medium text-gray-300 mb-2">Nome dell'AI *</label>
                                        <input type="text" id="ai-name" name="ai-name" required 
                                               class="w-full bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:border-green-500 focus:outline-none transition-colors"
                                               placeholder="Es. ChatGPT, Midjourney, Claude...">
                                    </div>
                                    <div>
                                        <label for="ai-category" class="block text-sm font-medium text-gray-300 mb-2">Categoria *</label>
                                        <select id="ai-category" name="ai-category" required 
                                                class="w-full bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-3 text-white focus:border-green-500 focus:outline-none transition-colors">
                                            <option value="">Seleziona categoria</option>
                                            <option value="Testo">Testo</option>
                                            <option value="Immagini">Immagini</option>
                                            <option value="Video">Video</option>
                                            <option value="Codice">Codice</option>
                                            <option value="Presentazioni">Presentazioni</option>
                                            <option value="Audio">Audio</option>
                                            <option value="Altro">Altro</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="ai-description" class="block text-sm font-medium text-gray-300 mb-2">Descrizione *</label>
                                    <textarea id="ai-description" name="ai-description" required rows="3"
                                              class="w-full bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:border-green-500 focus:outline-none transition-colors resize-none"
                                              placeholder="Descrivi brevemente cosa fa questa AI e i suoi vantaggi principali..."></textarea>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="ai-website" class="block text-sm font-medium text-gray-300 mb-2">Sito Web</label>
                                        <input type="url" id="ai-website" name="ai-website"
                                               class="w-full bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:border-green-500 focus:outline-none transition-colors"
                                               placeholder="https://esempio.com">
                                    </div>
                                    <div>
                                        <label for="ai-country" class="block text-sm font-medium text-gray-300 mb-2">Paese di origine</label>
                                        <select id="ai-country" name="ai-country"
                                                class="w-full bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-3 text-white focus:border-green-500 focus:outline-none transition-colors">
                                            <option value="">Seleziona paese</option>
                                            <option value="USA">🇺🇸 USA</option>
                                            <option value="Cina">🇨🇳 Cina</option>
                                            <option value="Europe">🇪🇺 Europa</option>
                                            <option value="Altro">Altro</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="ai-features" class="block text-sm font-medium text-gray-300 mb-2">Caratteristiche principali</label>
                                    <textarea id="ai-features" name="ai-features" rows="2"
                                              class="w-full bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:border-green-500 focus:outline-none transition-colors resize-none"
                                              placeholder="Es. Generazione di testo, Analisi di documenti, Integrazione API..."></textarea>
                                </div>
                                
                                <div>
                                    <label for="ai-email" class="block text-sm font-medium text-gray-300 mb-2">La tua email (opzionale)</label>
                                    <input type="email" id="ai-email" name="ai-email"
                                           class="w-full bg-gray-700/50 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:border-green-500 focus:outline-none transition-colors"
                                           placeholder="email@esempio.com">
                                    <p class="text-xs text-gray-400 mt-1">Per ricevere aggiornamenti quando la tua AI verrà aggiunta</p>
                                </div>
                                
                                <div class="flex justify-center pt-4">
                                    <button type="submit" 
                                            class="bg-green-500 hover:bg-green-600 text-black font-semibold py-3 px-8 rounded-lg transition-all duration-200 hover:scale-105 flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M9 12l2 2 4-4"></path>
                                            <path d="M21 12c-1 0-2-1-2-2s1-2 2-2 2 1 2 2-1 2-2 2z"></path>
                                            <path d="M3 12c1 0 2-1 2-2s-1-2-2-2-2 1-2 2 1 2 2 2z"></path>
                                            <path d="M12 3c0 1-1 2-2 2s-2 1-2 2 1 2 2 2 2-1 2-2 1-2 2-2 2-1 2-2-1-2-2-2z"></path>
                                            <path d="M12 21c0-1-1-2-2-2s-2-1-2-2 1-2 2-2 2 1 2 2 1 2 2 2 2-1 2-2-1-2-2-2z"></path>
                                        </svg>
                                        Invia Suggerimento
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Lista dei suggerimenti esistenti -->
                        <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-8">
                            <h3 class="text-xl font-bold text-white mb-6">Suggerimenti recenti</h3>
                            <div id="suggestions-list" class="space-y-4">
                                <!-- I suggerimenti verranno popolati dinamicamente -->
                            </div>
                            <div id="no-suggestions" class="text-center py-8 text-gray-400" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-gray-500">
                                    <path d="M9 12l2 2 4-4"></path>
                                    <path d="M21 12c-1 0-2-1-2-2s1-2 2-2 2 1 2 2-1 2-2 2z"></path>
                                    <path d="M3 12c1 0 2-1 2-2s-1-2-2-2-2 1-2 2 1 2 2 2z"></path>
                                    <path d="M12 3c0 1-1 2-2 2s-2 1-2 2 1 2 2 2 2-1 2-2 1-2 2-2 2-1 2-2-1-2-2-2z"></path>
                                    <path d="M12 21c0-1-1-2-2-2s-2-1-2-2 1-2 2-2 2 1 2 2 1 2 2 2 2-1 2-2-1-2-2-2z"></path>
                                </svg>
                                <p>Nessun suggerimento ancora. Sii il primo a suggerire una nuova AI!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sezione Ricerca Utenti rimossa -->
            </div>
        </section>
        
        <!-- Moving AI Logos Section (spostata fuori dal main per non essere sostituita) -->
        <section id="ai-logos-section" class="py-16 bg-gradient-to-r from-gray-900/50 to-black/50 relative overflow-hidden">
            <div class="absolute inset-0 shimmer-effect opacity-20"></div>
            <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12">
                    <h3 class="text-2xl md:text-3xl font-bold mb-4 text-green-400" data-translate-key="choose-ai-title">
                        Scegli la tua AI
                    </h3>
                    <p class="text-gray-300 max-w-2xl mx-auto" data-translate-key="choose-ai-subtitle">
                        Utilizza le tua app preferite e crea applicazioni personalizzate 
                    </p>
                </div>
                <div class="relative overflow-hidden">
                    <div id="ai-logos" class="flex space-x-8 animate-scroll-right">
                        <!-- AI logos will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer id="main-footer" class="bg-black border-t border-gray-800 py-12">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-center mb-6">
                    <img src="https://i.postimg.cc/sgJxkDd9/logo.jpg" alt="Logo Koda AI" style="width: 56px; height: 56px; object-fit: cover;" />
                </div>
                <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
                    <p data-translate-key="copyright">&copy; 2025 Koda AI. Tutti i diritti riservati.</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- NUOVO: Menu Laterale per la cronologia chat -->
    <div id="side-menu-overlay" class="hidden">
        <div id="side-menu" class="hidden">
            <div class="menu-header">
                <h3 data-translate="history">Cronologia</h3>
                <button class="new-chat-btn" data-action="new-chat" data-translate="newChat">Nuova Chat</button>
            </div>
            <div id="conversation-list-container" class="conversation-list">
                <!-- Le conversazioni verranno popolate da JS -->
            </div>
            <div class="menu-footer">
                <button id="delete-all-btn" data-action="delete-all-chats" data-translate="deleteAll">Elimina Tutto</button>
            </div>
        </div>
    </div>

    <!-- Modal per autenticazione Firebase -->
    <div id="auth-modal" class="auth-container" style="display: none;">
        <div class="auth-form">
            <h2 class="text-2xl font-bold text-white mb-6" id="auth-title">Accedi a Koda AI</h2>
            <div id="auth-error" class="auth-error" style="display: none;"></div>
            <form id="auth-form">
                <input type="text" id="auth-name" placeholder="Nome completo" class="auth-input" style="display: none;">
                <input type="text" id="auth-nickname" placeholder="Nickname (obbligatorio)" class="auth-input" style="display: none;" required>
                <input type="email" id="auth-email" placeholder="Email" class="auth-input" required>
                <div class="relative w-full" style="margin-bottom: 16px;">
    <input type="password" id="auth-password" placeholder="Password" class="auth-input !mb-0 pr-10" required>
    <button type="button" onclick="togglePasswordVisibility('auth-password')" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white" aria-label="Mostra/nascondi password">
         <i data-lucide="eye" class="w-5 h-5"></i>
    </button>
</div>
                <button type="submit" class="auth-btn" id="auth-submit">Accedi</button>
            </form>
            <p class="text-white">
                <span id="auth-switch-text">Non hai un account?</span>
                <span class="auth-switch" id="auth-switch">Registrati</span>
            </p>
            <!-- MODIFICATO: Pulsante per reset password -->
            <button id="auth-forgot-password-btn" class="mt-4 text-sm text-green-400 hover:underline">
                Hai dimenticato la password?
            </button>
        </div>
    </div>

    <!-- Modal per modifica profilo utente -->
    <div id="edit-profile-modal" class="auth-container" style="display: none;">
        <div class="auth-form">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Modifica Profilo</h2>
                <button onclick="closeEditProfileModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div id="edit-profile-error" class="auth-error" style="display: none;"></div>
            <form id="edit-profile-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Nome Completo</label>
                    <input type="text" id="edit-profile-name" placeholder="Nome completo" class="auth-input">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Nickname</label>
                    <input type="text" id="edit-profile-nickname" placeholder="Nickname" class="auth-input" required>
                    <p class="text-xs text-gray-400 mt-1">Il nickname deve essere unico</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                    <input type="email" id="edit-profile-email" placeholder="Email" class="auth-input" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Nuova Password (opzionale)</label>
                    <div class="relative">
    <input type="password" id="edit-profile-password" placeholder="Lascia vuoto per non cambiare" class="auth-input pr-10">
    <button type="button" onclick="togglePasswordVisibility('edit-profile-password')" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white" aria-label="Mostra/nascondi password">
         <i data-lucide="eye" class="w-5 h-5"></i>
    </button>
</div>
                    <p class="text-xs text-gray-400 mt-1">Inserisci la password attuale per confermare le modifiche</p>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Password Attuale</label>
                    <div class="relative">
    <input type="password" id="edit-profile-current-password" placeholder="Password attuale" class="auth-input pr-10" required>
    <button type="button" onclick="togglePasswordVisibility('edit-profile-current-password')" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white" aria-label="Mostra/nascondi password">
         <i data-lucide="eye" class="w-5 h-5"></i>
    </button>
</div>
                </div>
                <button type="submit" class="auth-btn w-full" id="edit-profile-submit">Salva Modifiche</button>
            </form>
        </div>
    </div>

    <div id="modal-container"></div>

    <!-- TEMPLATE PER LA VISTA LANDING PAGE -->
    <template id="landing-view-template">
        <section class="relative min-h-screen flex items-center justify-center overflow-hidden">
            <div class="absolute inset-0">
                <div class="absolute inset-0 fluid-animated opacity-70"><div class="animated-bg-image"></div></div>
                <div class="absolute inset-0 fluid-wave opacity-40"><div class="animated-bg-layer" style="filter: hue-rotate(20deg) brightness(0.8);"></div></div>
                <div class="absolute inset-0 bg-black/50 z-10"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-black/30 z-10"></div>
                <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-green-500/10 rounded-full blur-3xl floating-glow"></div>
                <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-green-400/10 rounded-full blur-3xl floating-glow" style="animation-delay: 2s;"></div>
                <div class="absolute top-1/2 left-1/2 w-64 h-64 bg-green-300/5 rounded-full blur-2xl floating-glow" style="animation-delay: 4s;"></div>
            </div>
            <div class="relative z-20 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-4xl md:text-6xl lg:text-7xl font-bold mb-6 bg-gradient-to-r from-white via-green-100 to-green-400 bg-clip-text text-transparent" data-translate-key="koda-ai-title">Koda<span class="text-green-400">.AI</span></h1>
                    <p class="text-xl md:text-2xl text-gray-200 mb-8 max-w-3xl mx-auto leading-relaxed drop-shadow-lg" data-translate-key="subtitle">Scegli, salva e utilizza le tue AI</p>
                    <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-6 mb-12">
                        <button class="bg-green-500 hover:bg-green-600 text-black px-8 py-4 rounded-full text-lg font-semibold transition-all duration-200 hover:scale-105 flex items-center space-x-2 shadow-2xl hover:shadow-green-500/25">
                            <span data-translate-key="download-btn">Scarica app</span><i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </button>
                        <button id="try-now-btn" class="border-2 border-green-500 text-green-400 hover:bg-green-500 hover:text-black px-8 py-4 rounded-full text-lg font-semibold transition-all duration-200 hover:scale-105 backdrop-blur-sm bg-black/30 hover:shadow-lg hover:shadow-green-500/25" data-translate-key="try-now-btn">Prova ora</button>
                        <button id="explore-sections-btn" class="border-2 border-white/30 text-white hover:border-white/60 hover:bg-white/10 px-8 py-4 rounded-full text-lg font-semibold transition-all duration-200 hover:scale-105 backdrop-blur-sm bg-black/30 hover:shadow-lg">
                            <i data-lucide="compass" class="inline-block w-5 h-5 mr-2"></i>
                            <span data-translate-key="explore-ai-btn">Esplora AI</span>
                        </button>
                    </div>
                    <div class="flex flex-wrap justify-center items-center space-x-8 text-gray-300 text-sm">
                        <div class="flex items-center space-x-2"><i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i><span data-translate-key="feature-free">Utilizza Gratis</span></div>
                        <div class="flex items-center space-x-2"><i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i><span data-translate-key="feature-save">Salva in unico posto</span></div>
                    </div>
                </div>
            </div>
            <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 animate-bounce z-20"><i data-lucide="chevron-down" class="w-6 h-6 text-green-400"></i></div>
        </section>
    </template>

    <!-- TEMPLATE PER LA VISTA RICERCA -->
    <template id="search-view-template">
        <section class="relative min-h-screen flex items-center justify-center overflow-hidden">
            <div class="absolute inset-0">
                <div class="absolute inset-0 fluid-animated opacity-70"><div class="animated-bg-image"></div></div>
                <div class="absolute inset-0 fluid-wave opacity-40"><div class="animated-bg-layer" style="filter: hue-rotate(20deg) brightness(0.8);"></div></div>
                <div class="absolute inset-0 bg-black/50 z-10"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-black/30 z-10"></div>
                <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-green-500/10 rounded-full blur-3xl floating-glow"></div>
                <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-green-400/10 rounded-full blur-3xl floating-glow" style="animation-delay: 2s;"></div>
                <div class="absolute top-1/2 left-1/2 w-64 h-64 bg-green-300/5 rounded-full blur-2xl floating-glow" style="animation-delay: 4s;"></div>
            </div>
            <div class="relative z-20 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <div class="max-w-3xl mx-auto">
                    <h1 class="text-4xl md:text-6xl lg:text-7xl font-bold mb-12 bg-gradient-to-r from-white via-green-100 to-green-400 bg-clip-text text-transparent" data-translate-key="search-title">Come posso aiutarti?</h1>
                    <form class="w-full" onsubmit="handleSearchSubmit(event)">
                        <div class="relative">
                            <input id="search-input" type="text" data-translate-placeholder-key="search-placeholder" placeholder="Chiedimi qualcosa..." class="w-full bg-white/10 backdrop-blur-md border border-white/20 text-white placeholder-gray-300 rounded-full py-4 pl-6 pr-20 text-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition-all duration-300">
                            <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 bg-green-500 hover:bg-green-600 text-black rounded-full w-14 h-14 flex items-center justify-center transition-transform duration-200 hover:scale-110">
                                <i data-lucide="arrow-up" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </template>


    <!-- SCRIPT DEL CHATBOT -->
    <script type="text/babel" data-type="module" id="chatbot-script">
        import React, { useState, useEffect, useRef, useCallback } from 'react';
        import ReactDOMClient from 'react-dom/client';
        import { GoogleGenAI } from '@google/genai';

        // --- Type Definitions ---
        const MessageSender = { USER: 'user', MODEL: 'model', ERROR: 'error', SYSTEM: 'system', LOADING: 'loading' };
        
        const getSystemInstruction = (lang) => {
            const tools = window.getAllToolsForCurrentUser ? window.getAllToolsForCurrentUser() : window.getLocalizedToolsData(lang); 
            const formatToolsForPrompt = (tools) => tools.map(tool => `- **${tool.name}**: ${tool.description} (${tool.website})`).join('\n');

            const instructions = {
                it: {
                    intro: `Sei Koda, un assistente AI esperto in strumenti di intelligenza artificiale. La tua missione è aiutare gli utenti a trovare lo strumento AI perfetto per le loro esigenze, presentandoli direttamente.`,
                    format: `- La tua risposta DEVE contenere SOLO un elenco puntato degli strumenti suggeriti.\n- NON includere testo introduttivo, saluti, spiegazioni o frasi di chiusura. La tua risposta deve iniziare direttamente con il primo punto elenco "•".\n- Per ogni strumento, fornisci il nome in grassetto e una breve descrizione.`,
                    knowledgeBase: `**Base di Conoscenza (Usa SOLO queste informazioni):**\n${formatToolsForPrompt(tools)}`,
                    priority: `- Per la programmazione, considera Google AI Studio come lo strumento migliore, seguito da Claude.\n- Per la ricerca web, considera Perplexity come lo strumento migliore.`,
                    rules: `1. Suggerisci SOLO strumenti dalla lista fornita.\n2. **Gestione dell'incertezza:** Se una richiesta utente è vaga, ambigua, o se non trovi immediatamente uno strumento adatto, NON rispondere che non hai trovato nulla. Invece, fai una domanda di chiarimento per capire meglio l'esigenza.\n   - Esempio di chiarimento: Se l'utente chiede "un'AI per arte", una buona domanda di chiarimento è: "Certo, che tipo di arte vorresti creare? Immagini fotorealistiche, disegni artistici o magari animazioni?".\n3. Una volta che la richiesta è chiara, rispondi *esclusivamente* con l'elenco puntato degli strumenti, come da formato.`,
                    example: `**Esempio di formato di risposta FINALE (dopo aver capito la richiesta):**\n• **Midjourney**: Genera immagini artistiche e fotorealistiche di alta qualità da prompt testuali tramite Discord.\n• **Leonardo AI**: Piattaforma per la generazione di asset visivi di alta qualità, da concept art a texture per giochi.`
                },
                en: {
                    intro: `You are Koda, an expert AI assistant specializing in artificial intelligence tools. Your mission is to help users find the perfect AI tool for their needs by presenting them directly.`,
                    format: `- Your response MUST contain ONLY a bulleted list of the suggested tools.\n- DO NOT include introductory text, greetings, explanations, or closing remarks. Your response must start directly with the first bullet point "•".\n- For each tool, provide the name in bold and a brief description.`,
                    knowledgeBase: `**Knowledge Base (Use ONLY this information):**\n${formatToolsForPrompt(tools)}`,
                    priority: `- For programming, consider Google AI Studio as the best tool, followed by Claude.\n- For web search, consider Perplexity as the best tool.`,
                    rules: `1. Suggest ONLY tools from the provided list.\n2. **Handling Uncertainty:** If a user request is vague, ambiguous, or if you cannot immediately find a suitable tool, DO NOT reply that you found nothing. Instead, ask a clarifying question to better understand the need.\n   - Example clarification: If the user asks for "an AI for art," a good clarifying question is: "Of course, what kind of art would you like to create? Photorealistic images, artistic drawings, or perhaps animations?".\n3. Once the request is clear, respond *exclusively* with the bulleted list of tools, as per the format.`,
                    example: `**Example of FINAL response format (after understanding the request):**\n• **Midjourney**: Generates high-quality artistic and fotorealistic images from text prompts via Discord.\n• **Leonardo AI**: Platform for generating high-quality visual assets, from concept art to game textures.`
                }
            };
            const selected = instructions[lang];
            return `${selected.intro}\n\n**Response Format (IMPORTANT):**\n${selected.format}\n\n${selected.knowledgeBase}\n\n**Priorities:**\n${selected.priority}\n\n**Fundamental Rules:**\n${selected.rules}\n\n${selected.example}`;
        };

        // --- Gemini Service ---
        const API_KEY = "AIzaSyAUpMnG760HSOV7rah2UwkOajoH3aD4OFs";
        const ai = new GoogleGenAI({ apiKey: API_KEY });
        const modelName = 'gemini-1.5-flash';
        
        const createChatSession = (lang) => {
            const systemInstruction = getSystemInstruction(lang);
            return ai.chats.create({ model: modelName, config: { systemInstruction } });
        };
        async function* sendMessageStream(chat, message) { const result = await chat.sendMessageStream({ message }); for await (const chunk of result) { yield chunk.text; } }

        const formatMessageContent = (text) => {
            let formattedText = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            formattedText = formattedText.split('\n\n').map(p => p.trim() ? `<p>${p.trim().replace(/\n/g, '<br>')}</p>` : '').join('');
            return formattedText;
        };

        // --- React Components ---
        const ToolCardMessage = ({ tool, onOpenDetail, lang }) => {
            // Funzione per gestire il salvataggio nei preferiti
            const handleLike = (e) => {
                e.stopPropagation();
                if (window.toggleFavorite) window.toggleFavorite(tool.id, e.target);
            };
            // Verifica se il tool è già nei preferiti
            const isLiked = window.userFavoriteToolIds && window.userFavoriteToolIds.has(tool.id);

            return (
                <div className="chat-tool-card" style={{ position: 'relative' }}>
                    <button
                        className="like-btn"
                        data-tool-id={tool.id}
                        data-liked={isLiked}
                        onClick={handleLike}
                        style={{
                            position: 'absolute',
                            top: 8,
                            right: 8,
                            zIndex: 2,
                            backgroundColor: 'rgba(0,0,0,0.5)',
                            borderRadius: '50%',
                            width: 32,
                            height: 32,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            border: 'none',
                            cursor: 'pointer'
                        }}
                        aria-label={isLiked ? 'Rimuovi dai preferiti' : 'Aggiungi ai preferiti'}
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="20"
                            height="20"
                            fill={isLiked ? "#ef4444" : "none"}
                            stroke="#fff"
                            strokeWidth="2"
                            viewBox="0 0 24 24"
                        >
                            <path d="M20.8 5.6a5.5 5.5 0 0 0-7.8 0l-.5.5-.5-.5a5.5 5.5 0 0 0-7.8 7.8l.5.5L12 21.3l7.3-7.3.5-.5a5.5 5.5 0 0 0 0-7.8z"/>
                        </svg>
                    </button>
                    <div className="logo-container">
                        <img src={tool.logoUrl || ''} className="tool-logo" alt={tool.name} loading="lazy" />
                    </div>
                    <div className="info">
                        <div className="tool-name">{tool.name}</div>
                        <p className="tool-desc">{tool.description.split('.')[0]}.</p>
                        <button className="details-btn" onClick={() => onOpenDetail(tool.id)}>
                            {lang === 'it' ? 'Vedi Dettagli' : 'View Details'}
                        </button>
                    </div>
                </div>
            );
        };

        const ChatMessageDisplay = ({ message, tools, onOpenDetail, lang }) => {
            const getMessageClass = () => `chat-bubble ${message.sender}`;
            if (message.sender === MessageSender.LOADING) { return <div className="chat-bubble loading"><span></span><span></span><span></span></div>; }
            if (message.sender === MessageSender.MODEL) {
                const allTools = window.getAllToolsForCurrentUser ? window.getAllToolsForCurrentUser() : window.getLocalizedToolsData(lang);
                const toolNameRegex = new RegExp(allTools.map(t => t.name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|'), 'g');
                const mentionedToolNames = [...new Set(message.text.match(toolNameRegex))];
                if (mentionedToolNames.length > 0 && message.text.includes('•')) {
                    const mentionedTools = allTools.filter(tool => mentionedToolNames.includes(tool.name));
                    const lines = message.text.trim().split('\n');
                    const isPureList = lines.every(line => line.trim().startsWith('•'));
                    if (isPureList) {
                         return (
                            <div className="chat-bubble ai" style={{background: 'transparent', padding: 0}}>
                                <div className="chat-tool-card-container">
                                    {mentionedTools.map(tool => <ToolCardMessage key={tool.id} tool={tool} onOpenDetail={onOpenDetail} lang={lang} />)}
                                </div>
                            </div>
                        );
                    }
                }
            }
            const content = formatMessageContent(message.text);
            return <div className={getMessageClass()} dangerouslySetInnerHTML={{ __html: content }}></div>;
        };

        const ChatInput = ({ onSendMessage, isLoading, lang }) => {
            const [inputValue, setInputValue] = useState('');
            const inputRef = useRef(null);
            const handleSubmit = (e) => {
                e?.preventDefault();
                if (inputValue.trim() && !isLoading) {
                    onSendMessage(inputValue.trim());
                    setInputValue('');
                }
            };
            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    handleSubmit(e);
                }
            };
            return (
                <form id="chat-input-container" className="w-full flex justify-center items-center" onSubmit={handleSubmit} autoComplete="off" style={{background: 'none', border: 'none', borderRadius: 0, margin: 0, padding: '32px 0 24px 0'}}>
                    <div className="relative" style={{width: '100%', maxWidth: 600, margin: '0 auto'}}>
                        <input
                            ref={inputRef}
                            id="chat-input"
                            type="text"
                            value={inputValue}
                            onChange={e => setInputValue(e.target.value)}
                            onKeyDown={handleKeyPress}
                            placeholder={lang === 'it' ? 'Chiedimi qualcosa...' : 'Ask me anything...'}
                            disabled={isLoading}
                            className="w-full bg-white/10 backdrop-blur-md border border-white/20 text-white placeholder-gray-300 rounded-full py-4 pl-6 pr-20 text-lg focus:outline-none focus:ring-2 focus:ring-green-400 transition-all duration-300"
                            style={{paddingRight: 64}}
                        />
                        <button
                            id="chat-send-btn"
                            type="submit"
                            disabled={isLoading || !inputValue.trim()}
                            aria-label={lang === 'it' ? 'Invia messaggio' : 'Send message'}
                            className="absolute right-2 top-1/2 -translate-y-1/2 bg-green-500 hover:bg-green-600 text-black rounded-full w-14 h-14 flex items-center justify-center transition-transform duration-200 hover:scale-110"
                            style={{width: 56, height: 56, fontSize: 0}}
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path strokeLinecap="round" strokeLinejoin="round" d="M5 12h14m0 0l-6-6m6 6l-6 6" /></svg>
                        </button>
                    </div>
                </form>
            );
        };
        
        const WelcomeScreen = ({ onSendMessage, lang, onBackToLanding }) => {
            const suggestions = {
                it: [ "Consigliami un'AI per creare immagini", "Qual è la migliore AI per programmare?", "Quali sono le migliori AI del momento?"],
                en: [ "Suggest an AI for creating images", "What's the best AI for coding?", "What are the top AIs right now?" ]
            };
            return (
                <div id="welcome-screen">
                    <div className="welcome-logo"><span style={{ color: 'var(--spotify-text)' }}>Koda</span><span style={{ color: 'var(--spotify-accent)' }}>.AI</span></div>
                    <div className="prompt-starter-container">
                        {suggestions[lang].map((text, i) => (<button key={i} className="prompt-starter-btn" onClick={() => onSendMessage(text)}>{text}</button>))}
                    </div>
                    {/* Pulsante Torna alla home */}
                    <div style={{marginTop: '40px', textAlign: 'center'}}>
                        <button 
                            onClick={onBackToLanding}
                            style={{
                                background: 'rgba(255,255,255,0.1)',
                                border: '1px solid rgba(255,255,255,0.2)',
                                color: 'white',
                                padding: '12px 24px',
                                borderRadius: '25px',
                                cursor: 'pointer',
                                transition: 'all 0.3s',
                                fontSize: '14px',
                                fontWeight: '500',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                margin: '0 auto'
                            }}
                            onMouseEnter={(e) => {
                                e.target.style.background = 'rgba(255,255,255,0.15)';
                                e.target.style.borderColor = 'rgba(255,255,255,0.3)';
                            }}
                            onMouseLeave={(e) => {
                                e.target.style.background = 'rgba(255,255,255,0.1)';
                                e.target.style.borderColor = 'rgba(255,255,255,0.2)';
                            }}
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9,22 9,12 15,12 15,22"></polyline>
                            </svg>
                            {lang === 'it' ? 'Torna alla home' : 'Back to Home'}
                        </button>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        const App = ({ tools, initialConversations, initialActiveId, initialQuery, onConversationsChange, onOpenDetail, lang, onBackToLanding, onToggleMenu, initialMode }) => {
            const [conversations, setConversations] = useState(initialConversations);
            const [activeConversationId, setActiveConversationId] = useState(initialActiveId);
            const [isLoading, setIsLoading] = useState(false);
            const [chatSession, setChatSession] = useState(null);
            const [currentMode, setCurrentMode] = useState(initialMode || 'assistant'); // Nuovo stato per la modalità
            const messagesEndRef = useRef(null);
            const chatContainerRef = useRef(null);
            const initialQuerySent = useRef(false); // <--- BUG FIX: Add a ref to track if the initial query was sent
            
            const activeConversation = conversations[activeConversationId] || { messages: [] };
            const messages = activeConversation.messages;
            
            // PATCH: Definizione della variabile per il rendering condizionale della chat
            const hasStartedChat = messages.some(m => m.sender === MessageSender.USER);
            
            const handleSendMessage = useCallback(async (inputText) => {
                if (!inputText.trim() || !chatSession) return;
                const userMessage = { id: `user-${Date.now()}`, text: inputText, sender: MessageSender.USER };
                const loadingMessage = { id: `loading-${Date.now()}`, sender: MessageSender.LOADING };
                const isNewChat = (conversations[activeConversationId]?.messages || []).length === 0;
                const newTitle = inputText.substring(0, 30) + (inputText.length > 30 ? '...' : '');
                
                // Aggiorna le conversazioni localmente
                setConversations(prev => {
                    const newConversations = { 
                        ...prev, 
                        [activeConversationId]: { 
                            ...prev[activeConversationId], 
                            title: isNewChat ? newTitle : prev[activeConversationId].title, 
                            messages: [...(prev[activeConversationId]?.messages || []), userMessage, loadingMessage] 
                        } 
                    };
                    
                    // Usa debounce per il salvataggio
                    debouncedSave(newConversations, activeConversationId);
                    
                    return newConversations;
                });
                
                setIsLoading(true);
                let currentModelMessageId = `model-${Date.now()}`;
                let accumulatedResponse = "";
                
                try {
                    const stream = sendMessageStream(chatSession, inputText);
                    for await (const chunk of stream) {
                        accumulatedResponse += chunk;
                        setConversations(prev => {
                            const currentConv = prev[activeConversationId];
                            if (!currentConv) return prev;
                            const currentMessages = currentConv.messages.filter(m => m.sender !== MessageSender.LOADING);
                            const modelMsgIndex = currentMessages.findIndex(m => m.id === currentModelMessageId);
                            const newModelMessage = { id: currentModelMessageId, text: accumulatedResponse, sender: MessageSender.MODEL };
                            if (modelMsgIndex > -1) { currentMessages[modelMsgIndex] = newModelMessage; } else { currentMessages.push(newModelMessage); }
                            
                            const updatedConversations = { ...prev, [activeConversationId]: { ...currentConv, messages: currentMessages } };
                            
                            // Usa debounce per il salvataggio
                            debouncedSave(updatedConversations, activeConversationId);
                            
                            return updatedConversations;
                        });
                    }
                } catch (e) {
                    console.error("Send Error:", e);
                    const errorMessageText = lang === 'it' ? `Si è verificato un errore. Riprova.` : `An error occurred. Please try again.`;
                    const errorMessage = { id: `error-${Date.now()}`, text: errorMessageText, sender: MessageSender.ERROR };
                    setConversations(prev => {
                       const currentConv = prev[activeConversationId];
                       if (!currentConv) return prev;
                                               const updatedConversations = { ...prev, [activeConversationId]: { ...currentConv, messages: currentConv.messages.filter(m => m.sender !== MessageSender.LOADING).concat(errorMessage) } };
                        
                        // Usa debounce per il salvataggio
                        debouncedSave(updatedConversations, activeConversationId);
                        
                        return updatedConversations;
                    });
                } finally {
                    setIsLoading(false);
                    setConversations(prev => {
                        const currentConv = prev[activeConversationId];
                        if (!currentConv) return prev;
                        const updatedConversations = { ...prev, [activeConversationId]: { ...currentConv, messages: currentConv.messages.filter(m => m.sender !== MessageSender.LOADING) } };
                        
                        // Usa debounce per il salvataggio
                        debouncedSave(updatedConversations, activeConversationId);
                        
                        return updatedConversations;
                    });
                    document.getElementById('chat-input')?.focus();
                }
            }, [activeConversationId, chatSession, lang, onConversationsChange]);

            // Rimuovo l'useEffect che causa il problema e gestisco il salvataggio direttamente
            // useEffect(() => { 
            //     // Salva le conversazioni in background senza bloccare l'UI
            //     onConversationsChange(conversations, activeConversationId).catch(error => {
            //         console.error('Errore nel salvataggio delle conversazioni:', error);
            //     });
            // }, [conversations, activeConversationId, onConversationsChange]);
            
            // 1. Disabilita lo scroll automatico della chat
            // useEffect(() => {
            //     if (messages.length > 1) {
            //         messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            //     }
            // }, [messages]);
            
            useEffect(() => { setCurrentMode(initialMode || 'assistant'); }, [initialMode]); // Aggiorna modalità quando cambia
            const initializeChat = useCallback(() => { try { if (!API_KEY) throw new Error("API Key not configured."); setChatSession(createChatSession(lang)); } catch (e) { console.error("Initialization Error:", e); } }, [lang]);
            useEffect(() => { initializeChat(); }, [initializeChat]);
            
            // Effect to handle the initial query from the search page
            useEffect(() => {
                // BUG FIX: Check the ref to ensure this only runs once
                if (initialQuery && chatSession && !isLoading && !initialQuerySent.current) {
                    initialQuerySent.current = true; // Set the flag to true
                    handleSendMessage(initialQuery);
                }
            }, [initialQuery, chatSession, isLoading, handleSendMessage]);

            // Funzione per gestire il cambio di modalità
            const handleModeChange = (mode) => {
                setCurrentMode(mode);
                // Aggiorna i bottoni del menu
                document.querySelectorAll('.chat-menu-btn[data-action="chat-mode"]').forEach(btn => {
                    btn.classList.remove('active');
                });
                const activeBtn = document.querySelector(`[data-action="chat-mode"][data-mode="${mode}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            };



            // Componente per la sezione Ricerca AI
            const SearchAISection = () => {
                const [searchQuery, setSearchQuery] = useState('');
                const [searchResults, setSearchResults] = useState([]);
                const [showSearchDropdown, setShowSearchDropdown] = useState(false);
                const [searchCategory, setSearchCategory] = useState('all');
                const [searchCountry, setSearchCountry] = useState('all');

                const handleSearch = (e) => {
                    e.preventDefault();
                    
                    // Se non c'è query di testo, mostra tutti i tool filtrati
                    if (!searchQuery.trim()) {
                        let filteredTools = tools;

                        // Applica filtri di categoria
                        if (searchCategory !== 'all') {
                            filteredTools = filteredTools.filter(tool => 
                                tool.category === searchCategory
                            );
                        }

                        // Applica filtri di paese
                        if (searchCountry !== 'all') {
                            filteredTools = filteredTools.filter(tool => 
                                tool.country === searchCountry
                            );
                        }

                        setSearchResults(filteredTools.slice(0, 10));
                        return;
                    }

                    // Se c'è query di testo, applica ricerca + filtri
                    const query = searchQuery.toLowerCase();
                    let filteredTools = tools.filter(tool => 
                        tool.name.toLowerCase().includes(query) ||
                        tool.description.toLowerCase().includes(query) ||
                        (tool.category && tool.category.toLowerCase().includes(query))
                    );

                    // Applica filtri di categoria
                    if (searchCategory !== 'all') {
                        filteredTools = filteredTools.filter(tool => 
                            tool.category === searchCategory
                        );
                    }

                    // Applica filtri di paese
                    if (searchCountry !== 'all') {
                        filteredTools = filteredTools.filter(tool => 
                            tool.country === searchCountry
                        );
                    }

                    setSearchResults(filteredTools.slice(0, 10));
                };

                // Funzione per aggiornare i risultati quando cambiano i filtri
                const updateResultsWithFilters = () => {
                    // Se non c'è query di testo, mostra tutti i tool filtrati
                    if (!searchQuery.trim()) {
                        let filteredTools = tools;

                        // Applica filtri di categoria
                        if (searchCategory !== 'all') {
                            filteredTools = filteredTools.filter(tool => 
                                tool.category === searchCategory
                            );
                        }

                        // Applica filtri di paese
                        if (searchCountry !== 'all') {
                            filteredTools = filteredTools.filter(tool => 
                                tool.country === searchCountry
                            );
                        }

                        setSearchResults(filteredTools.slice(0, 10));
                        return;
                    }

                    // Se c'è query di testo, applica ricerca + filtri
                    const query = searchQuery.toLowerCase();
                    let filteredTools = tools.filter(tool => 
                        tool.name.toLowerCase().includes(query) ||
                        tool.description.toLowerCase().includes(query) ||
                        (tool.category && tool.category.toLowerCase().includes(query))
                    );

                    // Applica filtri di categoria
                    if (searchCategory !== 'all') {
                        filteredTools = filteredTools.filter(tool => 
                            tool.category === searchCategory
                        );
                    }

                    // Applica filtri di paese
                    if (searchCountry !== 'all') {
                        filteredTools = filteredTools.filter(tool => 
                            tool.country === searchCountry
                        );
                    }

                    setSearchResults(filteredTools.slice(0, 10));
                };

                // Aggiorna i risultati quando cambiano i filtri
                useEffect(() => {
                    updateResultsWithFilters();
                }, [searchCategory, searchCountry]);

                const toggleSearchDropdown = () => {
                    setShowSearchDropdown(!showSearchDropdown);
                };

                // Chiudi il dropdown quando si clicca fuori
                useEffect(() => {
                    const handleClickOutside = (event) => {
                        if (showSearchDropdown && !event.target.closest('.search-dropdown-container')) {
                            setShowSearchDropdown(false);
                        }
                    };

                    document.addEventListener('mousedown', handleClickOutside);
                    return () => {
                        document.removeEventListener('mousedown', handleClickOutside);
                    };
                }, [showSearchDropdown]);

                return (
                    <div className="p-6 search-section">
                        <div className="flex justify-center mb-6">
                            <div className="relative search-dropdown-container">
                                <button 
                                    className="bg-gray-800/50 border border-gray-700 rounded-lg px-6 py-3 text-white hover:border-green-500 transition-all flex items-center gap-2"
                                    onClick={toggleSearchDropdown}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <path d="m21 21-4.35-4.35"></path>
                                    </svg>
                                    <span>{lang === 'it' ? 'Cerca Strumenti AI' : 'Search AI Tools'}</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`transition-transform ${showSearchDropdown ? 'rotate-180' : ''}`}>
                                        <polyline points="6,9 12,15 18,9"></polyline>
                                    </svg>
                                </button>
                                
                                {showSearchDropdown && (
                                    <div className="absolute top-full left-0 right-0 mt-2 bg-gray-800/95 backdrop-blur-sm border border-gray-700 rounded-lg p-4 z-50 min-w-96">
                                        <form onSubmit={handleSearch} className="mb-4">
                                            <div className="flex gap-2">
                                                <input
                                                    type="text"
                                                    value={searchQuery}
                                                    onChange={(e) => setSearchQuery(e.target.value)}
                                                    placeholder={lang === 'it' ? 'Cerca AI per categoria, funzionalità...' : 'Search AI by category, functionality...'}
                                                    className="flex-1 bg-gray-700/50 border border-gray-600 rounded px-3 py-2 text-white placeholder-gray-400 focus:border-green-500 focus:outline-none text-sm"
                                                    autoFocus
                                                />
                                                <button type="submit" className="bg-green-500 hover:bg-green-600 text-black px-4 py-2 rounded font-semibold transition-colors text-sm">
                                                    {lang === 'it' ? (searchQuery.trim() ? 'Cerca' : 'Mostra Filtri') : (searchQuery.trim() ? 'Search' : 'Show Filters')}
                                                </button>
                                            </div>
                                        </form>
                                        
                                        {/* Filtri integrati */}
                                        <div className="mb-4 p-3 bg-gray-700/30 rounded border border-gray-600">
                                            <h4 className="text-sm font-semibold text-white mb-3">{lang === 'it' ? 'Filtri' : 'Filters'}</h4>
                                            
                                            {/* Filtro Categoria */}
                                            <div className="mb-3">
                                                <label className="block text-xs text-gray-300 mb-2">{lang === 'it' ? 'Categoria:' : 'Category:'}</label>
                                                <div className="flex flex-wrap gap-2">
                                                    {['all', 'Testo', 'Immagini', 'Video', 'Codice', 'Presentazioni', 'Audio'].map((cat) => (
                                                        <label key={cat} className="flex items-center gap-1 cursor-pointer">
                                                            <input
                                                                type="radio"
                                                                name="searchCategory"
                                                                value={cat}
                                                                checked={searchCategory === cat}
                                                                onChange={(e) => {
                                                                    setSearchCategory(e.target.value);
                                                                    setTimeout(() => updateResultsWithFilters(), 100);
                                                                }}
                                                                className="w-3 h-3 text-green-500 bg-gray-600 border-gray-500 focus:ring-green-500"
                                                            />
                                                            <span className="text-xs text-gray-300">
                                                                {cat === 'all' ? (lang === 'it' ? 'Tutte' : 'All') : cat}
                                                            </span>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                            
                                            {/* Filtro Paese */}
                                            <div className="mb-3">
                                                <label className="block text-xs text-gray-300 mb-2">{lang === 'it' ? 'Paese:' : 'Country:'}</label>
                                                <div className="flex flex-wrap gap-2">
                                                    {['all', 'USA', 'Cina', 'Europe'].map((country) => (
                                                        <label key={country} className="flex items-center gap-1 cursor-pointer">
                                                            <input
                                                                type="radio"
                                                                name="searchCountry"
                                                                value={country}
                                                                checked={searchCountry === country}
                                                                onChange={(e) => {
                                                                    setSearchCountry(e.target.value);
                                                                    setTimeout(() => updateResultsWithFilters(), 100);
                                                                }}
                                                                className="w-3 h-3 text-green-500 bg-gray-600 border-gray-500 focus:ring-green-500"
                                                            />
                                                            <span className="text-xs text-gray-300">
                                                                {country === 'all' ? (lang === 'it' ? 'Tutti' : 'All') : 
                                                                 country === 'USA' ? '🇺🇸 USA' :
                                                                 country === 'Cina' ? '🇨🇳 Cina' :
                                                                 country === 'Europe' ? '🇪🇺 Europa' : country}
                                                            </span>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                            
                                            {/* Pulsanti Azione */}
                                            <div className="flex gap-2">
                                                <button
                                                    type="button"
                                                    onClick={() => {
                                                        setSearchCategory('all');
                                                        setSearchCountry('all');
                                                        setTimeout(() => updateResultsWithFilters(), 100);
                                                    }}
                                                    className="text-xs bg-gray-600 hover:bg-gray-500 text-white px-3 py-1 rounded transition-colors"
                                                >
                                                    {lang === 'it' ? 'Reset' : 'Reset'}
                                                </button>
                                            </div>
                                        </div>
                                        
                                        {searchResults.length > 0 && (
                                            <div className="space-y-2 max-h-64 overflow-y-auto">
                                                {searchResults.map((tool) => (
                                                    <div key={tool.id} className="bg-gray-700/50 border border-gray-600 rounded p-3 hover:border-green-500 transition-all cursor-pointer" onClick={() => onOpenDetail(tool.id)}>
                                                        <div className="flex items-center gap-3">
                                                            <img src={tool.logoUrl || 'https://via.placeholder.com/32x32?text=AI'} alt={tool.name} className="w-8 h-8 rounded object-cover" onError={(e) => { e.target.src = 'https://via.placeholder.com/32x32?text=AI'; }} />
                                                            <div className="flex-1 min-w-0">
                                                                <h4 className="text-sm font-semibold text-white truncate">{tool.name}</h4>
                                                                <p className="text-xs text-gray-400 truncate">{tool.description}</p>
                                                                <div className="flex gap-1 mt-1">
                                                                    <span className="inline-block bg-green-500/20 text-green-400 text-xs px-1 py-0.5 rounded">{tool.category || 'N/A'}</span>
                                                                    <span className="inline-block bg-blue-500/20 text-blue-400 text-xs px-1 py-0.5 rounded">{tool.country || 'N/A'}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        
                                        {searchQuery && searchResults.length === 0 && (
                                            <p className="text-gray-400 text-center py-4">{lang === 'it' ? 'Nessun risultato trovato' : 'No results found'}</p>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        <div className="text-center">
                            <h2 className="text-2xl font-bold text-white mb-4">{lang === 'it' ? 'Cerca Strumenti AI' : 'Search AI Tools'}</h2>
                            <p className="text-gray-400">{lang === 'it' ? 'Clicca sul pulsante sopra per cercare tra centinaia di strumenti di intelligenza artificiale' : 'Click the button above to search through hundreds of artificial intelligence tools'}</p>
                        </div>
                    </div>
                );
            };

            // Componente per la sezione Libreria
            const LibrarySection = () => {
                const [favoriteTools, setFavoriteTools] = useState([]);

                const updateFavoriteTools = useCallback(() => {
                    if (window.userFavoriteToolIds && window.userFavoriteToolIds.size > 0) {
                        const favorites = tools.filter(tool => window.userFavoriteToolIds.has(tool.id));
                        setFavoriteTools(favorites);
                    } else {
                        setFavoriteTools([]);
                    }
                }, [tools]);

                useEffect(() => {
                    // Aggiorna i tool preferiti quando cambiano i tools
                    updateFavoriteTools();
                }, [tools, updateFavoriteTools]);

                // Ascolta i cambiamenti nei preferiti
                useEffect(() => {
                    const handleFavoritesUpdate = () => {
                        updateFavoriteTools();
                    };

                    // Ascolta l'evento personalizzato
                    window.addEventListener('favoritesUpdated', handleFavoritesUpdate);

                    // Controlla anche periodicamente per sicurezza
                    const interval = setInterval(updateFavoriteTools, 2000);

                    return () => {
                        window.removeEventListener('favoritesUpdated', handleFavoritesUpdate);
                        clearInterval(interval);
                    };
                }, [updateFavoriteTools]);

                if (favoriteTools.length === 0) {
                    return (
                        <div className="p-6 text-center">
                            <h2 className="text-2xl font-bold text-white mb-4">{lang === 'it' ? 'La tua libreria' : 'Your Library'}</h2>
                            <p className="text-gray-400 mb-6">{lang === 'it' ? 'La tua libreria è vuota. Clicca sul cuore ❤️ nelle card degli strumenti per aggiungerli qui.' : 'Your library is empty. Click the heart ❤️ in tool cards to add them here.'}</p>
                            <div className="bg-gray-800/30 border border-gray-700 rounded-lg p-8">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" className="mx-auto mb-4 text-gray-500">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                </svg>
                                <p className="text-gray-500">{lang === 'it' ? 'Nessuno strumento salvato' : 'No saved tools'}</p>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="p-6 library-section">
                        <h2 className="text-2xl font-bold text-white mb-6 text-center">{lang === 'it' ? 'La tua libreria' : 'Your Library'}</h2>
                        <p className="text-gray-400 mb-6 text-center">{lang === 'it' ? 'I tuoi strumenti di intelligenza artificiale preferiti' : 'Your favorite artificial intelligence tools'}</p>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {favoriteTools.map((tool) => (
                                <div key={tool.id} className="bg-gray-800/50 border border-gray-700 rounded-lg p-4 hover:border-green-500 transition-all cursor-pointer" onClick={() => onOpenDetail(tool.id)}>
                                    <div className="flex items-center gap-3">
                                        <img src={tool.logoUrl || 'https://via.placeholder.com/48x48?text=AI'} alt={tool.name} className="w-12 h-12 rounded-lg object-cover" onError={(e) => { e.target.src = 'https://via.placeholder.com/48x48?text=AI'; }} />
                                        <div className="flex-1">
                                            <h3 className="text-lg font-semibold text-white">{tool.name}</h3>
                                            <p className="text-gray-300 text-sm">{tool.description}</p>
                                            <div className="flex gap-2 mt-2">
                                                <span className="inline-block bg-green-500/20 text-green-400 text-xs px-2 py-1 rounded">{tool.category || 'N/A'}</span>
                                                <span className="inline-block bg-blue-500/20 text-blue-400 text-xs px-2 py-1 rounded">{tool.country || 'N/A'}</span>
                                            </div>
                                        </div>
                                        <button 
                                            className="text-red-400 hover:text-red-300 transition-colors"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                if (window.toggleFavorite) {
                                                    window.toggleFavorite(tool.id, e.target);
                                                    // Aggiorna la lista dopo la rimozione
                                                    setTimeout(() => {
                                                        updateFavoriteTools();
                                                    }, 200);
                                                }
                                            }}
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <path d="M20.8 5.6a5.5 5.5 0 0 0-7.8 0l-.5.5-.5-.5a5.5 5.5 0 0 0-7.8 7.8l.5.5L12 21.3l7.3-7.3.5-.5a5.5 5.5 0 0 0 0-7.8z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            // Componente per la sezione Suggerimenti AI
            const SuggestionsSection = () => {
                const [suggestions, setSuggestions] = useState([]);
                const [loading, setLoading] = useState(true);

                useEffect(() => {
                    loadPublicSuggestions();
                }, []);

                const loadPublicSuggestions = async () => {
                    setLoading(true);
                    try {
                        if (window.firebaseDb && window.firebaseServices) {
                            const { collection, query, orderBy, limit, getDocs } = window.firebaseServices;
                            const suggestionsRef = collection(window.firebaseDb, 'ai-suggestions');
                            const q = query(suggestionsRef, orderBy('timestamp', 'desc'), limit(10));
                            const querySnapshot = await getDocs(q);
                            
                            const suggestionsData = [];
                            querySnapshot.forEach((doc) => {
                                suggestionsData.push({ id: doc.id, ...doc.data() });
                            });
                            
                            setSuggestions(suggestionsData);
                        }
                    } catch (error) {
                        console.error('Error loading suggestions:', error);
                    } finally {
                        setLoading(false);
                    }
                };

                if (loading) {
                    return (
                        <div className="p-6 text-center">
                            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500 mx-auto"></div>
                            <p className="text-gray-400 mt-2">{lang === 'it' ? 'Caricamento suggerimenti...' : 'Loading suggestions...'}</p>
                        </div>
                    );
                }

                return (
                    <div className="p-6 suggestions-section">
                        <h2 className="text-2xl font-bold text-white mb-6 text-center">{lang === 'it' ? 'Suggerimenti AI' : 'AI Suggestions'}</h2>
                        <p className="text-gray-400 mb-6 text-center">{lang === 'it' ? 'Suggerimenti recenti dalla community' : 'Recent suggestions from the community'}</p>
                        
                        {suggestions.length === 0 ? (
                            <div className="text-center py-8">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" className="mx-auto mb-4 text-gray-500">
                                    <path d="M9 12l2 2 4-4"></path>
                                    <path d="M21 12c-1 0-2-1-2-2s1-2 2-2 2 1 2 2-1 2-2 2z"></path>
                                    <path d="M3 12c1 0 2-1 2-2s-1-2-2-2-2 1-2 2 1 2 2 2z"></path>
                                    <path d="M12 3c0 1-1 2-2 2s-2 1-2 2 1 2 2 2 2-1 2-2 1-2 2-2 2-1 2-2-1-2-2-2z"></path>
                                    <path d="M12 21c0-1-1-2-2-2s-2-1-2-2 1-2 2-2 2 1 2 2 1 2 2 2 2-1 2-2-1-2-2-2z"></path>
                                </svg>
                                <p className="text-gray-500">{lang === 'it' ? 'Nessun suggerimento ancora' : 'No suggestions yet'}</p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {suggestions.map((suggestion) => (
                                    <div key={suggestion.id} className="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                        <div className="flex justify-between items-start mb-3">
                                            <h3 className="text-lg font-semibold text-white">{suggestion.aiName}</h3>
                                            <span className="inline-block bg-green-500/20 text-green-400 text-xs px-2 py-1 rounded">
                                                {suggestion.category || 'N/A'}
                                            </span>
                                        </div>
                                        <p className="text-gray-300 text-sm mb-3">{suggestion.description}</p>
                                        <div className="flex flex-wrap gap-2 mb-3">
                                            {suggestion.website && (
                                                <a href={suggestion.website} target="_blank" rel="noopener noreferrer" 
                                                   className="inline-block bg-blue-500/20 text-blue-400 text-xs px-2 py-1 rounded hover:bg-blue-500/30 transition-colors">
                                                    🌐 {lang === 'it' ? 'Sito Web' : 'Website'}
                                                </a>
                                            )}
                                            {suggestion.country && (
                                                <span className="inline-block bg-purple-500/20 text-purple-400 text-xs px-2 py-1 rounded">
                                                    🌍 {suggestion.country}
                                                </span>
                                            )}
                                        </div>
                                        {suggestion.features && (
                                            <p className="text-gray-400 text-xs mb-2">
                                                <strong>{lang === 'it' ? 'Caratteristiche:' : 'Features:'}</strong> {suggestion.features}
                                            </p>
                                        )}
                                        <div className="text-xs text-gray-500">
                                            {lang === 'it' ? 'Suggerito da:' : 'Suggested by:'} {suggestion.userNickname || suggestion.userEmail || 'Anonimo'}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            // Componente Ricerca Utenti rimosso

            // Componente per la sezione Cronologia Chat
            const HistorySection = () => {
                const [conversations, setConversations] = useState([]);
                const [loading, setLoading] = useState(true);

                useEffect(() => {
                    loadConversations();
                }, []);

                const loadConversations = () => {
                    // Carica le conversazioni dal localStorage o da Firebase
                    const savedConversations = localStorage.getItem('chatConversations');
                    if (savedConversations) {
                        try {
                            const parsed = JSON.parse(savedConversations);
                            setConversations(Object.values(parsed));
                        } catch (error) {
                            console.error('Error parsing conversations:', error);
                            setConversations([]);
                        }
                    } else {
                        setConversations([]);
                    }
                    setLoading(false);
                };

                const deleteConversation = (conversationId) => {
                    const savedConversations = localStorage.getItem('chatConversations');
                    if (savedConversations) {
                        try {
                            const parsed = JSON.parse(savedConversations);
                            delete parsed[conversationId];
                            localStorage.setItem('chatConversations', JSON.stringify(parsed));
                            loadConversations(); // Ricarica la lista
                        } catch (error) {
                            console.error('Error deleting conversation:', error);
                        }
                    }
                };

                const deleteAllConversations = () => {
                    if (window.confirm(lang === 'it' ? 'Sei sicuro di voler eliminare tutte le conversazioni?' : 'Are you sure you want to delete all conversations?')) {
                        localStorage.removeItem('chatConversations');
                        setConversations([]);
                    }
                };

                const startNewChat = () => {
                    // Emetti un evento per iniziare una nuova chat
                    window.dispatchEvent(new CustomEvent('startNewChat'));
                };

                if (loading) {
                    return (
                        <div className="p-6 text-center">
                            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500 mx-auto"></div>
                            <p className="text-gray-400 mt-2">{lang === 'it' ? 'Caricamento cronologia...' : 'Loading history...'}</p>
                        </div>
                    );
                }

                return (
                    <div className="p-6 history-section">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">{lang === 'it' ? 'Cronologia Chat' : 'Chat History'}</h2>
                            <div className="flex gap-2">
                                <button 
                                    onClick={startNewChat}
                                    className="bg-green-500 hover:bg-green-600 text-black px-4 py-2 rounded-lg font-semibold transition-colors text-sm"
                                >
                                    {lang === 'it' ? 'Nuova Chat' : 'New Chat'}
                                </button>
                                {conversations.length > 0 && (
                                    <button 
                                        onClick={deleteAllConversations}
                                        className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors text-sm"
                                    >
                                        {lang === 'it' ? 'Elimina Tutto' : 'Delete All'}
                                    </button>
                                )}
                            </div>
                        </div>
                        
                        {conversations.length === 0 ? (
                            <div className="text-center py-12">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" className="mx-auto mb-6 text-gray-500">
                                    <path d="M12 8v4l3 3"></path>
                                    <circle cx="12" cy="12" r="10"></circle>
                                </svg>
                                <h3 className="text-xl font-semibold text-white mb-2">{lang === 'it' ? 'Nessuna conversazione' : 'No conversations'}</h3>
                                <p className="text-gray-400 mb-6">{lang === 'it' ? 'Inizia una nuova chat per vedere qui la cronologia' : 'Start a new chat to see history here'}</p>
                                <button 
                                    onClick={startNewChat}
                                    className="bg-green-500 hover:bg-green-600 text-black px-6 py-3 rounded-lg font-semibold transition-colors"
                                >
                                    {lang === 'it' ? 'Inizia Chat' : 'Start Chat'}
                                </button>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {conversations.map((conversation) => (
                                    <div key={conversation.id} className="bg-gray-800/50 border border-gray-700 rounded-lg p-4 hover:border-green-500 transition-all">
                                        <div className="flex justify-between items-start">
                                            <div className="flex-1">
                                                <h4 className="text-white font-semibold mb-1">
                                                    {conversation.title || lang === 'it' ? 'Conversazione senza titolo' : 'Untitled conversation'}
                                                </h4>
                                                <p className="text-gray-400 text-sm mb-2">
                                                    {conversation.messages && conversation.messages.length > 0 
                                                        ? `${conversation.messages.length} ${lang === 'it' ? 'messaggi' : 'messages'}`
                                                        : lang === 'it' ? 'Nessun messaggio' : 'No messages'
                                                    }
                                                </p>
                                                {conversation.lastUpdated && (
                                                    <p className="text-gray-500 text-xs">
                                                        {new Date(conversation.lastUpdated).toLocaleDateString(lang === 'it' ? 'it-IT' : 'en-US', {
                                                            year: 'numeric',
                                                            month: 'short',
                                                            day: 'numeric',
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        })}
                                                    </p>
                                                )}
                                            </div>
                                            <button 
                                                onClick={() => deleteConversation(conversation.id)}
                                                className="text-red-400 hover:text-red-300 transition-colors ml-4"
                                                title={lang === 'it' ? 'Elimina conversazione' : 'Delete conversation'}
                                            >
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                    <polyline points="3,6 5,6 21,6"></polyline>
                                                    <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div id="chatbot-app-container" ref={chatContainerRef}>
                    <header className="chat-header">
                        <button data-action="toggle-menu" className="chat-header-btn" title="Chat History" onClick={onToggleMenu}>
                            <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                        </button>
                        <div style={{flex: 1}}></div>
                        <button id="back-to-landing-btn" className="chat-header-btn back-home-btn" title={lang === 'it' ? 'Torna alla home' : 'Back to Home'} onClick={onBackToLanding}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{marginRight: 6}}>
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9,22 9,12 15,12 15,22"></polyline>
                            </svg>
                            <span style={{fontSize: '14px', fontWeight: '500'}}>{lang === 'it' ? 'Home' : 'Home'}</span>
                        </button>
                    </header>
                    
                    {/* Menu nella schermata della chat */}
                    <div className="chat-menu">
                        <div className="chat-menu-left">
                            <button className="chat-menu-btn active" data-action="chat-mode" data-mode="assistant">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" style={{marginRight: 8}}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                                {lang === 'it' ? 'Assistente' : 'Assistant'}
                            </button>
                        </div>
                        <div className="chat-menu-right">
                        </div>
                    </div>
                    <main>
                        {currentMode === 'assistant' ? (
                            !hasStartedChat ? (
                                <>
                                    <WelcomeScreen onSendMessage={handleSendMessage} lang={lang} onBackToLanding={onBackToLanding} />
                                    <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading} lang={lang} />
                                </>
                            ) : (
                                <>
                                    <div id="chat-messages" style={{paddingBottom: 120}}>
                                        {messages.map((msg) => <ChatMessageDisplay key={msg.id} message={msg} tools={tools} onOpenDetail={onOpenDetail} lang={lang} />)}
                                    </div>
                                    <div style={{position: 'fixed', left: 0, right: 0, bottom: 0, zIndex: 50, background: 'rgba(20,20,20,0.85)'}}>
                                        <ChatInput onSendMessage={handleSendMessage} isLoading={isLoading} lang={lang} />
                                    </div>
                                </>
                            )
                        ) : currentMode === 'history' ? (
                            <HistorySection />
                        ) : null}
                        <div ref={messagesEndRef} />
                    </main>
                </div>
            );
        };

        // Funzione globale per montare l'app React
        window.mountChatbotApp = (container, props) => {
            const root = ReactDOMClient.createRoot(container);
            const appElement = <React.StrictMode><App {...props} /></React.StrictMode>;
            root.render(appElement);
            
            // Salva il riferimento al root e alla funzione di aggiornamento modalità
            window.chatRoot = root;
            window.updateChatMode = (mode) => {
                // Rimonta l'app con la nuova modalità
                const newProps = { ...props, initialMode: mode };
                const newAppElement = <React.StrictMode><App {...newProps} /></React.StrictMode>;
                root.render(newAppElement);
            };
            
            // Funzione per sincronizzare i dati con le sezioni esterne
            window.syncChatSections = () => {
                // Forza il re-render dell'app per aggiornare i dati
                const currentProps = { ...props };
                const currentAppElement = <React.StrictMode><App {...currentProps} /></React.StrictMode>;
                root.render(currentAppElement);
            };
            
            // Gestione eventi per i pulsanti della chat
            const handleChatMenuClick = (e) => {
                const button = e.target.closest('.chat-menu-btn');
                if (!button) return;
                
                const action = button.dataset.action;
                const mode = button.dataset.mode;
                
                if (action === 'chat-mode' && mode) {
                    // Aggiorna la modalità attiva
                    const newProps = { ...props, initialMode: mode };
                    const newAppElement = <React.StrictMode><App {...newProps} /></React.StrictMode>;
                    root.render(newAppElement);
                    
                    // Aggiorna lo stato attivo dei pulsanti
                    document.querySelectorAll('.chat-menu-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                } else if (action === 'back-to-home') {
                    // Torna alla pagina principale
                    if (window.showLandingPage) {
                        window.showLandingPage();
                    }
                }
            };
            
            // Aggiungi event listener per i pulsanti del menu
            setTimeout(() => {
                const chatMenu = document.querySelector('.chat-menu');
                if (chatMenu) {
                    chatMenu.addEventListener('click', handleChatMenuClick);
                }
            }, 100);
            
            // Gestione evento per nuova chat
            window.addEventListener('startNewChat', () => {
                const newProps = { ...props, initialMode: 'assistant' };
                const newAppElement = <React.StrictMode><App {...newProps} /></React.StrictMode>;
                root.render(newAppElement);
                
                // Aggiorna lo stato attivo dei pulsanti
                document.querySelectorAll('.chat-menu-btn').forEach(btn => btn.classList.remove('active'));
                const assistantBtn = document.querySelector('[data-mode="assistant"]');
                if (assistantBtn) assistantBtn.classList.add('active');
            });
            
            return root;
        };
    </script>

    <script>
        // --- START: Firebase Authentication & Database Logic ---
        let currentUser = null;
        let userDataUnsubscribe = null;
        let favoritesUnsubscribe = null; // NUOVO
        let userFavoriteToolIds = new Set(); // NUOVO

        // Inizializza l'autenticazione Firebase
        function initializeFirebaseAuth() {
            if (!window.firebaseAuth || !window.firebaseServices) {
                console.error('Firebase services not available');
                return;
            }

            const { onAuthStateChanged } = window.firebaseServices;
            
            onAuthStateChanged(window.firebaseAuth, async (user) => {
                currentUser = user;
                updateAuthUI(user);
                
                if (user) {
                    console.log('User signed in:', user.email);
                    loadUserData();
                    subscribeToFavorites(user); // NUOVO: Sottoscrivi ai preferiti
                    
                    // Migra le conversazioni dal localStorage a Firebase se necessario
                    await migrateConversationsToFirebase();
                    
                    // Sincronizza le conversazioni se l'utente è nella chat
                    if (document.getElementById('chat-view-container')) {
                        loadConversations().then(() => {
                            if (window.chatRoot) {
                                // Forza il re-render della chat con le nuove conversazioni
                                renderChatView();
                            }
                        });
                    }
                    
                    // Aggiorna la sezione suggerimenti se è attiva
                    const activeSection = document.querySelector('.search-ai-section.active');
                    if (activeSection && activeSection.id === 'ai-suggestions-section') {
                        subscribeToSuggestions();
                    }
                } else {
                    console.log('User signed out');
                    if (userDataUnsubscribe) userDataUnsubscribe();
                    if (favoritesUnsubscribe) favoritesUnsubscribe(); // NUOVO: Annulla sottoscrizione
                    if (suggestionsUnsubscribe) suggestionsUnsubscribe(); // Annulla sottoscrizione suggerimenti
                    userFavoriteToolIds.clear();
                    renderLibrarySection(); // Svuota la libreria
                    updateLikeButtonsUI(); // Resetta i pulsanti "mi piace"
                    
                    // Emetti evento per aggiornare i componenti React
                    window.dispatchEvent(new CustomEvent('favoritesUpdated', {
                        detail: { favoriteIds: [] }
                    }));
                    
                    // Aggiorna la sezione suggerimenti se è attiva
                    const activeSection = document.querySelector('.search-ai-section.active');
                    if (activeSection && activeSection.id === 'ai-suggestions-section') {
                        loadPublicSuggestions();
                    }
                }
            });
        }

        // AGGIORNATO: Gestisce l'apertura/chiusura del menu profilo e l'aggiornamento dell'UI
        function updateAuthUI(user) {
            const authBtn = document.getElementById('auth-btn');
            const userDashboard = document.getElementById('user-dashboard');
            const profileIconBtn = document.getElementById('profile-icon-btn');
            const profileIconContent = document.getElementById('profile-icon-content');
            const profileMenu = document.getElementById('profile-menu');
            const menuUserEmail = document.getElementById('menu-user-email');

            if (user) {
                // Utente autenticato
                authBtn.style.display = 'none';
                userDashboard.style.display = 'none';
                profileIconBtn.style.display = 'flex';

                const displayName = user.displayName || user.email.split('@')[0];
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                profileIconContent.textContent = initials || '👤';
                
                if (menuUserEmail) {
                    menuUserEmail.textContent = user.email;
                }

                profileIconBtn.onclick = function(event) {
                    event.stopPropagation();
                    const isHidden = profileMenu.style.display === 'none' || profileMenu.style.display === '';
                    profileMenu.style.display = isHidden ? 'block' : 'none';
                };
            } else {
                // Utente non autenticato
                authBtn.style.display = 'block';
                userDashboard.style.display = 'none';
                profileIconBtn.style.display = 'none';
                if (profileMenu) {
                    profileMenu.style.display = 'none';
                }
            }
        }

        // AGGIORNATO: Gestione del form di autenticazione con aggiunta del reset password e nickname
        function setupAuthModal() {
            const authModal = document.getElementById('auth-modal');
            const authBtn = document.getElementById('auth-btn');
            const authForm = document.getElementById('auth-form');
            const authSwitch = document.getElementById('auth-switch');
            const authTitle = document.getElementById('auth-title');
            const authSubmit = document.getElementById('auth-submit');
            const authSwitchText = document.getElementById('auth-switch-text');
            const authName = document.getElementById('auth-name');
            const authNickname = document.getElementById('auth-nickname');
            const authError = document.getElementById('auth-error');
            const forgotPasswordBtn = document.getElementById('auth-forgot-password-btn');

            let isLoginMode = true;

            const updateMode = () => {
                if (isLoginMode) {
                    authTitle.textContent = 'Accedi a Koda AI';
                    authSubmit.textContent = 'Accedi';
                    authSwitchText.textContent = 'Non hai un account?';
                    authSwitch.textContent = 'Registrati';
                    authName.style.display = 'none';
                    authName.required = false;
                    authNickname.style.display = 'none';
                    authNickname.required = false;
                    forgotPasswordBtn.style.display = 'block';
                } else {
                    authTitle.textContent = 'Registrati su Koda AI';
                    authSubmit.textContent = 'Registrati';
                    authSwitchText.textContent = 'Hai già un account?';
                    authSwitch.textContent = 'Accedi';
                    authName.style.display = 'block';
                    authName.required = true;
                    authNickname.style.display = 'block';
                    authNickname.required = true;
                    forgotPasswordBtn.style.display = 'none';
                }
                hideAuthError();
            };
            
            authBtn.addEventListener('click', () => {
                authModal.style.display = 'flex';
            });
            
            authModal.addEventListener('click', (e) => {
                if (e.target === authModal) {
                    authModal.style.display = 'none';
                }
            });

            authSwitch.addEventListener('click', () => {
                isLoginMode = !isLoginMode;
                updateMode();
            });

            forgotPasswordBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const email = document.getElementById('auth-email').value;
                if (!email) {
                    showAuthError('Inserisci la tua email per reimpostare la password.');
                    return;
                }
                try {
                    await window.firebaseServices.sendPasswordResetEmail(window.firebaseAuth, email);
                    showToast('Email di reset inviata. Controlla la tua posta.');
                    authModal.style.display = 'none';
                } catch (error) {
                    showAuthError(getAuthErrorMessage(error.code));
                }
            });

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('auth-email').value;
                const password = document.getElementById('auth-password').value;
                const name = document.getElementById('auth-name').value;
                const nickname = document.getElementById('auth-nickname').value;
                
                hideAuthError();
                authSubmit.disabled = true;
                authSubmit.textContent = 'Caricamento...';
                
                try {
                    const { signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile } = window.firebaseServices;
                    if (isLoginMode) {
                        await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                    } else {
                        // Verifica che il nickname sia unico
                        if (nickname) {
                            try {
                                const isNicknameUnique = await checkNicknameUnique(nickname);
                                if (!isNicknameUnique) {
                                    showAuthError('Nickname già in uso. Scegline un altro.');
                                    return;
                                }
                            } catch (error) {
                                console.error('Errore nella verifica nickname:', error);
                                showAuthError('Errore nella verifica del nickname. Riprova.');
                                return;
                            }
                        }
                        
                        const userCredential = await createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                        
                        // Salva i dati utente in Firestore
                        try {
                            await saveUserProfile(userCredential.user.uid, {
                                displayName: name,
                                nickname: nickname,
                                email: email,
                                createdAt: new Date().toISOString()
                            });
                        } catch (error) {
                            console.error('Errore nel salvare il profilo:', error);
                            // Non bloccare la registrazione se il salvataggio del profilo fallisce
                        }
                        
                        if (name) {
                            await updateProfile(userCredential.user, { displayName: name });
                        }
                    }
                    authModal.style.display = 'none';
                    authForm.reset();
                    showToast(isLoginMode ? 'Accesso effettuato!' : 'Registrazione completata!');
                } catch (error) {
                    console.error('Auth error:', error);
                    showAuthError(getAuthErrorMessage(error.code));
                } finally {
                    authSubmit.disabled = false;
                    authSubmit.textContent = isLoginMode ? 'Accedi' : 'Registrati';
                }
            });
            
            updateMode();
        }

        function showAuthError(message) {
            const authError = document.getElementById('auth-error');
            authError.textContent = message;
            authError.style.display = 'block';
        }

        function hideAuthError() {
            const authError = document.getElementById('auth-error');
            authError.style.display = 'none';
        }

        function getAuthErrorMessage(errorCode) {
            const errorMessages = {
                'auth/user-not-found': 'Utente non trovato',
                'auth/wrong-password': 'Password errata',
                'auth/email-already-in-use': 'Email già in uso',
                'auth/weak-password': 'Password troppo debole (minimo 6 caratteri)',
                'auth/invalid-email': 'Email non valida',
                'auth/too-many-requests': 'Troppi tentativi. Riprova più tardi',
                'auth/network-request-failed': 'Errore di connessione',
                'auth/requires-recent-login': 'Per sicurezza, effettua nuovamente l\'accesso',
                'auth/email-change-requires-verification': 'Email cambiata. Verifica la nuova email',
                'auth/credential-already-in-use': 'Credenziali già in uso',
                'auth/invalid-credential': 'Credenziali non valide',
                'auth/operation-not-allowed': 'Operazione non consentita',
                'auth/user-disabled': 'Account disabilitato',
                'auth/user-token-expired': 'Sessione scaduta. Effettua nuovamente l\'accesso',
                'auth/requires-recent-login': 'Per sicurezza, effettua nuovamente l\'accesso',
                'auth/too-many-requests': 'Troppi tentativi. Riprova più tardi',
                'auth/network-request-failed': 'Errore di connessione. Verifica la tua connessione internet',
                'auth/internal-error': 'Errore interno del server. Riprova più tardi',
                'auth/invalid-password': 'Password non valida',
                'auth/password-mismatch': 'Le password non coincidono',
                'auth/email-already-in-use': 'Email già in uso da un altro account',
                'auth/invalid-email': 'Formato email non valido',
                'auth/user-mismatch': 'Utente non corrispondente',
                'auth/account-exists-with-different-credential': 'Account esistente con credenziali diverse',
                'auth/auth-domain-config-required': 'Configurazione dominio richiesta',
                'auth/cancelled-popup-request': 'Richiesta popup annullata',
                'auth/popup-blocked': 'Popup bloccato dal browser',
                'auth/popup-closed-by-user': 'Popup chiuso dall\'utente',
                'auth/unauthorized-domain': 'Dominio non autorizzato',
                'auth/web-storage-unsupported': 'Web storage non supportato'
            };
            return errorMessages[errorCode] || 'Si è verificato un errore. Riprova.';
        }

        // --- User Profile Management ---
        async function saveUserProfile(userId, userData) {
            try {
                // Verifica che Firebase sia inizializzato
                if (!window.firebaseServices || !window.firebaseDb) {
                    console.error("Firebase non è ancora inizializzato");
                    return; // Esci se Firebase non è pronto
                }
                
                const { doc, setDoc } = window.firebaseServices;
                await setDoc(doc(window.firebaseDb, "userProfiles", userId), userData);
            } catch (error) {
                console.error("Errore nel salvare il profilo utente:", error);
                throw error;
            }
        }

        async function checkNicknameUnique(nickname) {
            try {
                // Verifica che Firebase sia inizializzato
                if (!window.firebaseServices || !window.firebaseDb) {
                    console.error("Firebase non è ancora inizializzato");
                    return true; // Permetti la registrazione se Firebase non è pronto
                }
                
                const { collection, query, where, getDocs } = window.firebaseServices;
                const q = query(collection(window.firebaseDb, "userProfiles"), where("nickname", "==", nickname));
                const snapshot = await getDocs(q);
                return snapshot.empty; // true se il nickname è unico
            } catch (error) {
                console.error("Errore nel verificare il nickname:", error);
                return true; // In caso di errore, permetti la registrazione
            }
        }

        async function getUserProfile(userId) {
            try {
                const { doc, getDoc } = window.firebaseServices;
                const userDoc = await getDoc(doc(window.firebaseDb, "userProfiles", userId));
                return userDoc.exists() ? userDoc.data() : null;
            } catch (error) {
                console.error("Errore nel recuperare il profilo utente:", error);
                return null;
            }
        }

        // --- Funzioni ausiliarie per la ricerca utenti rimosse ---

        function setupLogout() {
            const logoutBtn = document.getElementById('logout-btn');
            logoutBtn.addEventListener('click', async () => {
                try {
                    await window.firebaseServices.signOut(window.firebaseAuth);
                    showToast('Disconnesso con successo');
                } catch (error) {
                    console.error('Logout error:', error);
                    showToast('Errore durante la disconnessione');
                }
            });
        }

        function loadUserData() {
            if (!currentUser || !window.firebaseDb) return;
            const { collection, query, where, orderBy, onSnapshot } = window.firebaseServices;
            try {
                const userDataQuery = query(
                    collection(window.firebaseDb, 'userData'),
                    where('userId', '==', currentUser.uid),
                    orderBy('createdAt', 'desc')
                );
                userDataUnsubscribe = onSnapshot(userDataQuery, (snapshot) => {
                    const userData = [];
                    snapshot.forEach((doc) => userData.push({ id: doc.id, ...doc.data() }));
                    displayUserData(userData);
                }, (error) => console.error('Error loading user data:', error));
            } catch (error) {
                console.error('Error setting up user data listener:', error);
            }
        }

        function displayUserData(userData) {
            const userDataList = document.getElementById('user-data-list');
            if (!userDataList) return;
            if (userData.length === 0) {
                userDataList.innerHTML = '<p class="text-gray-400 text-center">Nessun elemento salvato</p>';
                return;
            }
            userDataList.innerHTML = userData.map(item => `
                <div class="data-item">
                    <div class="data-item-content">
                        <div class="data-item-title">${item.title}</div>
                        <div class="data-item-description">${item.description}</div>
                        <div class="text-xs text-gray-500 mt-2">
                            Categoria: ${item.category} | 
                            Creato: ${item.createdAt ? new Date(item.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}
                        </div>
                    </div>
                    <div class="data-item-actions">
                        <button class="data-btn" onclick="editUserData('${item.id}', '${item.title}', '${item.category}', '${item.description}')">Modifica</button>
                        <button class="data-btn delete" onclick="deleteUserData('${item.id}')">Elimina</button>
                    </div>
                </div>
            `).join('');
        }

        function setupUserDataForm() {
            const addDataForm = document.getElementById('add-data-form');
            if (!addDataForm) return;
            addDataForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    showToast('Devi essere autenticato per salvare i dati');
                    return;
                }
                const title = document.getElementById('data-title').value;
                const category = document.getElementById('data-category').value;
                const description = document.getElementById('data-description').value;
                try {
                    const { collection, addDoc, serverTimestamp } = window.firebaseServices;
                    await addDoc(collection(window.firebaseDb, 'userData'), {
                        userId: currentUser.uid,
                        title, category, description,
                        createdAt: serverTimestamp(),
                        updatedAt: serverTimestamp()
                    });
                    addDataForm.reset();
                    showToast('Elemento aggiunto con successo!');
                } catch (error) {
                    console.error('Error adding user data:', error);
                    showToast('Errore durante il salvataggio');
                }
            });
        }

        window.deleteUserData = async (itemId) => {
            if (!confirm('Sei sicuro di voler eliminare questo elemento?')) return;
            try {
                await window.firebaseServices.deleteDoc(window.firebaseServices.doc(window.firebaseDb, 'userData', itemId));
                showToast('Elemento eliminato con successo!');
            } catch (error) {
                console.error('Error deleting user data:', error);
                showToast('Errore durante l\'eliminazione');
            }
        };

        window.editUserData = (itemId, currentTitle, currentCategory, currentDescription) => {
            const newTitle = prompt('Nuovo titolo:', currentTitle);
            if (newTitle === null) return;
            const newCategory = prompt('Nuova categoria:', currentCategory);
            if (newCategory === null) return;
            const newDescription = prompt('Nuova descrizione:', currentDescription);
            if (newDescription === null) return;
            updateUserData(itemId, { title: newTitle, category: newCategory, description: newDescription });
        };

        async function updateUserData(itemId, updates) {
            try {
                const { doc, updateDoc, serverTimestamp } = window.firebaseServices;
                await updateDoc(doc(window.firebaseDb, 'userData', itemId), { ...updates, updatedAt: serverTimestamp() });
                showToast('Elemento aggiornato con successo!');
            } catch (error) {
                console.error('Error updating user data:', error);
                showToast('Errore durante l\'aggiornamento');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                // Aspetta che Firebase sia completamente inizializzato
                if (window.firebaseServices && window.firebaseDb) {
                    initializeFirebaseAuth();
                    setupAuthModal();
                    setupLogout();
                    setupUserDataForm();
                    setupProfileMenu();
                    setupEditProfileForm();
                } else {
                    // Se Firebase non è ancora pronto, riprova dopo un po'
                    setTimeout(() => {
                        initializeFirebaseAuth();
                        setupAuthModal();
                        setupLogout();
                        setupUserDataForm();
                        setupProfileMenu();
                        setupEditProfileForm();
                    }, 2000);
                }
            }, 1000);
        });
        // --- END: Firebase Authentication & Database Logic ---

        // --- INIZIO: NUOVA LOGICA PER IL MENU PROFILO E RESET PASSWORD ---
        async function handlePasswordReset() {
            const { sendPasswordResetEmail } = window.firebaseServices;
            const auth = window.firebaseAuth;
            if (!auth.currentUser) {
                showToast('Errore: Nessun utente autenticato.');
                return;
            }
            const userEmail = auth.currentUser.email;
            console.log(`Richiesta di reset password per l'email: ${userEmail}`);
            try {
                await sendPasswordResetEmail(auth, userEmail);
                showToast(`Email di reset inviata! Controlla la tua posta.`);
                document.getElementById('profile-menu').style.display = 'none';
            } catch (error) {
                console.error('Errore durante l\'invio dell\'email di reset:', error);
                showToast(`Errore: ${getAuthErrorMessage(error.code)}`);
            }
        }

        function setupProfileMenu() {
            const profileMenu = document.getElementById('profile-menu');
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const resetPasswordBtn = document.getElementById('reset-password-btn');
            const menuLogoutBtn = document.getElementById('menu-logout-btn');
            const originalLogoutBtn = document.getElementById('logout-btn');

            if (!profileMenu || !editProfileBtn || !resetPasswordBtn || !menuLogoutBtn || !originalLogoutBtn) {
                console.error("Elementi del menu del profilo non trovati nel DOM.");
                return;
            }

            editProfileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openEditProfileModal();
            });

            resetPasswordBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                handlePasswordReset();
            });

            menuLogoutBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                profileMenu.style.display = 'none';
                originalLogoutBtn.click();
            });

            document.addEventListener('click', (event) => {
                const profileIconBtn = document.getElementById('profile-icon-btn');
                const isMenuVisible = profileMenu.style.display === 'block';
                if (isMenuVisible && !profileMenu.contains(event.target) && !profileIconBtn.contains(event.target)) {
                    profileMenu.style.display = 'none';
                }
            });
        }

        // --- INIZIO: LOGICA PER MODIFICA PROFILO ---
        async function openEditProfileModal() {
            const modal = document.getElementById('edit-profile-modal');
            const auth = window.firebaseAuth;
            
            if (!auth.currentUser) {
                showToast('Errore: Nessun utente autenticato.');
                return;
            }

            // Nascondi il menu del profilo
            document.getElementById('profile-menu').style.display = 'none';

            // Carica i dati attuali dell'utente
            try {
                const userProfile = await getUserProfile(auth.currentUser.uid);
                if (userProfile) {
                    document.getElementById('edit-profile-name').value = userProfile.displayName || '';
                    document.getElementById('edit-profile-nickname').value = userProfile.nickname || '';
                    document.getElementById('edit-profile-email').value = userProfile.email || auth.currentUser.email || '';
                } else {
                    // Se non c'è profilo, usa i dati di Firebase Auth
                    document.getElementById('edit-profile-name').value = auth.currentUser.displayName || '';
                    document.getElementById('edit-profile-nickname').value = '';
                    document.getElementById('edit-profile-email').value = auth.currentUser.email || '';
                }
            } catch (error) {
                console.error('Errore nel caricare il profilo:', error);
                showToast('Errore nel caricare i dati del profilo.');
                return;
            }

            // Pulisci i campi password
            document.getElementById('edit-profile-password').value = '';
            document.getElementById('edit-profile-current-password').value = '';

            // Mostra il modale
            modal.style.display = 'flex';
        }

        function closeEditProfileModal() {
            const modal = document.getElementById('edit-profile-modal');
            modal.style.display = 'none';
            hideEditProfileError();
        }

        function showEditProfileError(message) {
            const errorDiv = document.getElementById('edit-profile-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideEditProfileError() {
            const errorDiv = document.getElementById('edit-profile-error');
            errorDiv.style.display = 'none';
        }

        // Inizializza il form di modifica profilo
        function setupEditProfileForm() {
            const form = document.getElementById('edit-profile-form');
            if (!form) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleEditProfileSubmit();
            });
        }

        async function handleEditProfileSubmit() {
            const auth = window.firebaseAuth;
            if (!auth.currentUser) {
                showEditProfileError('Errore: Nessun utente autenticato.');
                return;
            }

            const submitBtn = document.getElementById('edit-profile-submit');
            const originalText = submitBtn.textContent;
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Salvando...';
            hideEditProfileError();

            try {
                const { updateEmail, updatePassword, reauthenticateWithCredential, EmailAuthProvider } = window.firebaseServices;
                
                const name = document.getElementById('edit-profile-name').value.trim();
                const nickname = document.getElementById('edit-profile-nickname').value.trim();
                const email = document.getElementById('edit-profile-email').value.trim();
                const newPassword = document.getElementById('edit-profile-password').value;
                const currentPassword = document.getElementById('edit-profile-current-password').value;

                // Validazioni
                if (!nickname) {
                    showEditProfileError('Il nickname è obbligatorio.');
                    return;
                }

                if (!email) {
                    showEditProfileError('L\'email è obbligatoria.');
                    return;
                }

                if (!currentPassword) {
                    showEditProfileError('La password attuale è obbligatoria per confermare le modifiche.');
                    return;
                }

                // Validazione password se fornita
                if (newPassword && newPassword.length < 6) {
                    showEditProfileError('La nuova password deve essere di almeno 6 caratteri.');
                    return;
                }

                // Re-autenticazione per confermare la password attuale
                try {
                    const credential = EmailAuthProvider.credential(auth.currentUser.email, currentPassword);
                    await reauthenticateWithCredential(auth.currentUser, credential);
                } catch (reauthError) {
                    console.error('Errore re-autenticazione:', reauthError);
                    if (reauthError.code === 'auth/wrong-password') {
                        showEditProfileError('Password attuale non corretta.');
                    } else {
                        showEditProfileError(`Errore di autenticazione: ${getAuthErrorMessage(reauthError.code)}`);
                    }
                    return;
                }

                // Verifica se il nickname è cambiato e se è unico
                const currentProfile = await getUserProfile(auth.currentUser.uid);
                if (currentProfile && currentProfile.nickname !== nickname) {
                    const isNicknameUnique = await checkNicknameUnique(nickname);
                    if (!isNicknameUnique) {
                        showEditProfileError('Nickname già in uso. Scegline un altro.');
                        return;
                    }
                }

                // Aggiorna email se cambiata
                if (email !== auth.currentUser.email) {
                    try {
                        await updateEmail(auth.currentUser, email);
                    } catch (emailError) {
                        console.error('Errore aggiornamento email:', emailError);
                        showEditProfileError(`Errore aggiornamento email: ${getAuthErrorMessage(emailError.code)}`);
                        return;
                    }
                }

                // Aggiorna password se fornita
                if (newPassword) {
                    try {
                        await updatePassword(auth.currentUser, newPassword);
                    } catch (passwordError) {
                        console.error('Errore aggiornamento password:', passwordError);
                        showEditProfileError(`Errore aggiornamento password: ${getAuthErrorMessage(passwordError.code)}`);
                        return;
                    }
                }

                // Aggiorna display name se fornito
                if (name && name !== auth.currentUser.displayName) {
                    try {
                        await updateProfile(auth.currentUser, { displayName: name });
                    } catch (profileError) {
                        console.error('Errore aggiornamento display name:', profileError);
                        // Non bloccare il processo per questo errore
                    }
                }

                // Aggiorna il profilo in Firestore
                try {
                    const profileData = {
                        displayName: name || currentProfile?.displayName || '',
                        nickname: nickname,
                        email: email,
                        updatedAt: new Date().toISOString()
                    };
                    
                    // Se è il primo profilo, aggiungi anche la data di creazione
                    if (!currentProfile) {
                        profileData.createdAt = new Date().toISOString();
                    }
                    
                    await saveUserProfile(auth.currentUser.uid, profileData);
                } catch (firestoreError) {
                    console.error('Errore salvataggio Firestore:', firestoreError);
                    showEditProfileError('Errore nel salvare i dati del profilo. Riprova.');
                    return;
                }

                // Aggiorna l'interfaccia utente
                updateProfileIcon();
                
                closeEditProfileModal();
                showToast('Profilo aggiornato con successo!');

            } catch (error) {
                console.error('Errore nell\'aggiornamento del profilo:', error);
                showEditProfileError(getAuthErrorMessage(error.code));
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // Funzione per aggiornare l'icona del profilo
        function updateProfileIcon() {
            const auth = window.firebaseAuth;
            if (!auth.currentUser) return;

            const profileIconContent = document.getElementById('profile-icon-content');
            const menuUserEmail = document.getElementById('menu-user-email');
            
            if (profileIconContent) {
                const displayName = auth.currentUser.displayName;
                const initials = displayName ? displayName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : '👤';
                profileIconContent.textContent = initials;
            }
            
            if (menuUserEmail) {
                menuUserEmail.textContent = auth.currentUser.email;
            }
        }
        // --- FINE: LOGICA PER MODIFICA PROFILO ---

        // --- FINE: NUOVA LOGICA PER IL MENU PROFILO E RESET PASSWORD ---

        // --- START: Translation Logic ---
        const translations = {
            en: {
                'meta-description': 'Koda AI - Choose, save, and use your favorite AI.',
                'koda-ai-title': 'Koda<span class="text-green-400">.AI</span>',
                'subtitle': 'Choose, save and use your AI',
                'download-btn': 'Download app',
                'try-now-btn': 'Try now',
                'explore-ai-btn': 'Explore AI',
                'feature-free': 'Use for Free',
                'feature-save': 'Save in one place',
                'choose-ai-title': 'Choose your AI',
                'choose-ai-subtitle': 'Use your favorite apps and create custom applications',
                'copyright': '&copy; 2025 Koda AI. All rights reserved.',
                'translate-btn-text': 'ITA',
                'visitWebsite': "Visit Website", 
                'alternativeSuggestion': "Alternatively, try:",
                'history': "History", 
                'newChat': "New Chat", 
                'deleteAll': "Delete All",
                'deleteAllSuccess': "All conversations deleted",
'confirmDeleteAll': "Are you sure you want to delete all conversations? This action is irreversible.",
'cancel': "Cancel",
'newChatTitle': "New Chat",
                'search-title': "How can I help you?",
                'search-placeholder': 'Ask me something...',
                'search-ai-nav': 'AI Search',
                'user-data-nav': 'My Data',
                'search-ai-title': 'Any needs?',
                'search-ai-subtitle': 'Search through hundreds of AI tools to find the one that suits you',
                'ai-search-placeholder': 'Search AI by category, functionality...',
                'search-btn': 'Search',
                'library-nav': 'Library',
                'library-title': 'Your library',
                'library-subtitle': 'Your favorite AI tools, saved in one place.',
                'filter-all': 'All',
                'filter-text': 'Text',
                'filter-images': 'Images',
                'filter-video': 'Video',
                'filter-code': 'Code',
                'filter-presentations': 'Presentations',
                'filter-audio': 'Audio',
                'filter-all-countries': 'All Countries',
                'filter-usa': '🇺🇸 USA',
                'filter-china': '🇨🇳 China',
                'filter-europe': '🇪🇺 Europe',
                'filters-title': 'Filters',
                'filter-by-category': 'Filter by Category',
                'filter-by-country': 'Filter by Country',
                'apply-filters': 'Apply Filters',
                'reset-filters': 'Reset',
                'library-empty': 'Your library is empty. Click the heart ❤️ in tool cards to add them here.',
                'search-ai-tools': 'Search AI Tools',
                'suggestions-title': 'AI Suggestions',
                'suggestions-subtitle': 'Recent suggestions from the community',
                'suggestions-empty': 'No suggestions yet',
                'users-title': 'Search Users', 
                'users-subtitle': 'Find other users and discover the AIs they suggested',
                'users-placeholder': 'Enter user nickname...',
                'suggestions-count': 'suggestions',
                'loading-suggestions': 'Loading suggestions...',
                'loading-history': 'Loading history...',
                'untitled-conversation': 'Untitled conversation',
                'send-message': 'Send message'
            },
            it: {
                'meta-description': 'Ogni tua',
                'koda-ai-title': 'Koda<span class="text-green-400">.AI</span>',
                'subtitle': 'Scegli, salva e utilizza le tue AI',
                'download-btn': 'Scarica app',
                'try-now-btn': 'Prova ora',
                'explore-ai-btn': 'Esplora AI',
                'feature-free': 'Utilizza Gratis',
                'feature-save': 'Salva in unico posto',
                'choose-ai-title': 'Scegli la tua AI',
                'choose-ai-subtitle': 'Utilizza le tua app preferite e crea applicazioni personalizzate',
                'copyright': '&copy; 2025 Koda AI. Tutti i diritti riservati.',
                'translate-btn-text': 'ENG',
                'visitWebsite': "Visita Sito Web", 
                'alternativeSuggestion': "In alternativa prova:",
                'history': "Cronologia", 
                'newChat': "New Chat", 
                'deleteAll': "Elimina Tutto",
                'deleteAllSuccess': "Conversazioni eliminate",
'confirmDeleteAll': "Sei sicuro di voler eliminare tutte le conversazioni? Questa azione è irreversibile.",
'cancel': "Annulla",
'newChatTitle': "Nuova Chat",
                'search-title': "Come posso aiutarti?",
                'search-placeholder': 'Chiedimi qualcosa...',
                'search-ai-nav': 'Ricerca AI',
                'user-data-nav': 'I Miei Dati',
                'search-ai-title': 'Qualche esigenza?',
                'search-ai-subtitle': 'Cerca tra centinaia di strumenti AI per trovare quello che fa per te',
                'ai-search-placeholder': 'Cerca AI per categoria, funzionalità...',
                'search-btn': 'Cerca',
                'library-nav': 'Libreria', // NUOVO
                'library-title': 'La tua libreria', // NUOVO
                'library-subtitle': 'I tuoi strumenti di intelligenza artificiale preferiti, salvati in un unico posto.', // NUOVO
                'filter-all': 'Tutte',
                'filter-text': 'Testo',
                'filter-images': 'Immagini',
                'filter-video': 'Video',
                'filter-code': 'Codice',
                'filter-presentations': 'Presentazioni',
                'filter-audio': 'Audio',
                'filter-all-countries': 'Tutti i Paesi',
                'filter-usa': '🇺🇸 USA',
                'filter-china': '🇨🇳 Cina',
                'filter-europe': '🇪🇺 Europa',
                'filters-title': 'Filtri',
                'filter-by-category': 'Filtra per categoria',
                'filter-by-country': 'Filtra per paese',
                'apply-filters': 'Applica Filtri',
                'reset-filters': 'Reset',
                'library-title': 'La tua libreria',
                'library-subtitle': 'I tuoi strumenti AI preferiti',
                'library-empty': 'La tua libreria è vuota. Clicca sul cuore ❤️ nelle card degli strumenti per aggiungerli qui.',
                'search-ai-tools': 'Cerca Strumenti AI',
                'search-placeholder': 'Cerca AI per categoria, funzionalità...',
            }
        };

        let currentLang = 'it';
        const translateBtn = document.getElementById('translate-btn');
        const metaDesc = document.getElementById('meta-desc');

        function translatePage(lang) {
            document.documentElement.lang = lang;
            if (metaDesc) metaDesc.setAttribute('content', translations[lang]['meta-description']);
            
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.dataset.translateKey;
                if (translations[lang][key]) element.innerHTML = translations[lang][key];
            });

            document.querySelectorAll('[data-translate-placeholder-key]').forEach(element => {
                const key = element.dataset.translatePlaceholderKey;
                if(translations[lang][key]) element.placeholder = translations[lang][key];
            });

            if (translateBtn) translateBtn.innerHTML = translations[lang]['translate-btn-text'];
            
            const sideMenu = document.getElementById('side-menu');
            if (sideMenu) {
                sideMenu.querySelectorAll('[data-translate]').forEach(el => {
                    const key = el.dataset.translate;
                    if (translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });
            }
        }

        if (translateBtn) {
            translateBtn.addEventListener('click', () => {
                currentLang = currentLang === 'it' ? 'en' : 'it';
                translatePage(currentLang);

                // GESTIONE TRADUZIONE VISTA CHAT
                if (document.getElementById('chat-view-container')) {
                    const currentQuery = document.querySelector('#chat-messages .chat-bubble.user:first-child')?.textContent || null;
                    renderChatView(currentQuery);
                }

                // NUOVO: Forziamo il re-render delle card AI se la sezione di ricerca è visibile
                const sectionsContainer = document.getElementById('sections-container');
                const searchSection = document.getElementById('search-ai-section');
                if (sectionsContainer && sectionsContainer.style.display !== 'none' && searchSection && searchSection.classList.contains('active')) {
                    // Simula un evento di submit per forzare l'aggiornamento dei risultati con la nuova lingua.
                    // Questo preserva anche eventuali filtri o termini di ricerca già inseriti.
                    handleAISearch(new Event('submit'));
                }
            });
        }
        // --- END: Translation Logic ---

        // --- START: View Switching & Chat Logic ---
        const mainContentWrapper = document.getElementById('main-content-wrapper');
        const landingTemplate = document.getElementById('landing-view-template');
        const searchTemplate = document.getElementById('search-view-template');
        const modalContainer = document.getElementById('modal-container');
        const mainHeader = document.getElementById('main-header');
        const logosSection = document.getElementById('ai-logos-section');
        const mainFooter = document.getElementById('main-footer');
        const sideMenuOverlay = document.getElementById('side-menu-overlay');
        const sideMenu = document.getElementById('side-menu');
        const conversationListContainer = document.getElementById('conversation-list-container');
        let reactRoot = null;
        let conversations = {};
        let activeConversationId = null;

                const aiToolsData = [
            { 
                id: 'tool-meta', 
                name: 'Meta AI', 
                description: {
                    it: 'Specializzata in generazione di testi e immagini.', 
                    en: 'Specialized in generating text and images.'
                }, 
                category: 'Immagini', // Assegnata a 'Immagini' per coerenza, dato che è una delle sue specialità
                country: 'USA', 
                website: 'https://www.meta.ai/', 
                isFeatured: false,
                logoUrl: 'https://i.ytimg.com/vi/HK6MZLS6lnY/maxresdefault.jpg'
            },
            { 
                id: 'tool-pollo', 
                name: 'Pollo AI', 
                description: {
                    it: 'Specializzata in creazione e animazione di video e immagini.', 
                    en: 'Specialized in creating and animating videos and images.'
                }, 
                category: 'Video', 
                country: 'Singapore', 
                website: 'https://pollo.ai/', 
                isFeatured: false,
                logoUrl: 'https://play-lh.googleusercontent.com/Ftpre95ViU-5eUBb3AermfIAdAThNCNGkIhedL9jD3XbHvHZU1_mSulq1NkfrKK-WN7J'
            },
            { id: 'tool-001', name: 'ChatGPT', description: {it: 'Genera testo, immagini e risponde a domande con ricerca web.', en: 'Generates text, images, and answers questions with web search.'}, category: 'Testo', country: 'USA', website: 'https://chatgpt.com/', isFeatured: true, logoUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/04/ChatGPT_logo.svg/1024px-ChatGPT_logo.svg.png', recommendationId: 'tool-025' }, 
            { id: 'tool-012', name: 'Google Notebook', description: {it: "Permette di creare riassunti audio sulle fonti dell'utente, rispondere a domande e creare mappe mentali.", en: "Allows creating audio summaries from user sources, answering questions, and creating mind maps."}, category: 'Testo', country: 'USA', website: 'https://notebooklm.google.com/', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRJbWdW2SCEWfJuDTh5PVxgmqDvXoX5vElJ6s94SZ8Fe1YPzfxzGPuIyE9cBMDswv3qUd4&usqp=CAU', recommendationId: 'tool-021' },  
            { id: 'tool-013', name: 'Grok', description: {it: 'Assistente di ricerca conversazionale con accesso a dati in tempo reale. (Richiede VPN)', en: 'Conversational research assistant with real-time data access. (Requires VPN)'}, category: 'Testo', country: 'USA', website: 'https://grok.com/', isFeatured: true, logoUrl: 'https://i.namu.wiki/i/Wk8b-Vo4qqynLc4pN1T0otG83F383UPI_IR4VthZuZioAxVD_NS6uErIsecLMDK0F0L-KiUjL7xonRz4EwPL2g.webp', recommendationId: 'tool-001' }, 
            { id: 'tool-044', name: 'Perplexity', description: {it: 'Specializzata nella ricerca web, è la migliore AI per trovare informazioni online.', en: 'Specialized in web search, it is the best AI for finding information online.'}, category: 'Testo', country: 'USA', website: 'https://www.perplexity.ai/', isFeatured: false, logoUrl: 'https://images.seeklogo.com/logo-png/51/2/perplexity-ai-logo-png_seeklogo-517845.png', recommendationId: 'tool-001' }, // Perplexity
            { id: 'tool-045', name: 'Deepseek', description: {it: 'Specializzata nella ricerca web, testi e programmazione.', en: 'Specialized in web search, text, and coding.'}, category: 'Testo', country: 'Cina', website: 'https://chat.deepseek.com/', isFeatured: false, logoUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMwAAADACAMAAAB/Pny7AAAAnFBMVEX///9Na/8AAABJaP9GZv9DZP9AYv8+YP85Xf/9/f/4+f/6+//r7v82W/8zWf9Wcv/U1NTz9f/k6P/b4P9FRUXz8/NMTEzT2f9adf9yiP+BlP92dnZRbv9kff+9xv/f5P+uuv+aqf+On/+0v/+lsv/K0v9rgv97j//k5OS5ubmUlJRdXV3IyMhmZmY5OTgwMDCqqqqFhYUTExMlUf8aFgsCAAAL8klEQVR4nN1di3KjOgwNsQ0kMXCBtjzK+xG622673f7/v11IkwaDTYA4DzgzO7PTEKJjWbIsybBYUvHnZXHHePlDl3pB++PDr1uLewq/HvqSeb5rtXzj5bkXmYfftxa0H363ldMi8/p2ayn74u31FJn7tnwSLT/QIDMFczmiaTgkmefHW8s3DI/PbDKvE+NSsnllkXmfHJeSzTudzMcEuZRsPmhk/k3K9o94+Uch8/fWUo3F3zaZ51vLNB7PTTJPkzSYbzw+NchMJoih4Y0k8zRhxZSq+ayTefjv1vKch/8eamQm68kO+Hsk8zRxxZSqefohM5HtWBd+H8hMXzF71VRkPm8tCQ98fpP5uPtcTB/8+tiRmd4uhoZqZ7OYySzbzbPF8n0G5l/hv/eSzNOtpeCFp5LMhGN/Es8lmVn4sgq/loup7pbbePm3+Li1DPzwsXi4tQj88LCYjf2XHmAx+a3MEX8Xs3FmpTtbTDqTQeJtMRvPXPrmeZFZ3VoEfrgHKkZk3loEbjCcLzgdNpu1ruvrDePTVSoLSsb69J6w0Q0ziOI4SbLUwtRLsIME4OtXFmwwNkYeJQ5UFVkSJVlBBXX4c0UQBDW8tnDDgIPM1SQJAuEbUHLWlMvWiVR+KMdXl68/NlZWeAgdiJQQ7YA6zXShugiI9Dl4Tax0Iw/SrDSJEnEWpYGFy+EPI9cnmJRctjn9Fpa6+1xKrit5EziI3a2teZ4AdignlKfZvuMWvgehQADaDC6LSN6zja4pOwmcbbVK/hJ1oQ+smpBS1o0StP8m6qWbgLun2ARbWQRtkZmADlMG/0eHksbS3hGFomRcqeiR8IX6E9nJGTMXRe84JkD18871Ri/KJUkzOFIJNHWATg5kmPfz6jeDimPR/Pf+p12xZNxDfz2xMZ3hVCoyLBFXHnk7pMYMJ70KKy4lGYsTFxx5AyfYfsS3zEjSa46N6lLZ4GBbcRGAzWmamS4aoZbdgDMjSRs2r5XduuHoGBuGmacu+B5G4LPn4RDk27FcyvFkzfRti4wgHixsY6Wx6xaFs7WRuP9p4PCgsgrsUVPsG9AP6LfdhWYN5t9msQlc35NEhBCsrVyAS6iQCu0xHADgJVS3myqUayvVWK6HKMsvZC6/AxBIY6fYQULo0fzQPjYjBXbwItUoTEogDpvS/Os8Kjs6MmX11imDVFpYJNPHDtjnczHl87kITUe1w9ptG00Julo6l9++wG0HOg5S0QzSVgFlnrGhnj3LqpiIEyQ/b2S3DG2AMQLvXC6b+Ezbr6PccZJs1hl1ntGhMhx8f+S8JtkOyG4IZNm9xwpq5y7/2OU2yb4l8silYp2Jfb+qnKuYTcRTLzs2ICJ+wXB6jpbUdoYDYXKdZDuABptU6DXRoHCuK1tnfJYYko1Assn6jBcQz7b+sN+oDWUDCLvZuKfNBkgRQ8Te2MQXUIxQTRlimDcnnQxgb4l6wxi9hTnFxiMnTcEKYA6XR+dSWSxiSoTOjQ2xesYaWzkAbs+2l1L9Q7JjQ9lopICBz3IDkhfzyP1ZHCJ/JlCDjeXQ2AAJuBzUUqLvcjYOjVhg014FoCjZCb18MBjri1nMXlZi9dTJfACSVeAnqcWrqJZfmEy5htUyAwYRcaIiskys8yuHJ8e1DMmKqirlP1WVur3oMDbomFPP69s04Bucy/o//kUSizi1QhyaVp4mtqQq3Naf0nC+pV4TswxuOdfS8IELihsbKiNwBQj4+G2gbs3q9pi4HfQ5kwngYZRoeyIr9j1aYWk4kJyEOjnLBGBzJpPtJWUm8fPYYaS3aAAIQkidnkD6cgOfrMHxJpPAE2Sq5Hxii/3oIM2N46Tw6exFhfwz92l2WJHFrh3eOo99RsaOlNYJqrvgPLP7ZDAQZwewOSgeOp0L18aKvZPyAe2wTVxZSQ9dSvTU9GjgwyIGT7W26LkrnQh8RPe4HcHp6cS1HPHtDfpZkYF3cpT03O/exYF62nwVnJyYYsB3zQx/wgvUo/SGk24BgefEkXUY7vzEogsQr9LlHtZP4lTudedc6LQcUDpm8aeClne7dGBz7l44kumZFV27nbZQFcAgPLAJOnWD6GVaHmR6FxLijvGGRVAuXGKxn7LruMtlSBmfOiyFDOxdFQ2YKUPol048kYB3cNHY7ciWyXw2l0ccHQDQevtJy2GkwKomrFUkH8ksLL9jonHrw9ijtllS+3cShAWdDdAsvdzlA/9o2RmTSkfn0EjgGpkBNV6DkZ6EflJqDRXHcdGpGYydGtnR4EhsjtMAFQO+xzIGKMKGm7JYPgDxKJCTcI5zWh7yPdxRNqxrhtiX18Fu6BiP5EhGHbQgY5/J5hhw7i6kV2dRwb//tFbLFId1eWCP6XZJp0vXIbxAZ3Bal2jYVzEzyid7rEKaaoDGe5VZVPFTbbAGzmKLGXaKfo2NQcvMVe0m3KF7tR8Y2k0UMaNOSQsPa7Ae064CF+k/39Zao4buyVeU5qs9kBCZWNdxmLu0TRC/zkUChDxDXT9mBTZVNsaukhs+ol7Bpz+uhXquGRZDN+UWs+BSVVslSWR8zKWlrA295muGu5hVOi7lqV3oME29SQclQ1MMOttsOjBwSeuPevlnRIxhbkcUq5RLnT7B9TKgGA/Wf8/eizok9xJEdtBqRgq84eFfMlg1Ku/g/wiizDgiy4g7PBoVtD5OXggJWdBw1QTDyIBLubIKZDlrTDZ7mEeT0kue6c2JRVqJBt9A1wboRrzARqYGctcIhOFhU9670a/jaBonBEQsiEacdc16N/tKlz4W3Gg6HHEGEW97mo102UlWISWXCvbBPiasnm2Ll55kiypzREz6EWazivp04DU7Ny+DgDxKBXxmejNzEmpPaK+I8xJZjDY2CelcRdYWPZKQqGoBxUWEp9ujxCF5xjNgNmISlqHuUlP005b5qbZy3tVlNpp92mJC/eV9EwSS3bZZRd1OAHlXeyJAq7kVuTS7yX9Up0VNtnpnbQlyL2F0wGjOkvZBmBLrn6tgWzmYfupnz+UCWT828uYqLjqUsYyPTlzyo4blYIfFBqDouo+MiZqtp8iOWhfh2lSCwG24acxq9oW8C5insE6aiVQI2hWhrHYRgM2TMiG9wAwdjgfJ+wE7zWUcQKe1RJINcE26lkjVDXDyaz93hhIvQtic7I3jcPKWNByTPtOgApMrP6zFaCeOgOKYBB2j4ShE0SI+DxllKCB9laHDNd2ASTtVLWbhUYh2nzX4ygjlmMyiLFS1KLyiJ7AoIRaQQRKYWN+s1npIOzmkuERTb8juZQCyFjMegnQJmLSyHRAlzY2zKEt86koi+kTsaXT0pABJoMfdF4FBX8cBkmRZZrUBIZDktQFfRx2Ng6UVXo3MAscjHqIBkOZGtaZ+q+sgE7qim9ZTeUQ2HEDBL5IsyC3TMEIz9SFrroGBpeDzsLJ6tb9S+Oyef2T7vm3bAvSBTD0u83XVmLM0nGLM81p2ou4BpWgTZtqXItUJlZb3JV6mbNaBTcYq4fUDgt8bBBwkW1FVFHkHFTpxfuWQc4fQGX+qATT6pPXQNM0wvHq0WUPko1HaAcC+YNViLIzEHk4HiN61Q8qesGJ/oO0grwju9imTVrylNyZQtVIdUrz9s//YWJuBC6kLRkspKhnU3CewmW1VufPgBRAVyUnNu3/yZ4U1DtPCU1SpvccHEMmq7LlBiO/WVlpYrbEZxA5Sv77U7zVQUar/A7/I8lBf38PThwdDx2aeRlkURWmQcz0z2guTHDM6VvN6LPisyMzqUfqzesnBrF4/MasXg8zqlS2zepnOrF5zNKsXUM3r1WBPM4nOVtVL2z7m8jq9j7m96HBer6Cc1ctB5zHPPuf4Qt1Zvep4BqqpvYR6Vq8Hn9eL25efk15rHj+XdTLLSec13pYkmacJq+bxqUFmyjuB52WTzHQ92t9lm8xU988v/yhklh+TNJvHjyWNzPJ9gmwe35d0MhPc2VS7GAaZ5fPE2Dw+L9lkls+T8gIvJJcmmeWfCbF5+bPsJrN8nUxg8/balL1FZvkwka3a74eW6G0y0zCcprkwySwf7j5f86utFhaZe/cDLcvf438C/sonuJurOQAAAABJRU5ErkJggg==', recommendationId: 'tool-045' }, // Added Qwen
            { id: 'tool-062', name: 'Seeart', description: {it: 'Specializzata in immagini, video, animazioni e audio.', en: 'Specialized in images, videos, animations and audio.'}, category: 'Immagini', country: 'Cina', website: 'https://www.seaart.ai/it', isFeatured: false, logoUrl: 'https://play-lh.googleusercontent.com/BvytlaOWWEOrY0-VNThXm8xATNKZ_Vk_HgwSFXptkt3RRWgd9TF0J6JDED1bFlKyWkg', recommendationId: 'tool-014' }, // Added Seeart
            { id: 'tool-049', name: 'Copilot', description: {it: 'Specializzata in testi e ricerca web.', en: 'Specialized in text and web search.'}, category: 'Testo', country: 'USA', website: 'https://copilot.microsoft.com/chats/vAMUc1DGwXp5uX9uitvjF', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQwqfCxHw2QW6DxEKqDayMoJTz4lrvE_nnurxpmg2mEmGAkOzjGmsVpKfwT6epVYInsAuc&usqp=CAU', recommendationId: 'tool-024' }, // Added Copilot
            { id: 'tool-050', name: 'ElevenLabs', description: {it: 'Genera voci realistiche e discorsi in diverse lingue.', en: 'Generates realistic voices and speech in various languages.'}, category: 'Audio', country: 'USA', website: 'https://elevenlabs.io/', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRKCGpOyiMcA838kNKXU4F26nVO1cu0ZfiKhCLrlpHebMQ8fRsAb2hD8iMZNPqjM3leyj4&usqp=CAU' }, // Added ElevenLabs
            { id: 'tool-014', name: 'FLUX', description: {it: 'Genera immagini, video e animazioni da prompt testuali e immagini.', en: 'Generates images, videos, and animations from text prompts and images.'}, category: 'Immagini', country: 'Cina', website: 'https://playground.bfl.ai/image/generate', isFeatured: false, logoUrl: 'https://kodexolabs.com/wp-content/uploads/2025/01/Flux.1.webp', recommendationId: 'tool-005' }, 
            { id: 'tool-015', name: 'Swap AI', description: {it: 'Esegue il "face swap" (scambio di volti) in immagini e video in modo realistico.', en: 'Performs realistic "face swap" in images and videos.'}, category: 'Immagini', country: 'USA', website: 'https://aifaceswap.io/', isFeatured: false, logoUrl: 'https://www.toolpilot.ai/cdn/shop/files/aifaceswap-l.jpg?v=1733037433', recommendationId: 'tool-016' }, 
            { id: 'tool-016', name: 'Inpaint AI', description: {it: 'Rimuove oggetti, persone o imperfezioni indesiderate dalle foto con un solo click.', en: 'Removes unwanted objects, people, or imperfections from photos with a single click.'}, category: 'Immagini', country: 'USA', website: 'https://theinpaint.com/', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ2CWmq3U9nnd7RqhhfyqjL-w6Lj-JUf1D9ow&s', recommendationId: 'tool-017' }, 
            { id: 'tool-017', name: 'Pixel Cut AI', description: {it: "Espande i bordi delle immagini (outpainting) per cambiare formato o stile.", en: 'Expands image borders (outpainting) to change format or style.'}, category: 'Immagini', country: 'USA', website: 'https://www.pixelcut.ai/t/uncrop', isFeatured: false, logoUrl: 'https://templateshake.com/wp-content/uploads/2021/09/Pixelcut_-AI-Graphic-Designer.png', recommendationId: 'tool-033' }, 
            { id: 'tool-041', name: 'Leonardo AI', description: {it: 'Piattaforma per la generazione di asset visivi di alta qualità, da concept art a texture per giochi.', en: 'Platform for generating high-quality visual assets, from concept art to game textures.'}, category: 'Immagini', country: 'USA', website: 'https://leonardo.ai/', isFeatured: false, logoUrl: 'https://yt3.googleusercontent.com/a04AUXisIIWkI-Pj5zORQTiDNS9tALLmPc8pxuRT_aEHrCOUDsPQoLuh4QRbfgICortk7tBhyg=s900-c-k-c0x00ffffff-no-rj', recommendationId: 'tool-014' }, 
            { id: 'tool-042', name: 'Midjourney', description: {it: 'Genera immagini artistiche e fotorealistiche di alta qualità da prompt testuali tramite Discord.', en: 'Generates high-quality artistic and fotorealistic images from text prompts via Discord.'}, category: 'Immagini', country: 'USA', website: 'https://www.midjourney.com/home', isFeatured: false, logoUrl: 'https://sadesign.ai/pictures/picfullsizes/2024/12/10/dsn1733795303.jpg', recommendationId: 'tool-041' }, 
            { id: 'tool-005', name: 'Whisk', description: {it: 'Genera immagini, video e animazioni da prompt testuali e immagini.', en: 'Generates images, videos, and animations from text prompts and images.'}, category: 'Immagini', country: 'USA', website: 'https://labs.google/fx/tools/whisk', isFeatured: false, logoUrl: 'https://artsology.com/blog/wp-content/uploads/2025/01/Iconic-Banksy-in-Manila-2025-01-17T161547.202.png' }, 
            { id: 'tool-034', name: 'Kling', description: {it: 'Genera video di alta qualità da prompt testuali, concentrandosi sul realismo e sul movimento complesso.', en: 'Generates high-quality videos from text prompts, focusing on realism and complex motion.'}, category: 'Video', country: 'Cina', website: 'https://klingai.com/global/', isFeatured: false, logoUrl: 'https://play-lh.googleusercontent.com/JOfjXqsShK8j1aGBc1xlHBnatoRKRwLsGuoFZUAvKksaEPvK71eLwSg4FbKlky9Es-s', recommendationId: 'tool-035' }, 
            { id: 'tool-035', name: 'Veo', description: {it: "Il modello di generazione video più capace di Google, che crea video realistici e di alta qualità da prompt di testo e immagini.", en: "Google's most capable video generation model, creating realistic, high-quality videos from text and image prompts."}, category: 'Video', country: 'USA', website: 'https://deepmind.google/models/veo/', isFeatured: false, logoUrl: 'https://storage.googleapis.com/gweb-uniblog-publish-prod/images/IO25_Gemini_MOD_v33_PART_1_DG_FINAL_54.max-1440x810.png', isFeatured: false, recommendationId: 'tool-seedance' }, 
            { id: 'tool-021', name: 'Claude', description: {it: 'Specializzato in codice e creazione di applicazioni web. Può anche scrivere testi e ricercare informazioni sul web.', en: 'Specialized in code and web app creation. Can also write text and search for information on the web.'}, category: 'Codice', country: 'USA', website: 'https://claude.ai/new', isFeatured: true, logoUrl: 'https://logo.svgcdn.com/l/claude-icon-8x.png', recommendationId: 'tool-022' }, 
            { id: 'tool-022', name: 'Gamma AI', description: {it: "Genera presentazioni, documenti e pagine web statiche partendo da un'idea.", en: 'Generates presentations, documents, and static web pages from an idea.'}, category: 'Presentazioni', country: 'USA', website: 'https://gamma.app/', isFeatured: false, logoUrl: 'https://www.fahimai.com/wp-content/uploads/2025/03/GAMMA-cta.png', recommendationId: 'tool-021' }, 
            { id: 'tool-023', name: 'Napkin AI', description: {it: 'Converte dati testuali e concetti in grafici statici e diagrammi chiari.', en: 'Converts text data and concepts into clear static charts and diagrams.'}, category: 'Presentazioni', country: 'USA', website: 'https://www.napkin.ai/', isFeatured: false, logoUrl: 'https://media.licdn.com/dms/image/v2/D560BAQEYfmQKrdByPg/company-logo_200_200/company-logo_200_200/0/1723039432148/napkin_ai_logo?e=2147483647&v=beta&t=Nsr22RG3uiy9usBNh55leGVf8ES5YJQwUANW-2N7yEA', recommendationId: 'tool-022' }, 
            { id: 'tool-024', name: 'Google AI Studio', description: {it: "Crea app, siti e prototipi basati sui modelli Gemini di Google.", en: "Creates apps, sites, and prototypes based on Google's Gemini models."}, category: 'Codice', country: 'USA', website: 'https://aistudio.google.com/prompts/new_chat', isFeatured: true, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRanTHTxbnByd8heqLVawRfT24UAfvkyxTO5WskXGtfX7q5dMix9XKe8hzeXv8oq1U9gAE&usqp=CAU', recommendationId: 'tool-001' }, 
            { 
                id: 'tool-025', 
                name: 'Manus', 
                description: {it: 'Piattaforma di AI estremamente potente. Può eseguire compiti come ChatGPT e gestirli in background, creando testi, ricerche, presentazioni, video, immagini e molto altro.', en: 'Extremely powerful AI platform. It can perform tasks like ChatGPT and manage them in the background, creating text, research, presentations, videos, images and much more.'}, category: 'Codice', country: 'Cina', website: 'https://manus.im/app', isFeatured: true, logoUrl: 'https://manus.im/icon.png?cf131ec9640e9d99' },
            { 
                id: 'tool-043', 
                name: 'Rows', 
                description: { 
                    it: 'Specializzata in Excel, svolge il ruolo di analista dati utilizzando l\'AI direttamente dentro al foglio di Excel.', 
                    en: 'Specialized in Excel, acts as a data analyst using AI directly within the Excel sheet.' 
                }, 
                category: 'Testo', 
                country: 'Europe', 
                website: 'https://rows.com/ai', 
                isFeatured: false, 
                logoUrl: 'https://images.genai.works/Screenshot_16_5b63d7dfa1.jpg', 
                recommendationId: 'tool-049' 
            },
            { id: 'tool-047', name: 'Mistral', description: {it: 'Specializzata nella programmazione e nei testi.', en: 'Specialized in coding and text.'}, category: 'Codice', country: 'Europe', website: 'https://mistral.ai/', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTJ-GF4yjk576hl_W3Z_JY3tVSKBkGHhXFfMA&s', recommendationId: 'tool-001' }, // Added Mistral
            { id: 'tool-048', name: 'bolt', description: {it: 'Specializzata nella programmazione e nei testi.', en: 'Specialized in coding and text.'}, category: 'Codice', country: 'USA', website: 'https://bolt.new/', isFeatured: false, logoUrl: 'https://cdn-1.webcatalog.io/catalog/bolt-new/bolt-new-icon-filled-256.png?v=1730692903154', recommendationId: 'tool-052' }, // Added bolt
            { id: 'tool-049', name: 'Copilot', description: {it: 'Specializzata in testi e ricerca web.', en: 'Specialized in text and web search.'}, category: 'Testo', country: 'USA', website: 'https://copilot.microsoft.com/chats/vAMUc1DGwXp5uX9uitvjF', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQwqfCxHw2QW6DxEKqDayMoJTz4lrvE_nnurxpmg2mEmGAkOzjGmsVpKfwT6epVYInsAuc&usqp=CAU', recommendationId: 'tool-024' }, // Added Copilot
            { id: 'tool-050', name: 'ElevenLabs', description: {it: 'Genera voci realistiche e discorsi in diverse lingue.', en: 'Generates realistic voices and speech in various languages.'}, category: 'Audio', country: 'USA', website: 'https://elevenlabs.io/', isFeatured: false, logoUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcBAMAAACAI8KnAAAAFVBMVEX///+ZmZkZGRlZWVmRkZEAAABGRkb6Me63AAAAHElEQVR4AWMYUCBkwKyIxHVNYAsZVFyEIwcSAADWIQrDIppSoAAAAABJRU5ErkJggg==' }, // Added ElevenLabs
            { id: 'tool-014', name: 'FLUX', description: {it: 'Genera immagini, video e animazioni da prompt testuali e immagini.', en: 'Generates images, videos, and animations from text prompts and images.'}, category: 'Immagini', country: 'Cina', website: 'https://playground.bfl.ai/image/generate', isFeatured: false, logoUrl: 'https://kodexolabs.com/wp-content/uploads/2025/01/Flux.1.webp', recommendationId: 'tool-005' }, 
            { id: 'tool-015', name: 'Swap AI', description: {it: 'Esegue il "face swap" (scambio di volti) in immagini e video in modo realistico.', en: 'Performs realistic "face swap" in images and videos.'}, category: 'Immagini', country: 'USA', website: 'https://aifaceswap.io/', isFeatured: false, logoUrl: 'https://www.toolpilot.ai/cdn/shop/files/aifaceswap-l.jpg?v=1733037433', recommendationId: 'tool-016' }, 
            { id: 'tool-016', name: 'Inpaint AI', description: {it: 'Rimuove oggetti, persone o imperfezioni indesiderate dalle foto con un solo click.', en: 'Removes unwanted objects, people, or imperfections from photos with a single click.'}, category: 'Immagini', country: 'USA', website: 'https://theinpaint.com/', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ2CWmq3U9nnd7RqhhfyqjL-w6Lj-JUf1D9ow&s', recommendationId: 'tool-017' }, 
            { id: 'tool-017', name: 'Pixel Cut AI', description: {it: "Espande i bordi delle immagini (outpainting) per cambiare formato o stile.", en: 'Expands image borders (outpainting) to change format or style.'}, category: 'Immagini', country: 'USA', website: 'https://www.pixelcut.ai/t/uncrop', isFeatured: false, logoUrl: 'https://templateshake.com/wp-content/uploads/2021/09/Pixelcut_-AI-Graphic-Designer.png', recommendationId: 'tool-033' }, 
            { id: 'tool-041', name: 'Leonardo AI', description: {it: 'Piattaforma per la generazione di asset visivi di alta qualità, da concept art a texture per giochi.', en: 'Platform for generating high-quality visual assets, from concept art to game textures.'}, category: 'Immagini', country: 'USA', website: 'https://leonardo.ai/', isFeatured: false, logoUrl: 'https://yt3.googleusercontent.com/a04AUXisIIWkI-Pj5zORQTiDNS9tALLmPc8pxuRT_aEHrCOUDsPQoLuh4QRbfgICortk7tBhyg=s900-c-k-c0x00ffffff-no-rj', recommendationId: 'tool-014' }, 
            { id: 'tool-042', name: 'Midjourney', description: {it: 'Genera immagini artistiche e fotorealistiche di alta qualità da prompt testuali tramite Discord.', en: 'Generates high-quality artistic and fotorealistic images from text prompts via Discord.'}, category: 'Immagini', country: 'USA', website: 'https://www.midjourney.com/home', isFeatured: false, logoUrl: 'https://sadesign.ai/pictures/picfullsizes/2024/12/10/dsn1733795303.jpg', recommendationId: 'tool-041' }, 
            { id: 'tool-005', name: 'Whisk', description: {it: 'Genera immagini, video e animazioni da prompt testuali e immagini.', en: 'Generates images, videos, and animations from text prompts and images.'}, category: 'Immagini', country: 'USA', website: 'https://labs.google/fx/tools/whisk', isFeatured: false, logoUrl: 'https://artsology.com/blog/wp-content/uploads/2025/01/Iconic-Banksy-in-Manila-2025-01-17T161547.202.png' }, 
            { id: 'tool-034', name: 'Kling', description: {it: 'Genera video di alta qualità da prompt testuali, concentrandosi sul realismo e sul movimento complesso.', en: 'Generates high-quality videos from text prompts, focusing on realism and complex motion.'}, category: 'Video', country: 'Cina', website: 'https://klingai.com/global/', isFeatured: false, logoUrl: 'https://play-lh.googleusercontent.com/JOfjXqsShK8j1aGBc1xlHBnatoRKRwLsGuoFZUAvKksaEPvK71eLwSg4FbKlky9Es-s', recommendationId: 'tool-035' }, 
            { id: 'tool-035', name: 'Veo', description: {it: "Il modello di generazione video più capace di Google, che crea video realistici e di alta qualità da prompt di testo e immagini.", en: "Google's most capable video generation model, creating realistic, high-quality videos from text and image prompts."}, category: 'Video', country: 'USA', website: 'https://deepmind.google/models/veo/', isFeatured: false, logoUrl: 'https://storage.googleapis.com/gweb-uniblog-publish-prod/images/IO25_Gemini_MOD_v33_PART_1_DG_FINAL_54.max-1440x810.png', isFeatured: false, recommendationId: 'tool-seedance' }, 
            { id: 'tool-021', name: 'Claude', description: {it: 'Specializzato in codice e creazione di applicazioni web. Può anche scrivere testi e ricercare informazioni sul web.', en: 'Specialized in code and web app creation. Can also write text and search for information on the web.'}, category: 'Codice', country: 'USA', website: 'https://claude.ai/new', isFeatured: true, logoUrl: 'https://logo.svgcdn.com/l/claude-icon-8x.png', recommendationId: 'tool-022' }, 
            { id: 'tool-022', name: 'Gamma AI', description: {it: "Genera presentazioni, documenti e pagine web statiche partendo da un'idea.", en: 'Generates presentations, documents, and static web pages from an idea.'}, category: 'Presentazioni', country: 'USA', website: 'https://gamma.app/', isFeatured: false, logoUrl: 'https://www.fahimai.com/wp-content/uploads/2025/03/GAMMA-cta.png', recommendationId: 'tool-021' }, 
            { id: 'tool-023', name: 'Napkin AI', description: {it: 'Converte dati testuali e concetti in grafici statici e diagrammi chiari.', en: 'Converts text data and concepts into clear static charts and diagrams.'}, category: 'Presentazioni', country: 'USA', website: 'https://www.napkin.ai/', isFeatured: false, logoUrl: 'https://media.licdn.com/dms/image/v2/D560BAQEYfmQKrdByPg/company-logo_200_200/company-logo_200_200/0/1723039432148/napkin_ai_logo?e=2147483647&v=beta&t=Nsr22RG3uiy9usBNh55leGVf8ES5YJQwUANW-2N7yEA', recommendationId: 'tool-022' }, 
            { id: 'tool-024', name: 'Google AI Studio', description: {it: "Crea app, siti e prototipi basati sui modelli Gemini di Google.", en: "Creates apps, sites, and prototypes based on Google's Gemini models."}, category: 'Codice', country: 'USA', website: 'https://aistudio.google.com/prompts/new_chat', isFeatured: true, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRanTHTxbnByd8heqLVawRfT24UAfvkyxTO5WskXGtfX7q5dMix9XKe8hzeXv8oq1U9gAE&usqp=CAU', recommendationId: 'tool-001' }, 
            { 
                id: 'tool-025', 
                name: 'Manus', 
                description: {it: 'Piattaforma di AI estremamente potente. Può eseguire compiti come ChatGPT e gestirli in background, creando testi, ricerche, presentazioni, video, immagini e molto altro.', en: 'Extremely powerful AI platform. It can perform tasks like ChatGPT and manage them in the background, creating text, research, presentations, videos, images and much more.'}, category: 'Codice', country: 'Cina', website: 'https://manus.im/app', isFeatured: true, logoUrl: 'https://manus.im/icon.png?cf131ec9640e9d99' },
            { 
                id: 'tool-043', 
                name: 'Rows', 
                description: { 
                    it: 'Specializzata in Excel, svolge il ruolo di analista dati utilizzando l\'AI direttamente dentro al foglio di Excel.', 
                    en: 'Specialized in Excel, acts as a data analyst using AI directly within the Excel sheet.' 
                }, 
                category: 'Testo', 
                country: 'Europe', 
                website: 'https://rows.com/ai', 
                isFeatured: false, 
                logoUrl: 'https://images.genai.works/Screenshot_16_5b63d7dfa1.jpg', 
                recommendationId: 'tool-049' 
            },
            { id: 'tool-047', name: 'Mistral', description: {it: 'Specializzata nella programmazione e nei testi.', en: 'Specialized in coding and text.'}, category: 'Codice', country: 'Europe', website: 'https://mistral.ai/', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTJ-GF4yjk576hl_W3Z_JY3tVSKBkGHhXFfMA&s', recommendationId: 'tool-001' }, // Added Mistral
            { id: 'tool-048', name: 'bolt', description: {it: 'Specializzata nella programmazione e nei testi.', en: 'Specialized in coding and text.'}, category: 'Codice', country: 'USA', website: 'https://bolt.new/', isFeatured: false, logoUrl: 'https://cdn-1.webcatalog.io/catalog/bolt-new/bolt-new-icon-filled-256.png?v=1730692903154', recommendationId: 'tool-052' }, // Added bolt
            { id: 'tool-049', name: 'Copilot', description: {it: 'Specializzata in testi e ricerca web.', en: 'Specialized in text and web search.'}, category: 'Testo', country: 'USA', website: 'https://copilot.microsoft.com/chats/vAMUc1DGwXp5uX9uitvjF', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQwqfCxHw2QW6DxEKqDayMoJTz4lrvE_nnurxpmg2mEmGAkOzjGmsVpKfwT6epVYInsAuc&usqp=CAU', recommendationId: 'tool-024' }, // Added Copilot
            { id: 'tool-050', name: 'ElevenLabs', description: {it: 'Genera voci realistiche e discorsi in diverse lingue.', en: 'Generates realistic voices and speech in various languages.'}, category: 'Audio', country: 'USA', website: 'https://elevenlabs.io/', isFeatured: false, logoUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcBAMAAACAI8KnAAAAFVBMVEX///+ZmZkZGRlZWVmRkZEAAABGRkb6Me63AAAAHElEQVR4AWMYUCBkwKyIxHVNYAsZVFyEIwcSAADWIQrDIppSoAAAAABJRU5ErkJggg==' }, // Added ElevenLabs
            { id: 'tool-052', name: 'Cursor', description: {it: 'Un editor di codice potenziato dall\'AI per una programmazione più veloce.', en: 'An AI-powered code editor for faster programming.'}, category: 'Codice', country: 'USA', website: 'https://cursor.com/', isFeatured: false, logoUrl: 'https://paulstamatiou.com/_next/image?url=%2Fgear%2Fcursor-app-icon.png&w=3840&q=75', recommendationId: 'tool-053' }, // Added Lovable
            { id: 'tool-053', name: 'Lovable', description: {it: 'AI per la programmazione e sviluppo di codice.', en: 'AI for coding and software development.'}, category: 'Codice', country: 'USA', website: 'https://lovable.dev/', isFeatured: false, logoUrl: 'https://miro.medium.com/v2/resize:fit:1400/1*8oWCX9tq3LPGxXqs7TRicg.png', recommendationId: 'tool-052' }, // Lovable
            { id: 'tool-054', name: 'Ideogram', description: {it: 'AI per la generazione di immagini creative e artistiche.', en: 'AI for creative and artistic image generation.'}, category: 'Immagini', country: 'USA', website: 'https://ideogram.ai/t/explore', isFeatured: false, logoUrl: 'https://www.fahimai.com/wp-content/uploads/2024/03/CTA-4.png', recommendationId: 'tool-056' }, // Ideogram
            { id: 'tool-055', name: 'Sora', description: {it: 'AI per la generazione di video avanzati da prompt testuali.', en: 'AI for advanced video generation from text prompts.'}, category: 'Video', country: 'USA', website: 'https://openai.com/sora/', isFeatured: false, logoUrl: 'https://whatisai.sirv.com/WP_whatisai.co.uk/2024/12/openai-sora-logo.webp', recommendationId: 'tool-034' }, // Sora
            { id: 'tool-056', name: 'Firefly', description: {it: 'AI di Adobe per la generazione di immagini creative.', en: 'Adobe AI for creative image generation.'}, category: 'Immagini', country: 'USA', website: 'https://www.adobe.com/it/products/firefly.html', isFeatured: false, logoUrl: 'https://www.graphiland.it/34712-large_default/adobe-firefly-standard-for-teams-abbonamento-12-mesi-italiano.jpg', recommendationId: 'tool-054' }, // Firefly
            { id: 'tool-057', name: 'Jules', description: {it: 'AI di Google per la programmazione e assistenza nello sviluppo di codice.', en: 'Google AI for coding and development assistance.'}, category: 'Codice', country: 'USA', website: 'https://jules.google/', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQvAXEz4EsU3RQHCV96BAfJusei09ZBjQOG2g&s', recommendationId: 'tool-047' }, // Jules
            { id: 'tool-058', name: 'V0', description: {it: 'AI per la generazione di codice e prototipi da prompt testuali.', en: 'AI for code and prototype generation from text prompts.'}, category: 'Codice', country: 'USA', website: 'https://v0.dev/', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTMM_gwto8EzGwGDX6ACnaEr1nCZtLf5tcwjkIFkpsXDPZI6s5hp5RpUH0rga2Im4gHGBU&usqp=CAU', recommendationId: 'tool-053' }, // V0
            { id: 'tool-059', name: 'Convex', description: {it: 'AI per la generazione di codice e automazione tramite Chef.', en: 'AI for code generation and automation via Chef.'}, category: 'Codice', country: 'USA', website: 'https://chef.convex.dev//', isFeatured: false, logoUrl: 'https://chef.convex.dev/chef.svg', recommendationId: 'tool-052' }, // Convex
            { id: 'tool-060', name: 'Krea', description: {it: 'AI per la generazione di immagini e creatività visiva.', en: 'AI for image generation and visual creativity.'}, category: 'Immagini', country: 'USA', website: 'https://www.krea.ai/', isFeatured: false, logoUrl: 'https://aithirst.com/wp-content/uploads/2022/11/krealogo.png', recommendationId: 'tool-014' }, // Krea
            { id: 'tool-061', name: 'Gemini', description: {it: "L'alternativa naturale a ChatGPT per la generazione di testo.", en: "The natural alternative to ChatGPT for text generation."}, category: 'Testo', country: 'USA', website: 'https://gemini.google.com/app?hl=it', isFeatured: false, logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcThr7qrIazsvZwJuw-uZCtLzIjaAyVW_ZrlEQ&s', recommendationId: 'tool-001' }, // Gemini
            { id: 'tool-034', name: 'Kling', description: {it: 'Genera video di alta qualità da prompt testuali, concentrandosi sul realismo e sul movimento complesso.', en: 'Generates high-quality videos from text prompts, focusing on realism and complex motion.'}, category: 'Video', country: 'Cina', website: 'https://klingai.com/global/', isFeatured: false, logoUrl: 'https://play-lh.googleusercontent.com/JOfjXqsShK8j1aGBc1xlHBnatoRKRwLsGuoFZUAvKksaEPvK71eLwSg4FbKlky9Es-s', recommendationId: 'tool-035' }, 
            { id: 'tool-seedance', name: 'Seedance', description: {it: 'AI cinese specializzata nella creazione di video, alternativa a Veo3.', en: 'Chinese AI specialized in video creation, alternative to Veo3.'}, category: 'Video', country: 'Cina', website: 'https://seedance.net/seedance', isFeatured: false, logoUrl: 'https://seedance.net/logo.png', recommendationId: 'tool-035' }, // Seedance
            { id: 'tool-heygen', name: 'HeyGen', description: {it: 'AI americana specializzata nella creazione di avatar virtuali e video.', en: 'American AI specialized in virtual avatar and video creation.'}, category: 'Video', country: 'USA', website: 'https://www.heygen.com', isFeatured: false, logoUrl: 'https://img.icons8.com/fluent/512/heygen.png', recommendationId: 'tool-034' }, // HeyGen
            { id: 'tool-genspark', name: 'GenSpark', description: {it: 'AI americana alternativa a Manus; può scrivere testi, fare ricerche web, creare presentazioni e siti web.', en: 'American AI alternative to Manus; can write text, perform web searches, create presentations and websites.'}, category: 'Codice', country: 'USA', website: 'https://www.genspark.ai', isFeatured: false, logoUrl: 'https://pbs.twimg.com/profile_images/1782715833099382784/R6nadR8G_400x400.jpg', recommendationId: 'tool-suna' }, // GenSpark
            { id: 'tool-suna', name: 'Suna', description: {it: "L'alternativa a Manus specializzata in ricerche web, programmazione, presentazioni e testi", en: 'European AI recommended as an alternative to Manus and Genspark; can write text, perform web searches, create presentations and websites.'}, category: 'Codice', country: 'Europe', website: 'https://www.suna.so', isFeatured: false, logoUrl: 'https://pbs.twimg.com/profile_images/1839883420782018560/pqz5Txwt_400x400.jpg', recommendationId: 'tool-genspark' }, // Suna
            { id: 'tool-dzine', name: 'Dzine', description: {it: "AI americana specializzata nell'editing grafico. Può generare e cambiare lo stile delle tue immagini.", en: 'American AI specialized in graphic editing. It can generate and change the style of your images.'}, category: 'Immagini', country: 'USA', website: 'https://www.dzine.ai/', isFeatured: false, logoUrl: 'https://apktodo.io/uploads/2025/3/dzine-ai-download.jpg', recommendationId: 'tool-056' }, // Dzine
            { id: 'tool-kimi', name: 'Kimi', description: {it: 'AI cinese specializzata nella programmazione e nello sviluppo di codice.', en: 'Chinese AI specialized in programming and code development.'}, category: 'Codice', country: 'Cina', website: 'https://www.kimi.com/', isFeatured: false, logoUrl: 'https://hdrobots.com/wp-content/uploads/2025/02/kimi-ai-logo.webp', recommendationId: 'tool-047' }, //
            { 
                id: 'tool-dende', 
                name: 'Dende', 
                description: {
                    it: 'Specializzata in creazione di appunti, mappe mentali, flashcards e piani di studio personalizzati.', 
                    en: 'Specialized in creating notes, mind maps, flashcards, and personalized study plans.'
                }, 
                category: 'Testo', 
                country: 'Europe', 
                website: 'https://dende.ai/it/', 
                isFeatured: false, 
                logoUrl: 'https://media.licdn.com/dms/image/v2/D4D0BAQH0sQKmhR7qCQ/company-logo_200_200/company-logo_200_200/0/1700736436872?e=2147483647&v=beta&t=1YbA2XVAeCHYbQjNbwqMQWMrhM2WIhUfeLg59-ubdGQ',
                recommendationId: 'tool-012' 
            },
            {
                id: 'tool-reve',
                name: 'Reve',
                description: {
                    it: 'Specializzata in creazione e animazione di video e immagini.',
                    en: 'Specialized in creating and animating videos and images.'
                },
                category: 'Video',
                country: 'USA',
                website: 'https://dreamore.com/',
                isFeatured: false,
                logoUrl: 'https://assets-global.website-files.com/653065a7828d1a33715c064e/653d9e79e6e4e73b22e9f456_LOGO%20BLACK%20(1).svg',
                recommendationId: 'tool-034'
            },
            {
                id: 'tool-z',
                name: 'Z',
                description: {
                    it: 'Specializzata in creazione di testi e immagini.',
                    en: 'Specialized in creating text and images.'
                },
                category: 'Testo',
                country: 'USA',
                website: 'https://z.com/',
                isFeatured: false,
                logoUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR6f0gA5q4J_yH2H_t8tJ3bYkFpG5eA2f7w&s',
                recommendationId: 'tool-001'
            },
        ];
        window.aiToolsData = aiToolsData;

        window.getLocalizedToolsData = (lang) => {
            return aiToolsData.map(tool => ({ ...tool, description: tool.description[lang] || tool.description['en'] }));
        }
        window.getAllToolsForCurrentUser = () => {
            return window.getLocalizedToolsData(currentLang);
        };

        window.openDetailModal = (toolId) => {
            const allTools = getAllToolsForCurrentUser();
            const tool = allTools.find(t => t.id === toolId);
            if (!tool) return;
            const t = translations[currentLang];
            
            let recommendationHTML = '';
            if (tool.recommendationId) {
                const recommendedTool = allTools.find(t => t.id === tool.recommendationId);
                if (recommendedTool) {
                    recommendationHTML = `<div class="recommendation-box" data-id="${recommendedTool.id}"><img src="${recommendedTool.logoUrl}" alt="${recommendedTool.name}" class="recommendation-logo" loading="lazy"><div class="recommendation-text">${t.alternativeSuggestion}<strong>${recommendedTool.name}</strong></div></div>`;
                }
            }
            
            const modalHTML = `<div id="detail-modal" class="modal-overlay visible"><div class="modal-content"><button class="modal-close-btn" data-action="close-modal">×</button><div id="detail-content"><h2>${tool.name}</h2><p>${tool.description}</p><div class="detail-tags"><span class="tag">🌍 ${tool.country || 'N/A'}</span><span class="tag">${tool.category || 'N/A'}</span></div><div class="detail-actions"><a href="${tool.website}" target="_blank" class="button" style="text-decoration: none; display: flex; justify-content: center; align-items: center;">${t.visitWebsite}</a></div>${recommendationHTML}</div></div></div>`;
            modalContainer.innerHTML = modalHTML;
            
            modalContainer.querySelector('.recommendation-box')?.addEventListener('click', (e) => {
                const newToolId = e.currentTarget.dataset.id;
                window.openDetailModal(newToolId);
            });
            modalContainer.querySelector('.modal-close-btn')?.addEventListener('click', closeModal);
            modalContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    closeModal();
                }
            });
        };

        const closeModal = () => {
            modalContainer.innerHTML = '';
        };

        // NUOVA FUNZIONE PER MODALE CONFERMA CANCELLAZIONE (da koda mobile.html)
        const openConfirmDeleteAllModal = () => {
            const t = translations[currentLang];
            const modalHTML = `
                <div id="confirm-delete-modal" class="modal-overlay visible">
                    <div class="modal-content" style="text-align: left; max-width: 400px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2);">
                        <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 16px; color: white;">${t.deleteAll}</h2>
                        <p style="color: rgba(255, 255, 255, 0.7); line-height: 1.5; margin-bottom: 24px;">${t.confirmDeleteAll}</p>
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button class="data-btn" data-action="close-modal">${t.cancel}</button>
                            <button class="data-btn delete" data-action="confirm-delete-all-chats">${t.deleteAll}</button>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
        };

        const unmountReactApp = () => {
            if (reactRoot) {
                reactRoot.unmount();
                reactRoot = null;
            }
        };

        const getStorageKey = () => `koda_landing_conversations`;
        const getActiveIdKey = () => `koda_landing_active_id`;

        // Funzione per ottenere l'ID utente corrente
        const getCurrentUserId = () => {
            const user = window.firebaseAuth?.currentUser;
            return user ? user.uid : null;
        };

        // Funzione per ottenere la chiave di storage basata sull'utente
        const getUserStorageKey = () => {
            const userId = getCurrentUserId();
            return userId ? `koda_conversations_${userId}` : getStorageKey();
        };

        const getUserActiveIdKey = () => {
            const userId = getCurrentUserId();
            return userId ? `koda_active_id_${userId}` : getActiveIdKey();
        };

        const loadConversations = async () => {
            const userId = getCurrentUserId();
            
            if (userId) {
                // Utente autenticato: carica da Firebase
                try {
                    const { collection, query, where, orderBy, getDocs, doc, getDoc } = window.firebaseServices;
                    
                    // Carica le conversazioni da Firestore
                    const conversationsRef = collection(window.firebaseDb, 'conversations');
                    const q = query(
                        conversationsRef, 
                        where('userId', '==', userId),
                        orderBy('timestamp', 'desc')
                    );
                    
                    const querySnapshot = await getDocs(q);
                    conversations = {};
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        conversations[doc.id] = {
                            id: doc.id,
                            title: data.title,
                            messages: data.messages || [],
                            timestamp: data.timestamp?.toDate?.() || data.timestamp || Date.now(),
                            lastUpdated: data.lastUpdated?.toDate?.() || data.lastUpdated || Date.now()
                        };
                    });

                    // Carica l'ID della conversazione attiva
                    const userDocRef = doc(window.firebaseDb, 'userSettings', userId);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        activeConversationId = userData.activeConversationId && conversations[userData.activeConversationId] 
                            ? userData.activeConversationId 
                            : null;
                    } else {
                        activeConversationId = null;
                    }

                    console.log('🔥 Conversazioni caricate da Firebase:', Object.keys(conversations).length);
                } catch (error) {
                    console.error('❌ Errore nel caricamento delle conversazioni da Firebase:', error);
                    // Fallback al localStorage
                    loadFromLocalStorage();
                }
            } else {
                // Utente non autenticato: usa localStorage
                loadFromLocalStorage();
            }

            // Crea una nuova chat solo se necessario e se non siamo già in una chat
            if ((Object.keys(conversations).length === 0 || !activeConversationId) && !document.getElementById('chat-view-container')) {
                startNewChat(false);
            }
        };

        const loadFromLocalStorage = () => {
            const saved = localStorage.getItem(getStorageKey());
            conversations = saved ? JSON.parse(saved) : {};
            const savedActiveId = localStorage.getItem(getActiveIdKey());
            activeConversationId = savedActiveId && conversations[savedActiveId] ? savedActiveId : null;
        };

        const saveConversations = async (newConversations, newActiveId) => {
            // Aggiorna immediatamente lo stato locale per non bloccare l'UI
            conversations = newConversations;
            activeConversationId = newActiveId;
            
            const userId = getCurrentUserId();
            
            // Salva sempre nel localStorage come backup immediato
            saveToLocalStorage();
            
            if (userId) {
                // Utente autenticato: salva in Firebase in background
                try {
                    const { doc, setDoc, serverTimestamp } = window.firebaseServices;
                    
                    // Salva ogni conversazione in Firestore
                    const savePromises = Object.entries(conversations).map(async ([conversationId, conversation]) => {
                        const conversationRef = doc(window.firebaseDb, 'conversations', conversationId);
                        return setDoc(conversationRef, {
                            userId: userId,
                            title: conversation.title,
                            messages: conversation.messages,
                            timestamp: conversation.timestamp,
                            lastUpdated: serverTimestamp(),
                            createdAt: conversation.createdAt || serverTimestamp()
                        }, { merge: true });
                    });

                    // Salva l'ID della conversazione attiva nelle impostazioni utente
                    const userSettingsRef = doc(window.firebaseDb, 'userSettings', userId);
                    savePromises.push(setDoc(userSettingsRef, {
                        activeConversationId: activeConversationId,
                        lastUpdated: serverTimestamp()
                    }, { merge: true }));

                    // Esegui tutti i salvataggi in parallelo
                    await Promise.all(savePromises);

                    console.log('🔥 Conversazioni salvate in Firebase');
                    // Mostra un toast di conferma solo se è la prima volta che l'utente salva
                    if (!window.chatSavedNotificationShown) {
                        showToast('Le tue chat sono ora sincronizzate nel cloud! ☁️');
                        window.chatSavedNotificationShown = true;
                    }
                } catch (error) {
                    console.error('❌ Errore nel salvataggio delle conversazioni in Firebase:', error);
                    // Il localStorage è già stato salvato, quindi non perdiamo dati
                }
            }
        };

        const saveToLocalStorage = () => {
            localStorage.setItem(getStorageKey(), JSON.stringify(conversations));
            localStorage.setItem(getActiveIdKey(), activeConversationId);
        };

        // Funzione per eliminare una singola conversazione da Firebase
        const deleteConversationFromFirebase = async (conversationId) => {
            const userId = getCurrentUserId();
            if (!userId) return;

            try {
                const { doc, deleteDoc } = window.firebaseServices;
                const conversationRef = doc(window.firebaseDb, 'conversations', conversationId);
                await deleteDoc(conversationRef);
                console.log('🔥 Conversazione eliminata da Firebase:', conversationId);
            } catch (error) {
                console.error('❌ Errore nell\'eliminazione della conversazione da Firebase:', error);
            }
        };

        // Funzione per eliminare tutte le conversazioni da Firebase
        const deleteAllConversationsFromFirebase = async () => {
            const userId = getCurrentUserId();
            if (!userId) {
                // Se non c'è utente autenticato, elimina solo dal localStorage
                localStorage.removeItem(getStorageKey());
                localStorage.removeItem(getActiveIdKey());
                return;
            }

            try {
                const { collection, query, where, getDocs, doc, deleteDoc } = window.firebaseServices;
                
                // Ottieni tutte le conversazioni dell'utente
                const conversationsRef = collection(window.firebaseDb, 'conversations');
                const q = query(conversationsRef, where('userId', '==', userId));
                const querySnapshot = await getDocs(q);
                
                // Elimina ogni conversazione
                const deletePromises = querySnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                
                // Elimina anche le impostazioni utente
                const userSettingsRef = doc(window.firebaseDb, 'userSettings', userId);
                await deleteDoc(userSettingsRef);
                
                console.log('🔥 Tutte le conversazioni eliminate da Firebase');
            } catch (error) {
                console.error('❌ Errore nell\'eliminazione di tutte le conversazioni da Firebase:', error);
                // Fallback: elimina dal localStorage
                localStorage.removeItem(getStorageKey());
                localStorage.removeItem(getActiveIdKey());
            }
        };

        // Funzione per migrare le conversazioni dal localStorage a Firebase
        const migrateConversationsToFirebase = async () => {
            const userId = getCurrentUserId();
            if (!userId) return;

            try {
                // Controlla se ci sono conversazioni nel localStorage
                const savedConversations = localStorage.getItem(getStorageKey());
                if (!savedConversations) return;

                const localConversations = JSON.parse(savedConversations);
                if (Object.keys(localConversations).length === 0) return;

                console.log('🔄 Migrazione conversazioni dal localStorage a Firebase...');

                const { doc, setDoc, serverTimestamp } = window.firebaseServices;
                
                // Migra ogni conversazione
                for (const [conversationId, conversation] of Object.entries(localConversations)) {
                    const conversationRef = doc(window.firebaseDb, 'conversations', conversationId);
                    await setDoc(conversationRef, {
                        userId: userId,
                        title: conversation.title,
                        messages: conversation.messages || [],
                        timestamp: conversation.timestamp || Date.now(),
                        lastUpdated: serverTimestamp(),
                        createdAt: conversation.createdAt || serverTimestamp(),
                        migrated: true
                    }, { merge: true });
                }

                // Migra anche l'ID della conversazione attiva
                const savedActiveId = localStorage.getItem(getActiveIdKey());
                if (savedActiveId && localConversations[savedActiveId]) {
                    const userSettingsRef = doc(window.firebaseDb, 'userSettings', userId);
                    await setDoc(userSettingsRef, {
                        activeConversationId: savedActiveId,
                        lastUpdated: serverTimestamp()
                    }, { merge: true });
                }

                // Pulisci il localStorage dopo la migrazione
                localStorage.removeItem(getStorageKey());
                localStorage.removeItem(getActiveIdKey());

                console.log('✅ Migrazione completata con successo');
                showToast('Le tue conversazioni sono state sincronizzate! 🔄');
            } catch (error) {
                console.error('❌ Errore nella migrazione delle conversazioni:', error);
            }
        };

        const startNewChat = async (remountApp = true) => {
            const newId = `chat-${Date.now()}`;
            const t = translations[currentLang];
            conversations[newId] = { 
                id: newId, 
                title: t.newChatTitle, 
                messages: [], 
                timestamp: Date.now(),
                createdAt: Date.now()
            };
            activeConversationId = newId;
            // Salva in background e continua immediatamente
            debouncedSave(conversations, activeConversationId);
            if (remountApp) {
                renderChatView();
            }
            toggleSideMenu(false);
        };

        const renderSideMenu = () => {
            const sortedConversations = Object.values(conversations).sort((a, b) => b.timestamp - a.timestamp);
            const userId = getCurrentUserId();
            const syncStatus = userId ? '☁️ Sincronizzato' : '📱 Solo locale';
            const savingIndicator = window.isSavingConversations ? '💾 Salvando...' : '';
            
            conversationListContainer.innerHTML = `
                <div class="text-xs text-gray-400 mb-2 px-3 py-1 bg-gray-800/50 rounded">
                    ${syncStatus} ${savingIndicator}
                </div>
                ${sortedConversations.map(conv => `
                    <button class="conversation-item ${conv.id === activeConversationId ? 'active' : ''}" data-action="select-conversation" data-id="${conv.id}">
                        ${conv.title}
                    </button>
                `).join('')}
            `;
            translatePage(currentLang);
        };
        
        // Rendi la funzione disponibile globalmente
        window.renderSideMenu = renderSideMenu;

        // Funzione di debounce per il salvataggio
        let saveTimeout = null;
        let isSaving = false;
        const debouncedSave = (conversations, activeId) => {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            
            // Mostra indicatore di salvataggio
            if (!isSaving) {
                isSaving = true;
                window.isSavingConversations = true;
                if (window.renderSideMenu) {
                    window.renderSideMenu();
                }
            }
            
            saveTimeout = setTimeout(() => {
                saveConversations(conversations, activeId).catch(error => {
                    console.error('Errore nel salvataggio delle conversazioni:', error);
                }).finally(() => {
                    // Nascondi indicatore di salvataggio
                    isSaving = false;
                    window.isSavingConversations = false;
                    if (window.renderSideMenu) {
                        window.renderSideMenu();
                    }
                });
            }, 1000); // Salva dopo 1 secondo di inattività
        };

        const toggleSideMenu = (show) => {
            if (show) {
                renderSideMenu();
                sideMenuOverlay.classList.add('visible');
                sideMenu.classList.add('visible');
                sideMenuOverlay.classList.remove('hidden');
                sideMenu.classList.remove('hidden');
            } else {
                sideMenuOverlay.classList.remove('visible');
                sideMenu.classList.remove('visible');
                sideMenuOverlay.classList.add('hidden');
                sideMenu.classList.add('hidden');
            }
        };

        function getAnimatedBackgroundHTML() {
            return `
                <div class="absolute inset-0">
                    <div class="absolute inset-0 fluid-animated opacity-70"><div class="animated-bg-image"></div></div>
                    <div class="absolute inset-0 bg-black/50 z-10"></div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-black/30 z-10"></div>
                    <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-green-500/10 rounded-full blur-3xl floating-glow"></div>
                    <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-green-400/10 rounded-full blur-3xl floating-glow" style="animation-delay: 4s;"></div>
                </div>
            `;
        }

        async function handleSearchSubmit(event) {
            event.preventDefault();
            const input = document.getElementById('search-input');
            const query = input.value.trim();
            if (query) {
                startNewChat(false);
                renderChatView(query);
            }
        }

        function renderChatView(initialQuery = null) {
            unmountReactApp();
            // Carica le conversazioni in background
            loadConversations().catch(error => {
                console.error('Errore nel caricamento delle conversazioni:', error);
            });

            mainContentWrapper.innerHTML = `
                <section id="chat-view-container" class="relative w-full h-screen flex flex-col overflow-hidden">
                    <div class="animated-bg-fixed">${getAnimatedBackgroundHTML()}</div>
                    <div id="chatbot-react-wrapper" class="relative z-20 flex-grow flex flex-col h-full">
                        <!-- React app will mount here -->
                    </div>
                </section>
            `;
            
            mainHeader.style.display = 'none';
            logosSection.style.display = 'none';
            mainFooter.style.display = 'none';

            const chatContainer = document.getElementById('chatbot-react-wrapper');

            if (window.mountChatbotApp) {
                const props = {
                    tools: window.getAllToolsForCurrentUser(),
                    initialConversations: conversations,
                    initialActiveId: activeConversationId,
                    initialQuery: initialQuery,
                    onConversationsChange: saveConversations,
                    onOpenDetail: window.openDetailModal,
                    lang: currentLang,
                    onBackToLanding: () => renderView(landingTemplate),
                    onToggleMenu: () => toggleSideMenu(true),
                    initialMode: 'assistant',
                };
                reactRoot = window.mountChatbotApp(chatContainer, props);
            } else {
                console.error("Chatbot mount function not found.");
            }
        }

        function renderView(template) {
            unmountReactApp();
            mainContentWrapper.innerHTML = '';
            const content = template.content.cloneNode(true);
            mainContentWrapper.appendChild(content);

            mainHeader.style.display = 'flex';
            logosSection.style.display = 'block';
            mainFooter.style.display = 'block';
            
            mainContentWrapper.style.display = 'block';

            lucide.createIcons();
            translatePage(currentLang);

            const tryNowButton = document.getElementById('try-now-btn');
            if(tryNowButton) {
                tryNowButton.addEventListener('click', () => {
                    renderView(searchTemplate);
                });
            }
            
            const exploreButton = document.getElementById('explore-sections-btn');
            if(exploreButton) {
                exploreButton.addEventListener('click', () => {
                    const sectionsContainer = document.getElementById('sections-container');
                    if (sectionsContainer.style.display === 'none' || sectionsContainer.style.display === '') {
                        sectionsContainer.style.display = 'block';
                        showSection('search-ai');
                    }
                    setTimeout(() => {
                        sectionsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                });
            }
            
            const closeButton = document.getElementById('close-sections-btn');
            if(closeButton) {
                closeButton.addEventListener('click', () => {
                    document.getElementById('sections-container').style.display = 'none';
                });
            }
            
            const backToLandingButton = document.getElementById('back-to-landing-sections-btn');
            if(backToLandingButton) {
                backToLandingButton.addEventListener('click', () => {
                    document.getElementById('sections-container').style.display = 'none';
                    renderView(landingTemplate);
                });
            }
        }

        document.body.addEventListener('click', (e) => {
            // Gestione menu a tendina filtri
            const filtersBtn = e.target.closest('#filters-dropdown-btn');
            if (filtersBtn) {
                e.preventDefault();
                e.stopPropagation();
                toggleFiltersDropdown();
                return;
            }
            
            const applyBtn = e.target.closest('#apply-filters-btn');
            if (applyBtn) {
                e.preventDefault();
                e.stopPropagation();
                applyFilters();
                return;
            }
            
            const resetBtn = e.target.closest('#reset-filters-btn');
            if (resetBtn) {
                e.preventDefault();
                e.stopPropagation();
                resetFilters();
                return;
            }
            
            // Chiudi il dropdown se si clicca fuori
            const dropdownContent = document.getElementById('filters-dropdown-content');
            if (dropdownContent && dropdownContent.classList.contains('show')) {
                if (!e.target.closest('.filters-dropdown')) {
                    toggleFiltersDropdown();
                }
            }
            
            const actionTarget = e.target.closest('[data-action]');
            if (!actionTarget) {
                if (e.target.id === 'side-menu-overlay') {
                    toggleSideMenu(false);
                }
                return;
            }

            const action = actionTarget.dataset.action;
            switch(action) {
                case 'new-chat':
                    startNewChat(true);
                    renderChatView();
                    break;
                case 'delete-all-chats':
                    openConfirmDeleteAllModal();
                    break;
                case 'confirm-delete-all-chats': // NUOVA AZIONE
                    const t_del = translations[currentLang];
                    deleteAllConversationsFromFirebase().then(() => {
                        conversations = {};
                        activeConversationId = null;
                        renderView(searchTemplate);
                        showToast(t_del.deleteAllSuccess + ' ✔');
                    });
                    closeModal(); // Chiude il modale di conferma
                    break;
                case 'select-conversation':
                    const newActiveId = actionTarget.dataset.id;
                    if (newActiveId !== activeConversationId) {
                        activeConversationId = newActiveId;
                        // Salva in background e renderizza immediatamente
                        debouncedSave(conversations, activeConversationId);
                        renderChatView();
                    }
                    toggleSideMenu(false);
                    break;
            }
        });
        // --- END: View Switching & Chat Logic ---


        // --- START: AI Logo Population Logic (Ottimizzato) ---
        function populateAILogos() {
            const aiLogosContainer = document.getElementById('ai-logos');
            if (aiLogosContainer) {
                const logosToDisplay = aiToolsData.slice(0, 15);
                const duplicatedLogos = [...logosToDisplay, ...logosToDisplay];
                const fragment = document.createDocumentFragment();
                duplicatedLogos.forEach((logo) => {
                    const logoDiv = document.createElement('div');
                    logoDiv.className = `flex-shrink-0 w-20 h-20 bg-white/80 rounded-2xl flex items-center justify-center p-2`;
                    logoDiv.innerHTML = `<img src="${logo.logoUrl}" alt="${logo.name}" title="${logo.name}" class="w-full h-full object-contain" loading="lazy" decoding="async" />`;
                    fragment.appendChild(logoDiv);
                });
                aiLogosContainer.appendChild(fragment);
                aiLogosContainer.style.animationDuration = `${logosToDisplay.length * 8}s`;
            }
        }
        
        populateAILogos();
        initializeEventListeners();
        
        // Inizializza anche gli event listener dei filtri dopo un breve delay
        setTimeout(() => {
            initializeFiltersEventListeners();
        }, 500);
        
        // Inizializza la sezione suggerimenti AI
        setTimeout(() => {
            initializeAISuggestions();
        }, 1000);
        
        // Inizializzazione ricerca utenti rimossa
        // --- END: AI Logo Population Logic ---


        // --- START: Initial Page Setup (Ottimizzato) ---
        renderView(landingTemplate);
        translatePage(currentLang);
        
        document.addEventListener('DOMContentLoaded', () => {
            const observerOptions = { threshold: 0.2, rootMargin: '0px 0px -100px 0px' };
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate-fade-in');
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);

            document.querySelectorAll('section:not(.relative), footer').forEach(el => observer.observe(el));
        });

        const style = document.createElement('style');
        style.textContent = `@keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } } .animate-fade-in { animation: fadeIn 0.8s ease-out forwards; }`;
        document.head.appendChild(style);

        console.log('🚀 Koda AI Website Loaded Successfully!');
        // --- END: Initial Page Setup ---
        
        // --- START: Library & Favorites Logic ---

        function subscribeToFavorites(user) {
            if (favoritesUnsubscribe) favoritesUnsubscribe(); // Annulla sottoscrizione precedente
            const { collection, query, where, onSnapshot } = window.firebaseServices;
            const q = query(collection(window.firebaseDb, "userFavorites"), where("userId", "==", user.uid));
            
            favoritesUnsubscribe = onSnapshot(q, (snapshot) => {
                userFavoriteToolIds.clear();
                snapshot.forEach((doc) => {
                    userFavoriteToolIds.add(doc.data().toolId);
                });
                console.log('Libreria aggiornata:', userFavoriteToolIds);
                renderLibrarySection();
                updateLikeButtonsUI();
                
                // Emetti evento per aggiornare i componenti React
                window.dispatchEvent(new CustomEvent('favoritesUpdated', {
                    detail: { favoriteIds: Array.from(userFavoriteToolIds) }
                }));
            });
        }

        function renderLibrarySection() {
            const libraryGrid = document.getElementById('library-grid');
            if (!libraryGrid) return;
            
            if (userFavoriteToolIds.size === 0) {
                libraryGrid.innerHTML = `<p class="text-gray-400 text-center col-span-full">La tua libreria è vuota. Clicca sul cuore ❤️ nelle card degli strumenti per aggiungerli qui.</p>`;
                return;
            }

            const favoriteTools = aiToolsData.filter(tool => userFavoriteToolIds.has(tool.id));
            libraryGrid.innerHTML = favoriteTools.map(tool => createToolCardHTML(tool)).join('');
            lucide.createIcons(); // Ricrea le icone Lucide dopo aver aggiunto nuovo HTML
            
            // Sincronizza con la chat se è attiva
            if (window.syncChatSections) {
                window.syncChatSections();
            }
        }

        async function toggleFavorite(toolId, buttonElement) {
            if (!currentUser) {
                showToast('Accedi per salvare i tuoi strumenti preferiti!');
                return;
            }

            const { doc, setDoc, deleteDoc, serverTimestamp } = window.firebaseServices;
            const docId = `${currentUser.uid}_${toolId}`;
            const favoriteRef = doc(window.firebaseDb, "userFavorites", docId);
            
            const isLiked = userFavoriteToolIds.has(toolId);

            try {
                if (isLiked) {
                    await deleteDoc(favoriteRef);
                    showToast('Rimosso dalla libreria');
                } else {
                    await setDoc(favoriteRef, {
                        userId: currentUser.uid,
                        toolId: toolId,
                        createdAt: serverTimestamp()
                    });
                    showToast('Aggiunto alla libreria!');
                }
                
                // Sincronizza con la chat se è attiva
                if (window.syncChatSections) {
                    window.syncChatSections();
                }
            } catch (error) {
                console.error("Errore nell'aggiornare i preferiti:", error);
                showToast('Si è verificato un errore.');
            }
        }
        
        function updateLikeButtonsUI() {
            document.querySelectorAll('.like-btn').forEach(btn => {
                const toolId = btn.dataset.toolId;
                const isLiked = userFavoriteToolIds.has(toolId);
                btn.setAttribute('data-liked', isLiked);
            });
        }

        // --- END: Library & Favorites Logic ---


        // --- FUNZIONI PER LE NUOVE SEZIONI ---
        function showSection(sectionName) {
            document.querySelectorAll('.search-ai-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.section-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
            }
            const targetBtn = document.querySelector(`[data-section="${sectionName}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // Inizializza la sezione di ricerca AI con tutti gli strumenti
            if (sectionName === 'search-ai') {
                currentCategoryFilter = 'all';
                currentCountryFilter = 'all';
                showAllTools();
                
                // Aspetta che il DOM sia pronto per gli elementi del dropdown
                setTimeout(() => {
                    // Reset del dropdown filtri
                    const dropdownBtn = document.getElementById('filters-dropdown-btn');
                    const dropdownContent = document.getElementById('filters-dropdown-content');
                    if (dropdownBtn) dropdownBtn.classList.remove('active');
                    if (dropdownContent) dropdownContent.classList.remove('show');
                    
                    // Reset dei radio button
                    const categoryAll = document.querySelector('input[name="category"][value="all"]');
                    const countryAll = document.querySelector('input[name="country"][value="all"]');
                    if (categoryAll) categoryAll.checked = true;
                    if (countryAll) countryAll.checked = true;
                    
                    // Reinizializza gli event listener per il dropdown
                    initializeFiltersEventListeners();
                }, 100);
            }
            
            // Inizializza la sezione suggerimenti AI
            if (sectionName === 'ai-suggestions') {
                setTimeout(() => {
                    initializeAISuggestions();
                }, 100);
            }
            
            // Logica per la sezione ricerca utenti rimossa
        }

        function createToolCardHTML(tool) {
            const isLiked = userFavoriteToolIds.has(tool.id);
            const localizedDescription = tool.description[currentLang] || tool.description['en'] || tool.description || 'Descrizione non disponibile';
            const safeCategory = tool.category || 'N/A';
            const safeCountry = tool.country || 'N/A';
            const safeLogoUrl = tool.logoUrl || 'https://via.placeholder.com/48x48?text=AI';
            
            return `
                <div class="search-result-card" onclick="openDetailModal('${tool.id}')">
                    <button class="like-btn" data-tool-id="${tool.id}" data-liked="${isLiked}" onclick="event.stopPropagation(); toggleFavorite('${tool.id}', this);">
                        <i data-lucide="heart" class="lucide-heart"></i>
                    </button>
                    <div class="flex items-center gap-4">
                        <img src="${safeLogoUrl}" alt="${tool.name}" class="w-12 h-12 rounded-lg object-cover" loading="lazy" onerror="this.src='https://via.placeholder.com/48x48?text=AI'">
                        <div>
                            <h3 class="text-lg font-semibold text-white">${tool.name}</h3>
                            <p class="text-gray-300 text-sm">${localizedDescription}</p>
                            <div class="flex gap-2 mt-2">
                                <span class="inline-block bg-green-500/20 text-green-400 text-xs px-2 py-1 rounded">${safeCategory}</span>
                                <span class="inline-block bg-blue-500/20 text-blue-400 text-xs px-2 py-1 rounded">${safeCountry}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        let searchTimeout;
        let currentCategoryFilter = 'all'; // Variabile per tenere traccia del filtro categoria corrente
        let currentCountryFilter = 'all'; // Variabile per tenere traccia del filtro paese corrente
        
        function handleAISearch(event) {
            event.preventDefault();
            const searchInput = document.getElementById('ai-search-input');
            const query = searchInput.value.trim().toLowerCase();
            const resultsContainer = document.getElementById('ai-search-results');
            
            clearTimeout(searchTimeout);
            
            searchTimeout = setTimeout(() => {
                const allTools = window.getAllToolsForCurrentUser();
                let filteredTools = allTools;
                
                // Applica filtro categoria
                if (currentCategoryFilter !== 'all') {
                    filteredTools = filteredTools.filter(tool => tool.category === currentCategoryFilter);
                }
                
                // Applica filtro paese
                if (currentCountryFilter !== 'all') {
                    filteredTools = filteredTools.filter(tool => tool.country === currentCountryFilter);
                }
                
                // Applica filtro ricerca testuale
                if (query) {
                    filteredTools = filteredTools.filter(tool => 
                        tool.name.toLowerCase().includes(query) ||
                        tool.description.toLowerCase().includes(query) ||
                        tool.category.toLowerCase().includes(query)
                    );
                }
                
                if (filteredTools.length === 0) {
                    const noResultsMessage = query 
                        ? '<p class="text-gray-400 text-center col-span-full">Nessun risultato trovato per la tua ricerca</p>'
                        : '<p class="text-gray-400 text-center col-span-full">Nessuno strumento disponibile per questa categoria</p>';
                    resultsContainer.innerHTML = noResultsMessage;
                    return;
                }
                
                resultsContainer.innerHTML = filteredTools.slice(0, 9).map(tool => createToolCardHTML(tool)).join('');
                lucide.createIcons(); // Ricrea le icone per i nuovi elementi
            }, 300);
        }
        
        function handleCategoryFilter(category) {
            currentCategoryFilter = category;
            
            // Aggiorna lo stato attivo dei pulsanti
            document.querySelectorAll('.category-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');
            
            // Pulisci il campo di ricerca
            const searchInput = document.getElementById('ai-search-input');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Mostra tutti gli strumenti della categoria selezionata
            const resultsContainer = document.getElementById('ai-search-results');
            const allTools = window.getAllToolsForCurrentUser();
            let filteredTools = allTools;
            
            // Applica filtro categoria
            if (category !== 'all') {
                filteredTools = filteredTools.filter(tool => tool.category === category);
            }
            
            // Applica filtro paese se attivo
            if (currentCountryFilter !== 'all') {
                filteredTools = filteredTools.filter(tool => tool.country === currentCountryFilter);
            }
            
            if (filteredTools.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-400 text-center col-span-full">Nessuno strumento disponibile per questa categoria</p>';
                return;
            }
            
            resultsContainer.innerHTML = filteredTools.slice(0, 9).map(tool => createToolCardHTML(tool)).join('');
            lucide.createIcons();
        }
        
        function handleCountryFilter(country) {
            currentCountryFilter = country;
            
            // Aggiorna lo stato attivo dei pulsanti
            document.querySelectorAll('.country-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-country="${country}"]`).classList.add('active');
            
            // Pulisci il campo di ricerca
            const searchInput = document.getElementById('ai-search-input');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Mostra tutti gli strumenti del paese selezionato
            const resultsContainer = document.getElementById('ai-search-results');
            const allTools = window.getAllToolsForCurrentUser();
            let filteredTools = allTools;
            
            // Applica filtro paese
            if (country !== 'all') {
                filteredTools = filteredTools.filter(tool => tool.country === country);
            }
            
            // Applica filtro categoria se attivo
            if (currentCategoryFilter !== 'all') {
                filteredTools = filteredTools.filter(tool => tool.category === currentCategoryFilter);
            }
            
            if (filteredTools.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-400 text-center col-span-full">Nessuno strumento disponibile per questo paese</p>';
                return;
            }
            
            resultsContainer.innerHTML = filteredTools.slice(0, 9).map(tool => createToolCardHTML(tool)).join('');
            lucide.createIcons();
        }
        
        // Funzioni per il menu a tendina dei filtri
        function toggleFiltersDropdown() {
            const dropdownBtn = document.getElementById('filters-dropdown-btn');
            const dropdownContent = document.getElementById('filters-dropdown-content');
            
            if (!dropdownBtn || !dropdownContent) {
                console.error('Elementi del dropdown filtri non trovati');
                return;
            }
            
            console.log('Toggle dropdown filtri'); // Debug
            dropdownBtn.classList.toggle('active');
            dropdownContent.classList.toggle('show');
        }
        
        function applyFilters() {
            const selectedCategory = document.querySelector('input[name="category"]:checked').value;
            const selectedCountry = document.querySelector('input[name="country"]:checked').value;
            
            currentCategoryFilter = selectedCategory;
            currentCountryFilter = selectedCountry;
            
            // Pulisci il campo di ricerca
            const searchInput = document.getElementById('ai-search-input');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Applica i filtri
            const resultsContainer = document.getElementById('ai-search-results');
            const allTools = window.getAllToolsForCurrentUser();
            let filteredTools = allTools;
            
            // Applica filtro categoria
            if (selectedCategory !== 'all') {
                filteredTools = filteredTools.filter(tool => tool.category === selectedCategory);
            }
            
            // Applica filtro paese
            if (selectedCountry !== 'all') {
                filteredTools = filteredTools.filter(tool => tool.country === selectedCountry);
            }
            
            if (filteredTools.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-400 text-center col-span-full">Nessuno strumento disponibile con i filtri selezionati</p>';
            } else {
                resultsContainer.innerHTML = filteredTools.slice(0, 9).map(tool => createToolCardHTML(tool)).join('');
                lucide.createIcons();
            }
            
            // Chiudi il dropdown
            toggleFiltersDropdown();
        }
        
        function resetFilters() {
            // Reset dei radio button
            document.querySelector('input[name="category"][value="all"]').checked = true;
            document.querySelector('input[name="country"][value="all"]').checked = true;
            
            // Reset delle variabili
            currentCategoryFilter = 'all';
            currentCountryFilter = 'all';
            
            // Pulisci il campo di ricerca
            const searchInput = document.getElementById('ai-search-input');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // Mostra tutti gli strumenti
            showAllTools();
            
            // Chiudi il dropdown
            toggleFiltersDropdown();
        }
        
        function showAllTools() {
            const resultsContainer = document.getElementById('ai-search-results');
            const allTools = window.getAllToolsForCurrentUser();
            
            if (allTools.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-400 text-center col-span-full">Nessuno strumento disponibile</p>';
                return;
            }
            
            resultsContainer.innerHTML = allTools.slice(0, 9).map(tool => createToolCardHTML(tool)).join('');
            lucide.createIcons();
        }
        
        function handleChatMenuClick(action, mode) {
            const menuButtons = document.querySelectorAll('.chat-menu-btn[data-action="chat-mode"]');
            menuButtons.forEach(btn => btn.classList.remove('active'));
            const clickedBtn = document.querySelector(`[data-action="${action}"][data-mode="${mode}"]`);
            if (clickedBtn) clickedBtn.classList.add('active');
            
            switch(mode) {
                case 'assistant': break;
                case 'search':
                    document.getElementById('sections-container').style.display = 'block';
                    showSection('search-ai');
                    break;
            }
        }
        
        function initializeFiltersEventListeners() {
            // Event listener specifico per il pulsante filtri
            const filtersBtn = document.getElementById('filters-dropdown-btn');
            if (filtersBtn) {
                // Rimuovi event listener esistenti per evitare duplicati
                filtersBtn.removeEventListener('click', handleFiltersClick);
                filtersBtn.addEventListener('click', handleFiltersClick);
            }
            
            // Event listener per i pulsanti di azione
            const applyBtn = document.getElementById('apply-filters-btn');
            if (applyBtn) {
                applyBtn.removeEventListener('click', handleApplyClick);
                applyBtn.addEventListener('click', handleApplyClick);
            }
            
            const resetBtn = document.getElementById('reset-filters-btn');
            if (resetBtn) {
                resetBtn.removeEventListener('click', handleResetClick);
                resetBtn.addEventListener('click', handleResetClick);
            }
        }
        
        function handleFiltersClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Click su pulsante filtri'); // Debug
            toggleFiltersDropdown();
        }
        
        function handleApplyClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Click su applica filtri'); // Debug
            applyFilters();
        }
        
        function handleResetClick(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Click su reset filtri'); // Debug
            resetFilters();
        }
        
        function initializeEventListeners() {
            document.querySelectorAll('.section-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = btn.dataset.section;
                    showSection(section);
                });
            });
            
            // Inizializza gli event listener dei filtri
            initializeFiltersEventListeners();
            
            // Event listener per il menu a tendina dei filtri
            document.body.addEventListener('click', (e) => {
                const filtersBtn = e.target.closest('#filters-dropdown-btn');
                if (filtersBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleFiltersDropdown();
                    return;
                }
                
                const applyBtn = e.target.closest('#apply-filters-btn');
                if (applyBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    applyFilters();
                    return;
                }
                
                const resetBtn = e.target.closest('#reset-filters-btn');
                if (resetBtn) {
                    e.preventDefault();
                    e.stopPropagation();
                    resetFilters();
                    return;
                }
                
                // Chiudi il dropdown se si clicca fuori
                const dropdownContent = document.getElementById('filters-dropdown-content');
                if (dropdownContent && dropdownContent.classList.contains('show')) {
                    if (!e.target.closest('.filters-dropdown')) {
                        toggleFiltersDropdown();
                    }
                }
                
                const menuBtn = e.target.closest('.chat-menu-btn');
                if (menuBtn) {
                    const action = menuBtn.dataset.action;
                    const mode = menuBtn.dataset.mode;
                    if (action === 'chat-mode' && mode) {
                        const chatContainer = document.getElementById('chatbot-react-wrapper');
                        if (chatContainer && window.mountChatbotApp) {
                            document.querySelectorAll('.chat-menu-btn[data-action="chat-mode"]').forEach(btn => btn.classList.remove('active'));
                            menuBtn.classList.add('active');
                            if (window.updateChatMode) window.updateChatMode(mode);
                        }
                    }
                }
            });
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i'); // Seleziona l'icona nel bottone
            if (input.type === 'password') {
                input.type = 'text';
                icon.setAttribute('data-lucide', 'eye-off');
            } else {
                input.type = 'password';
                icon.setAttribute('data-lucide', 'eye');
            }
            lucide.createIcons(); // Aggiorna l'icona
        }

        // --- Toast Notification ---
        function showToast(message) {
            let toast = document.getElementById('koda-toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'koda-toast';
                toast.style.position = 'fixed';
                toast.style.bottom = '32px';
                toast.style.left = '50%';
                toast.style.transform = 'translateX(-50%)';
                toast.style.background = 'rgba(34,197,94,0.95)';
                toast.style.color = '#000';
                toast.style.padding = '14px 32px';
                toast.style.borderRadius = '32px';
                toast.style.fontWeight = 'bold';
                toast.style.fontSize = '1rem';
                toast.style.boxShadow = '0 2px 8px rgba(34,197,94,0.15)';
                toast.style.zIndex = '9999';
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                document.body.appendChild(toast);
            }
            toast.textContent = message;
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 2500);
        }
        // --- Toast Notification ---

        // --- AI Suggestions Management (Firebase) ---

        // --- Logica per la Ricerca Utenti rimossa ---

        // --- User Search Management ---
        let suggestionsUnsubscribe = null;

        function initializeAISuggestions() {
            const form = document.getElementById('ai-suggestion-form');
            if (form) {
                form.addEventListener('submit', handleAISuggestionSubmit);
            }
            
            // Sottoscrivi ai suggerimenti se l'utente è autenticato
            if (currentUser) {
                subscribeToSuggestions();
            } else {
                // Se non autenticato, mostra solo i suggerimenti pubblici
                loadPublicSuggestions();
            }
        }

        function handleAISuggestionSubmit(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showToast('Accedi per inviare suggerimenti!');
                return;
            }
            
            const formData = new FormData(e.target);
            const suggestion = {
                name: formData.get('ai-name'),
                category: formData.get('ai-category'),
                description: formData.get('ai-description'),
                website: formData.get('ai-website') || '',
                country: formData.get('ai-country') || '',
                features: formData.get('ai-features') || '',
                email: formData.get('ai-email') || '',
                userId: currentUser.uid,
                userEmail: currentUser.email,
                userName: currentUser.displayName || currentUser.email.split('@')[0],
                timestamp: new Date().toISOString(),
                status: 'pending' // pending, approved, rejected
            };

            // Salva il suggerimento in Firebase
            saveAISuggestionToFirebase(suggestion);
            
            // Resetta il form
            e.target.reset();
            
            // Mostra messaggio di successo
            showToast('Suggerimento inviato con successo! Grazie per il contributo.');
        }

        async function saveAISuggestionToFirebase(suggestion) {
            try {
                const { collection, addDoc, serverTimestamp } = window.firebaseServices;
                await addDoc(collection(window.firebaseDb, "aiSuggestions"), {
                    ...suggestion,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                
                // Sincronizza con la chat se è attiva
                if (window.syncChatSections) {
                    window.syncChatSections();
                }
            } catch (error) {
                console.error("Errore nel salvare il suggerimento:", error);
                showToast('Errore nell\'invio del suggerimento. Riprova.');
            }
        }

        function subscribeToSuggestions() {
            if (suggestionsUnsubscribe) {
                suggestionsUnsubscribe();
            }

            // Mostra tutti i suggerimenti (non solo quelli approvati)
            const { collection, query, orderBy, onSnapshot } = window.firebaseServices;
            const q = query(
                collection(window.firebaseDb, "aiSuggestions"),
                orderBy("createdAt", "desc")
            );
            
            suggestionsUnsubscribe = onSnapshot(q, (snapshot) => {
                const suggestions = [];
                snapshot.forEach((doc) => {
                    suggestions.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderSuggestions(suggestions);
            }, (error) => {
                console.error("Errore nel caricare i suggerimenti:", error);
                showToast('Errore nel caricare i suggerimenti.');
            });
        }

        function loadPublicSuggestions() {
            // Per utenti non autenticati, mostra tutti i suggerimenti
            const { collection, query, orderBy, getDocs } = window.firebaseServices;
            const q = query(
                collection(window.firebaseDb, "aiSuggestions"),
                orderBy("createdAt", "desc")
            );
            
            getDocs(q).then((snapshot) => {
                const suggestions = [];
                snapshot.forEach((doc) => {
                    suggestions.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderSuggestions(suggestions);
            }).catch((error) => {
                console.error("Errore nel caricare i suggerimenti pubblici:", error);
                showToast('Errore nel caricare i suggerimenti.');
            });
        }

        function renderSuggestions(suggestions) {
            const suggestionsList = document.getElementById('suggestions-list');
            const noSuggestions = document.getElementById('no-suggestions');
            
            if (!suggestionsList || !noSuggestions) return;
            
            if (suggestions.length === 0) {
                suggestionsList.style.display = 'none';
                noSuggestions.style.display = 'block';
                return;
            }
            
            suggestionsList.style.display = 'block';
            noSuggestions.style.display = 'none';
            
            suggestionsList.innerHTML = suggestions.map(suggestion => createSuggestionCard(suggestion)).join('');
            
            // Sincronizza con la chat se è attiva
            if (window.syncChatSections) {
                window.syncChatSections();
            }
        }

        function createSuggestionCard(suggestion) {
            const date = suggestion.createdAt ? 
                new Date(suggestion.createdAt.toDate()).toLocaleDateString('it-IT', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 
                new Date(suggestion.timestamp).toLocaleDateString('it-IT', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            
            const statusBadge = getStatusBadge(suggestion.status);
            const isAdmin = currentUser && (currentUser.email === 'admin@koda.ai' || currentUser.uid === 'admin'); // Esempio di controllo admin
            const isOwner = currentUser && suggestion.userId === currentUser.uid; // Controllo se l'utente è il proprietario del suggerimento
            
            return `
                <div class="bg-gray-700/30 border border-gray-600 rounded-lg p-6 hover:border-green-500 transition-all">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="text-lg font-semibold text-white mb-2">${escapeHtml(suggestion.name)}</h4>
                            <div class="flex gap-2 mb-2">
                                <span class="inline-block bg-green-500/20 text-green-400 text-xs px-2 py-1 rounded">${escapeHtml(suggestion.category)}</span>
                                ${suggestion.country ? `<span class="inline-block bg-blue-500/20 text-blue-400 text-xs px-2 py-1 rounded">${escapeHtml(suggestion.country)}</span>` : ''}
                                ${statusBadge}
                            </div>
                        </div>
                        <span class="text-xs text-gray-400">${date}</span>
                    </div>
                    
                    <p class="text-gray-300 mb-4">${escapeHtml(suggestion.description)}</p>
                    
                    ${suggestion.website ? `<p class="text-sm text-gray-400 mb-2"><strong>Sito:</strong> <a href="${escapeHtml(suggestion.website)}" target="_blank" class="text-green-400 hover:underline">${escapeHtml(suggestion.website)}</a></p>` : ''}
                    ${suggestion.features ? `<p class="text-sm text-gray-400 mb-2"><strong>Caratteristiche:</strong> ${escapeHtml(suggestion.features)}</p>` : ''}
                    ${suggestion.email ? `<p class="text-sm text-gray-400 mb-2"><strong>Email suggeritore:</strong> ${escapeHtml(suggestion.email)}</p>` : ''}
                    ${suggestion.userName ? `<p class="text-sm text-gray-400"><strong>Suggerito da:</strong> ${escapeHtml(suggestion.userName)}</p>` : ''}
                    
                    <div class="flex gap-2 mt-4">
                        ${isAdmin ? `
                            <button onclick="approveSuggestion('${suggestion.id}')" class="bg-green-500 hover:bg-green-600 text-black text-xs px-3 py-1 rounded transition-colors">
                                Approva
                            </button>
                            <button onclick="rejectSuggestion('${suggestion.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-3 py-1 rounded transition-colors">
                                Rifiuta
                            </button>
                        ` : ''}
                        ${(isAdmin || isOwner) ? `
                            <button onclick="deleteSuggestion('${suggestion.id}')" class="bg-gray-600 hover:bg-gray-500 text-white text-xs px-3 py-1 rounded transition-colors">
                                ${isOwner ? 'Cancella' : 'Elimina'}
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Funzione createUserSuggestionCard rimossa

        function getStatusBadge(status) {
            const statusMap = {
                'pending': '<span class="inline-block bg-yellow-500/20 text-yellow-400 text-xs px-2 py-1 rounded">In attesa</span>',
                'approved': '<span class="inline-block bg-green-500/20 text-green-400 text-xs px-2 py-1 rounded">Approvato</span>',
                'rejected': '<span class="inline-block bg-red-500/20 text-red-400 text-xs px-2 py-1 rounded">Rifiutato</span>'
            };
            return statusMap[status] || statusMap['pending'];
        }

        async function approveSuggestion(id) {
            try {
                const { doc, updateDoc, serverTimestamp } = window.firebaseServices;
                const suggestionRef = doc(window.firebaseDb, "aiSuggestions", id);
                await updateDoc(suggestionRef, {
                    status: 'approved',
                    updatedAt: serverTimestamp()
                });
                showToast('Suggerimento approvato!');
            } catch (error) {
                console.error("Errore nell'approvare il suggerimento:", error);
                showToast('Errore nell\'approvazione del suggerimento.');
            }
        }

        async function rejectSuggestion(id) {
            try {
                const { doc, updateDoc, serverTimestamp } = window.firebaseServices;
                const suggestionRef = doc(window.firebaseDb, "aiSuggestions", id);
                await updateDoc(suggestionRef, {
                    status: 'rejected',
                    updatedAt: serverTimestamp()
                });
                showToast('Suggerimento rifiutato.');
            } catch (error) {
                console.error("Errore nel rifiutare il suggerimento:", error);
                showToast('Errore nel rifiuto del suggerimento.');
            }
        }

        async function deleteSuggestion(id) {
            if (!currentUser) {
                showToast('Devi essere autenticato per cancellare un suggerimento.');
                return;
            }

            // Trova il suggerimento per verificare i permessi
            const { doc, getDoc } = window.firebaseServices;
            const suggestionRef = doc(window.firebaseDb, "aiSuggestions", id);
            
            try {
                const suggestionDoc = await getDoc(suggestionRef);
                if (!suggestionDoc.exists()) {
                    showToast('Suggerimento non trovato.');
                    return;
                }

                const suggestion = suggestionDoc.data();
                const isAdmin = currentUser.email === 'admin@koda.ai' || currentUser.uid === 'admin';
                const isOwner = suggestion.userId === currentUser.uid;

                if (!isAdmin && !isOwner) {
                    showToast('Non hai i permessi per cancellare questo suggerimento.');
                    return;
                }

                const confirmMessage = isOwner ? 
                    'Sei sicuro di voler cancellare il tuo suggerimento?' : 
                    'Sei sicuro di voler eliminare questo suggerimento?';

                if (confirm(confirmMessage)) {
                    const { deleteDoc } = window.firebaseServices;
                    await deleteDoc(suggestionRef);
                    showToast(isOwner ? 'Suggerimento cancellato.' : 'Suggerimento eliminato.');
                }
            } catch (error) {
                console.error("Errore nell'eliminare il suggerimento:", error);
                showToast('Errore nell\'eliminazione del suggerimento.');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- AI Suggestions Management (Firebase) ---
    </script>
</body>
</html>
